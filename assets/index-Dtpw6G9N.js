import{initializeApp as Jt}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import{getAuth as Xt,GoogleAuthProvider as Zt,onAuthStateChanged as es,signInWithPopup as ts,signInWithEmailAndPassword as ss,createUserWithEmailAndPassword as ns,signOut as as}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";import{getDatabase as is,ref as De,get as ft,update as Ye,child as fe,onChildAdded as Je,off as de,onChildChanged as gt,onChildRemoved as pt,set as Fe,remove as Xe}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=t(a);fetch(a.href,i)}})();const J={OFF:0,ALL:1,ONE:2},rs=["HI_RES_LOSSLESS","LOSSLESS","HIGH","LOW"],os={HI_RES_LOSSLESS:["HI_RES_LOSSLESS","HIRES_LOSSLESS","HIRESLOSSLESS","HIFI_PLUS","HI_RES_FLAC","HI_RES","HIRES","MASTER","MASTER_QUALITY","MQA"],LOSSLESS:["LOSSLESS","HIFI"],HIGH:["HIGH","HIGH_QUALITY"],LOW:["LOW","LOW_QUALITY"]},Mt="Too Many Requests. Please wait a moment and try again.",he='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><polygon points="7 3 21 12 7 21 7 3"></polygon></svg>',ls='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>',cs='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>',ds='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>',pe='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',us='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>',ie='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="heart-icon"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>',_e='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',ms='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>',xe=n=>{if(isNaN(n))return"0:00";const e=Math.floor(n/60),t=Math.floor(n%60);return`${e}:${String(t).padStart(2,"0")}`},N=(n,e=!1)=>`<div class="placeholder-text ${e?"loading":""}">${n}</div>`,H=new WeakMap,ye=n=>n?n.replace(/[\\/:*?"<>|]/g,"_").replace(/\s+/g," ").trim():"Unknown",Bt=n=>{switch(n){case"LOW":case"HIGH":return"m4a";default:return"flac"}},Qe=(n,e)=>{const t=localStorage.getItem("filename-template")||"{trackNumber} - {artist} - {title}",s=Bt(e),a=n.artist?.name||n.artists?.[0]?.name||"Unknown Artist",i={trackNumber:n.trackNumber,artist:a,title:ne(n),album:n.album?.title};return ze(t,i)+"."+s},hs=n=>n?n.trim().toUpperCase().replace(/[^A-Z0-9]+/g,"_"):"",$t=n=>{if(!n)return null;const e=hs(n);for(const[t,s]of Object.entries(os))if(s.includes(e))return t;return null},yt=n=>{if(!Array.isArray(n))return null;const e=[];for(const t of n){if(typeof t!="string")continue;const s=$t(t);s&&!e.includes(s)&&e.push(s)}return Pt(e)},Pt=n=>{let e=null,t=1/0;for(const s of n){if(!s)continue;const a=rs.indexOf(s),i=a===-1?1/0:a;i<t&&(e=s,t=i)}return e},fs=n=>{if(!n)return null;const e=[yt(n.mediaMetadata?.tags),yt(n.album?.mediaMetadata?.tags),$t(n.audioQuality)];return Pt(e)},He=n=>new Promise(e=>setTimeout(e,n)),Ze=n=>n?.explicit===!0||n?.explicitLyrics===!0,gs=(n,e)=>{let t;return function(...a){const i=()=>{clearTimeout(t),n(...a)};clearTimeout(t),t=setTimeout(i,e)}},Y=n=>typeof n!="string"?n:n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),ne=(n,{fallback:e="Unknown Title"}={})=>n?.title?n?.version?`${n.title} (${n.version})`:n.title:e,ee=(n={},{fallback:e="Unknown Artist"}={})=>n?.artists?.length?n.artists.map(t=>t?.name).join(", "):e,bt=(n={},{fallback:e="Unknown Artist"}={})=>n?.artists?.length?n.artists.map(t=>`<span class="artist-link" data-artist-id="${t.id}">${t.name}</span>`).join(", "):e,ze=(n,e)=>{let t=n;return t=t.replace(/\{trackNumber\}/g,e.trackNumber?String(e.trackNumber).padStart(2,"0"):"00"),t=t.replace(/\{artist\}/g,ye(e.artist||"Unknown Artist")),t=t.replace(/\{title\}/g,ye(e.title||"Unknown Title")),t=t.replace(/\{album\}/g,ye(e.album||"Unknown Album")),t=t.replace(/\{albumArtist\}/g,ye(e.albumArtist||"Unknown Artist")),t=t.replace(/\{albumTitle\}/g,ye(e.albumTitle||"Unknown Album")),t=t.replace(/\{year\}/g,e.year||"Unknown"),t},Ee=n=>!Array.isArray(n)||n.length===0?0:n.reduce((e,t)=>e+(t.duration||0),0),Se=n=>{if(!n||isNaN(n))return"0 min";const e=Math.floor(n/3600),t=Math.floor(n%3600/60);return e>0?`${e} hr ${t} min`:`${t} min`},Le=new Map;async function Re(n,e){if(!e)return null;if(Le.has(e))return Le.get(e);const t=async s=>{try{const a=`https://corsproxy.io/?${encodeURIComponent(s)}`,i=await fetch(a);if(i.ok)return await i.blob()}catch(a){console.warn("Proxy fetch failed:",a)}return null};try{const s=n.getCoverUrl(e,"1280"),a=await fetch(s);if(a.ok){const i=await a.blob();return Le.set(e,i),i}else{const i=await t(s);if(i)return Le.set(e,i),i}}catch{const a=n.getCoverUrl(e,"1280"),i=await t(a);if(i)return Le.set(e,i),i}return null}class ps{constructor(e={}){this.memoryCache=new Map,this.maxSize=e.maxSize||200,this.ttl=e.ttl||1e3*60*30,this.dbName="monochrome-cache",this.dbVersion=1,this.db=null,this.initDB()}async initDB(){if(!(typeof indexedDB>"u"))return new Promise((e,t)=>{const s=indexedDB.open(this.dbName,this.dbVersion);s.onerror=()=>t(s.error),s.onsuccess=()=>{this.db=s.result,e(this.db)},s.onupgradeneeded=a=>{const i=a.target.result;i.objectStoreNames.contains("responses")||i.createObjectStore("responses",{keyPath:"key"}).createIndex("timestamp","timestamp",{unique:!1})}})}generateKey(e,t){const s=typeof t=="object"?JSON.stringify(t):String(t);return`${e}:${s}`}async get(e,t){const s=this.generateKey(e,t);if(this.memoryCache.has(s)){const a=this.memoryCache.get(s);if(Date.now()-a.timestamp<this.ttl)return a.data;this.memoryCache.delete(s)}if(this.db)try{const a=await this.getFromIndexedDB(s);if(a&&Date.now()-a.timestamp<this.ttl)return this.memoryCache.set(s,a),a.data}catch(a){console.debug("IndexedDB read error:",a)}return null}async set(e,t,s){const a=this.generateKey(e,t),i={key:a,data:s,timestamp:Date.now()};if(this.memoryCache.set(a,i),this.memoryCache.size>this.maxSize){const r=this.memoryCache.keys().next().value;this.memoryCache.delete(r)}if(this.db)try{await this.setInIndexedDB(i)}catch(r){console.debug("IndexedDB write error:",r)}}getFromIndexedDB(e){return new Promise((t,s)=>{if(!this.db){t(null);return}const r=this.db.transaction(["responses"],"readonly").objectStore("responses").get(e);r.onsuccess=()=>t(r.result||null),r.onerror=()=>s(r.error)})}setInIndexedDB(e){return new Promise((t,s)=>{if(!this.db){t();return}const r=this.db.transaction(["responses"],"readwrite").objectStore("responses").put(e);r.onsuccess=()=>t(),r.onerror=()=>s(r.error)})}async clear(){if(this.memoryCache.clear(),this.db)return new Promise((e,t)=>{const i=this.db.transaction(["responses"],"readwrite").objectStore("responses").clear();i.onsuccess=()=>e(),i.onerror=()=>t(i.error)})}async clearExpired(){const e=Date.now(),t=[];for(const[s,a]of this.memoryCache.entries())e-a.timestamp>=this.ttl&&t.push(s);if(t.forEach(s=>this.memoryCache.delete(s)),this.db)try{const i=this.db.transaction(["responses"],"readwrite").objectStore("responses").index("timestamp"),r=IDBKeyRange.upperBound(e-this.ttl),d=i.openCursor(r);d.onsuccess=l=>{const o=l.target.result;o&&(o.delete(),o.continue())}}catch(s){console.debug("Failed to clear expired IndexedDB entries:",s)}}getCacheStats(){return{memoryEntries:this.memoryCache.size,maxSize:this.maxSize,ttl:this.ttl}}}const ys="Monochrome",bs="Unknown Title",wt="Unknown Artist",ws="Unknown Album";async function _t(n,e,t,s){const a=Bt(s);return a==="flac"?await Ss(n,e,t):a==="m4a"?await xs(n,e,t):n}async function vs(n){const e={title:n.name.replace(/\.[^/.]+$/,""),artists:[],artist:{name:"Unknown Artist"},album:{title:"Unknown Album",cover:"assets/appicon.png",releaseDate:null},duration:0,isLocal:!0,file:n,id:`local-${n.name}-${n.lastModified}`};try{n.type==="audio/flac"||n.name.endsWith(".flac")?await ks(n,e):n.type==="audio/mp4"||n.name.endsWith(".m4a")?await Ts(n,e):(n.type==="audio/mpeg"||n.name.endsWith(".mp3"))&&await Es(n,e)}catch(t){console.warn("Error reading metadata for",n.name,t)}return e.artists.length>0&&(e.artist=e.artists[0]),e}async function ks(n,e){const t=await n.arrayBuffer(),s=new DataView(t);if(!Rt(s))return;const i=Dt(s).find(d=>d.type===4),r=[];if(i){const d=i.offset,l=s.getUint32(d,!0);let o=d+4+l;const c=s.getUint32(o,!0);o+=4;for(let m=0;m<c;m++){const u=s.getUint32(o,!0);o+=4;const h=new TextDecoder().decode(new Uint8Array(t,o,u));o+=u;const f=h.indexOf("=");if(f>-1){const g=h.substring(0,f),p=h.substring(f+1),w=g.toUpperCase();w==="TITLE"&&(e.title=p),(w==="ARTIST"||w==="ALBUMARTIST")&&r.push(p),w==="ALBUM"&&(e.album.title=p)}}}r.length>0&&(e.artists=r.flatMap(d=>d.split(/; |\/|\\/)).map(d=>({name:d.trim()})))}async function Ts(n,e){try{const t=Math.min(n.size,5242880),s=await n.slice(0,t).arrayBuffer(),a=new DataView(s),r=re(a).find(C=>C.type==="moov");if(!r)return;const d=r.offset+8,l=r.size-8,o=new DataView(a.buffer,d,l),m=re(o).find(C=>C.type==="udta");if(!m)return;const u=d+m.offset+8,h=m.size-8,f=new DataView(a.buffer,u,h),p=re(f).find(C=>C.type==="meta");if(!p)return;const w=u+p.offset+12,I=p.size-12,y=new DataView(a.buffer,w,I),k=re(y).find(C=>C.type==="ilst");if(!k)return;const T=w+k.offset+8,v=k.size-8,S=new DataView(a.buffer,T,v),L=re(S);let A=null;for(const C of L){const x=T+C.offset+8,B=C.size-8,P=new DataView(a.buffer,x,B),$=re(P).find(R=>R.type==="data");if($){const R=$.size-16,O=x+$.offset+16;C.type==="©nam"?e.title=new TextDecoder().decode(new Uint8Array(a.buffer,O,R)):C.type==="©ART"?A=new TextDecoder().decode(new Uint8Array(a.buffer,O,R)):C.type==="©alb"&&(e.album.title=new TextDecoder().decode(new Uint8Array(a.buffer,O,R)))}}A&&(e.artists=A.split(/; |\/|\\/).map(C=>({name:C.trim()})))}catch(t){console.warn("Error parsing M4A:",t)}}async function Es(n,e){let t=await n.slice(0,10).arrayBuffer(),s=new DataView(t);if(s.getUint8(0)===73&&s.getUint8(1)===68&&s.getUint8(2)===51){const a=s.getUint8(3),r=et(s,6)+10;t=await n.slice(0,r).arrayBuffer(),s=new DataView(t);let d=10;if((s.getUint8(5)&64)!==0){const m=et(s,d);d+=m}let l=null,o=null;for(;d<s.byteLength;){let m,u;if(a===3)m=new TextDecoder().decode(new Uint8Array(t,d,4)),u=s.getUint32(d+4,!1),d+=10;else if(a===4)m=new TextDecoder().decode(new Uint8Array(t,d,4)),u=et(s,d+4),d+=10;else break;if(m.charCodeAt(0)===0||d+u>s.byteLength)break;const h=new DataView(t,d,u);if(m==="TIT2"&&(e.title=Ie(h)),m==="TPE1"&&(l=Ie(h)),m==="TPE2"&&(o=Ie(h)),m==="TALB"&&(e.album.title=Ie(h)),m==="TYER"||m==="TDRC"){const f=Ie(h);f&&(e.album.releaseDate=f)}d+=u}const c=l||o;c&&(e.artists=c.split("/").map(m=>({name:m.trim()})))}if(n.size>128){const a=await n.slice(n.size-128).arrayBuffer();if(new TextDecoder().decode(new Uint8Array(a,0,3))==="TAG"){const r=new TextDecoder().decode(new Uint8Array(a,3,30)).replace(/\0/g,"").trim(),d=new TextDecoder().decode(new Uint8Array(a,33,30)).replace(/\0/g,"").trim(),l=new TextDecoder().decode(new Uint8Array(a,63,30)).replace(/\0/g,"").trim();r&&(e.title=r),d&&e.artists.length===0&&(e.artists=[{name:d}]),l&&(e.album.title=l)}}}function et(n,e){return(n.getUint8(e)&127)<<21|(n.getUint8(e+1)&127)<<14|(n.getUint8(e+2)&127)<<7|n.getUint8(e+3)&127}function Ie(n){const e=n.getUint8(0),t=n.buffer.slice(n.byteOffset+1,n.byteOffset+n.byteLength);let s;return e===0?s=new TextDecoder("iso-8859-1"):e===1?s=new TextDecoder("utf-16"):e===2?s=new TextDecoder("utf-16be"):s=new TextDecoder("utf-8"),s.decode(t).replace(/\0/g,"")}async function Ss(n,e,t){try{const s=await n.arrayBuffer(),a=new DataView(s);if(!Rt(a))return console.warn("Not a valid FLAC file, returning original"),n;const i=Dt(a),r=Ls(e);let d=null;if(e.album?.cover)try{d=await Is(e.album.cover,t)}catch(o){console.warn("Failed to embed album art:",o)}const l=As(a,i,r,d);return new Blob([l],{type:"audio/flac"})}catch(s){return console.error("Failed to add FLAC metadata:",s),n}}function Rt(n){return n.byteLength>=4&&n.getUint8(0)===102&&n.getUint8(1)===76&&n.getUint8(2)===97&&n.getUint8(3)===67}function Dt(n){const e=[];let t=4;for(;t+4<=n.byteLength;){const s=n.getUint8(t),a=(s&128)!==0,i=s&127,r=n.getUint8(t+1)<<16|n.getUint8(t+2)<<8|n.getUint8(t+3);if(t+4+r>n.byteLength){console.warn("Invalid block size detected, stopping parse");break}if(e.push({type:i,isLast:a,size:r,offset:t+4,headerOffset:t}),t+=4+r,a){e.audioDataOffset=t;break}}return e}function Ls(n){const e=[];n.title&&e.push(["TITLE",n.title]),n.artist?.name&&e.push(["ARTIST",n.artist.name]),n.album?.title&&e.push(["ALBUM",n.album.title]),n.album?.artist?.name&&e.push(["ALBUMARTIST",n.album.artist.name]),n.trackNumber&&e.push(["TRACKNUMBER",String(n.trackNumber)]),n.album?.numberOfTracks&&e.push(["TRACKTOTAL",String(n.album.numberOfTracks)]);const t=n.album?.releaseDate||(n.streamStartDate?n.streamStartDate.split("T")[0]:"");if(t)try{const m=new Date(t).getFullYear();isNaN(m)||e.push(["DATE",String(m)])}catch{}n.copyright&&e.push(["COPYRIGHT",n.copyright]),n.isrc&&e.push(["ISRC",n.isrc]);const s=ys,a=new TextEncoder().encode(s);let i=4+a.length+4;const r=e.map(([m,u])=>{const h=`${m}=${u}`,f=new TextEncoder().encode(h);return i+=4+f.length,f}),d=new ArrayBuffer(i),l=new DataView(d),o=new Uint8Array(d);let c=0;l.setUint32(c,a.length,!0),c+=4,o.set(a,c),c+=a.length,l.setUint32(c,e.length,!0),c+=4;for(const m of r)l.setUint32(c,m.length,!0),c+=4,o.set(m,c),c+=m.length;return o}async function Is(n,e){try{const t=await Re(e,n);if(!t)throw new Error("Failed to fetch album art");const s=new Uint8Array(await t.arrayBuffer()),a=t.type||"image/jpeg",i=new TextEncoder().encode(a),d=new TextEncoder().encode(""),l=8+i.length+4+d.length+4+4+4+4+4+s.length,o=new ArrayBuffer(l),c=new DataView(o),m=new Uint8Array(o);let u=0;return c.setUint32(u,3,!1),u+=4,c.setUint32(u,i.length,!1),u+=4,m.set(i,u),u+=i.length,c.setUint32(u,d.length,!1),u+=4,d.length>0&&(m.set(d,u),u+=d.length),c.setUint32(u,0,!1),u+=4,c.setUint32(u,0,!1),u+=4,c.setUint32(u,0,!1),u+=4,c.setUint32(u,0,!1),u+=4,c.setUint32(u,s.length,!1),u+=4,m.set(s,u),m}catch(t){return console.error("Failed to create FLAC picture block:",t),null}}function As(n,e,t,s){const a=new Uint8Array(n.buffer),i=e.filter(f=>f.type!==4&&f.type!==6);let r=4;for(const f of i)r+=4+f.size;r+=4+t.length,s&&(r+=4+s.length);const d=e.audioDataOffset;if(d===void 0)throw new Error("Invalid FLAC file structure: unable to locate audio data stream");const l=n.byteLength-d;r+=l;const o=new Uint8Array(r);let c=0;o[c++]=102,o[c++]=76,o[c++]=97,o[c++]=67;for(let f=0;f<i.length;f++){const g=i[f],p=0|g.type;o[c++]=p,o[c++]=g.size>>16&255,o[c++]=g.size>>8&255,o[c++]=g.size&255,o.set(a.subarray(g.offset,g.offset+g.size),c),c+=g.size}const m=c,u=4;o[c++]=u,o[c++]=t.length>>16&255,o[c++]=t.length>>8&255,o[c++]=t.length&255,o.set(t,c),c+=t.length;let h=m;if(s){const f=c,g=6;o[c++]=g,o[c++]=s.length>>16&255,o[c++]=s.length>>8&255,o[c++]=s.length&255,o.set(s,c),c+=s.length,h=f}return o[h]|=128,l>0&&o.set(a.subarray(d,d+l),c),o}async function xs(n,e,t){try{const s=await n.arrayBuffer(),a=new DataView(s),i=re(a),r=Cs(e);if(e.album?.cover)try{const l=await Re(t,e.album.cover);if(l){const o=new Uint8Array(await l.arrayBuffer());r.cover={type:"covr",data:o}}}catch(l){console.warn("Failed to embed album art in M4A:",l)}const d=Ms(a,i,r);return new Blob([d],{type:"audio/mp4"})}catch(s){return console.error("Failed to add M4A metadata:",s),n}}function re(n){const e=[];let t=0;for(;t+8<=n.byteLength;){let s=n.getUint32(t,!1);if(s===0)s=n.byteLength-t;else if(s===1){if(t+16>n.byteLength)break;const i=n.getUint32(t+8,!1),r=n.getUint32(t+12,!1);if(i!==0){console.warn("64-bit MP4 atoms larger than 4GB are not supported - file may be processed incompletely");break}s=r}if(s<8||t+s>n.byteLength)break;const a=String.fromCharCode(n.getUint8(t+4),n.getUint8(t+5),n.getUint8(t+6),n.getUint8(t+7));e.push({type:a,offset:t,size:s}),t+=s}return e}function Cs(n){const e={"©nam":n.title||bs,"©ART":n.artist?.name||wt,"©alb":n.album?.title||ws,aART:n.album?.artist?.name||wt};n.trackNumber&&(e.trkn=n.trackNumber);const t=n.album?.releaseDate||(n.streamStartDate?n.streamStartDate.split("T")[0]:"");if(t)try{const s=new Date(t).getFullYear();isNaN(s)||(e["©day"]=String(s))}catch{}return{tags:e}}function Ms(n,e,t){const s=new Uint8Array(n.buffer),a=e.find(w=>w.type==="moov");if(!a)return console.warn("No moov atom found in M4A file"),s;const i=Bs(t),d=re(new DataView(s.buffer,a.offset+8,a.size-8)).filter(w=>w.type!=="udta");let l=8;for(const w of d)l+=w.size;l+=i.length;const o=l-a.size,c=s.length+o,m=new Uint8Array(c);let u=0,h=0;const f=e.filter(w=>w.offset<a.offset);for(const w of f)m.set(s.subarray(w.offset,w.offset+w.size),u),u+=w.size,h+=w.size;m[u++]=l>>24&255,m[u++]=l>>16&255,m[u++]=l>>8&255,m[u++]=l&255,m[u++]=109,m[u++]=111,m[u++]=111,m[u++]=118;for(const w of d){a.offset+8+w.offset;const I=a.offset+8+w.offset;m.set(s.subarray(I,I+w.size),u),u+=w.size}m.set(i,u),u+=i.length,h=a.offset+a.size;const g=e.find(w=>w.type==="mdat");return g&&a.offset<g.offset&&Rs(m,u-l,l,o),h<s.length&&m.set(s.subarray(h),u),m}function Bs(n){const{tags:e,cover:t}=n,s=[];for(const[p,w]of Object.entries(e))p==="trkn"?s.push(Ps(p,w)):s.push($s(p,w));t&&s.push(_s(t.data));const a=8+s.reduce((p,w)=>p+w.length,0),i=new Uint8Array(a);let r=0;Z(i,r,a,"ilst"),r+=8;for(const p of s)i.set(p,r),r+=p.length;const d=12+a,l=new Uint8Array(d);r=0,Z(l,r,d,"meta"),r+=8,l[r++]=0,l[r++]=0,l[r++]=0,l[r++]=0,l.set(i,r);const o=new Uint8Array([0,0,0,0,0,0,0,0,109,100,105,114,97,112,112,108,0,0,0,0,0,0,0,0,0,0]),c=8+o.length,m=new Uint8Array(c);Z(m,0,c,"hdlr"),m.set(o,8);const u=12+c+a,h=new Uint8Array(u);r=0,Z(h,r,u,"meta"),r+=8,h[r++]=0,h[r++]=0,h[r++]=0,h[r++]=0,h.set(m,r),r+=c,h.set(i,r);const f=8+u,g=new Uint8Array(f);return Z(g,0,f,"udta"),g.set(h,8),g}function $s(n,e){const t=new TextEncoder().encode(e),s=16+t.length,a=8+s,i=new Uint8Array(a);let r=0;return Z(i,r,a,n),r+=8,Z(i,r,s,"data"),r+=8,i[r++]=0,i[r++]=0,i[r++]=0,i[r++]=1,i[r++]=0,i[r++]=0,i[r++]=0,i[r++]=0,i.set(t,r),i}function Ps(n,e){const a=new Uint8Array(32);let i=0;Z(a,i,32,n),i+=8,Z(a,i,24,"data"),i+=8,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0;const r=parseInt(e)||0;return a[i++]=r>>8&255,a[i++]=r&255,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a}function _s(n){const e=16+n.length,t=8+e,s=new Uint8Array(t);let a=0;Z(s,a,t,"covr"),a+=8,Z(s,a,e,"data"),a+=8;let i=13;return n[0]===137&&n[1]===80&&(i=14),s[a++]=0,s[a++]=0,s[a++]=0,s[a++]=i,s[a++]=0,s[a++]=0,s[a++]=0,s[a++]=0,s.set(n,a),s}function Z(n,e,t,s){n[e++]=t>>24&255,n[e++]=t>>16&255,n[e++]=t>>8&255,n[e++]=t&255;for(let a=0;a<4;a++)n[e++]=s.charCodeAt(a)}function Rs(n,e,t,s){const a=new DataView(n.buffer,n.byteOffset,n.byteLength);let i=e+8;const r=e+t;Ft(a,i,r,s)}function Ft(n,e,t,s){let a=e;for(;a+8<=t;){const i=n.getUint32(a,!1),r=String.fromCharCode(n.getUint8(a+4),n.getUint8(a+5),n.getUint8(a+6),n.getUint8(a+7));if(i<8)break;if(r==="trak"||r==="mdia"||r==="minf"||r==="stbl")Ft(n,a+8,a+i,s);else if(r==="stco"){const d=n.getUint32(a+12,!1);for(let l=0;l<d;l++){const o=a+16+l*4,c=n.getUint32(o,!1);n.setUint32(o,c+s,!1)}}else if(r==="co64"){const d=n.getUint32(a+12,!1);for(let l=0;l<d;l++){const o=a+16+l*8,c=n.getUint32(o,!1);let u=n.getUint32(o+4,!1)+s,h=0;u>4294967295&&(h=Math.floor(u/4294967296),u=u>>>0);const f=c+h;n.setUint32(o,f,!1),n.setUint32(o+4,u,!1)}}a+=i}}class Ds{constructor(e){this.settings=e,this.cache=new ps({maxSize:200,ttl:1e3*60*30}),this.streamCache=new Map,setInterval(()=>{this.cache.clearExpired(),this.pruneStreamCache()},1e3*60*5)}pruneStreamCache(){if(this.streamCache.size>50){const e=Array.from(this.streamCache.entries());e.slice(0,e.length-50).forEach(([s])=>this.streamCache.delete(s))}}async fetchWithRetry(e,t={}){const s=t.type||"api",a=await this.settings.getInstances(s);if(a.length===0)throw new Error(`No API instances configured for type: ${s}`);const i=3;let r=null;for(const d of a){const l=d.endsWith("/")?`${d}${e.substring(1)}`:`${d}${e}`;for(let o=1;o<=i;o++)try{const c=await fetch(l,{signal:t.signal});if(c.status===429){const m=c.headers.get("Retry-After");let u=2e3*o;if(m){const h=parseInt(m,10);isNaN(h)||(u=h*1e3)}console.warn(`Rate limit hit. Waiting ${u}ms before retry ${o}/${i}...`),await He(u);continue}if(c.ok)return c;if(c.status===401){let m=await c.clone().json();if(m?.subStatus===11002&&(r=new Error(m?.userMessage||"Authentication failed"),o<i)){await He(200*o);continue}}if(c.status>=500&&o<i){await He(200*o);continue}r=new Error(`Request failed with status ${c.status}`);break}catch(c){if(c.name==="AbortError")throw c;r=c,o<i&&await He(200*o)}}throw r||new Error(`All API instances failed for: ${e}`)}findSearchSection(e,t,s){if(!(!e||typeof e!="object")){if(Array.isArray(e)){for(const a of e){const i=this.findSearchSection(a,t,s);if(i)return i}return}if(!s.has(e)){if(s.add(e),"items"in e&&Array.isArray(e.items))return e;if(t in e){const a=this.findSearchSection(e[t],t,s);if(a)return a}for(const a of Object.values(e)){const i=this.findSearchSection(a,t,s);if(i)return i}}}}buildSearchResponse(e){const t=e?.items??[];return{items:t,limit:e?.limit??t.length,offset:e?.offset??0,totalNumberOfItems:e?.totalNumberOfItems??t.length}}normalizeSearchResponse(e,t){const s=this.findSearchSection(e,t,new Set);return this.buildSearchResponse(s)}prepareTrack(e){let t=e;!e.artist&&Array.isArray(e.artists)&&e.artists.length>0&&(t={...e,artist:e.artists[0]});const s=fs(t);return s&&t.audioQuality!==s&&(t={...t,audioQuality:s}),t}prepareAlbum(e){return!e.artist&&Array.isArray(e.artists)&&e.artists.length>0?{...e,artist:e.artists[0]}:e}preparePlaylist(e){return e}prepareArtist(e){return!e.type&&Array.isArray(e.artistTypes)&&e.artistTypes.length>0?{...e,type:e.artistTypes[0]}:e}parseTrackLookup(e){const t=Array.isArray(e)?e:[e];let s,a,i;for(const r of t)if(!(!r||typeof r!="object")){if(!s&&"duration"in r){s=r;continue}if(!a&&"manifest"in r){a=r;continue}if(!i&&"OriginalTrackUrl"in r){const d=r.OriginalTrackUrl;typeof d=="string"&&(i=d)}}if(!s||!a)throw new Error("Malformed track response");return{track:s,info:a,originalTrackUrl:i}}extractStreamUrlFromManifest(e){try{const t=atob(e);try{const s=JSON.parse(t);if(s?.urls?.[0])return s.urls[0]}catch{const s=t.match(/https?:\/\/[\w\-.~:?#[@!$&'()*+,;=%/]+/);return s?s[0]:null}}catch(t){return console.error("Failed to decode manifest:",t),null}}deduplicateAlbums(e){const t=new Map;for(const s of e){const a=JSON.stringify([s.title,s.numberOfTracks||0]);if(t.has(a)){const i=t.get(a);if(s.explicit&&!i.explicit){t.set(a,s);continue}if(!s.explicit&&i.explicit)continue;const r=i.mediaMetadata?.tags?.length||0;(s.mediaMetadata?.tags?.length||0)>r&&t.set(a,s)}else t.set(a,s)}return Array.from(t.values())}async searchTracks(e,t={}){const s=await this.cache.get("search_tracks",e);if(s)return s;try{const i=await(await this.fetchWithRetry(`/search/?s=${encodeURIComponent(e)}`,t)).json(),r=this.normalizeSearchResponse(i,"tracks"),d={...r,items:r.items.map(l=>this.prepareTrack(l))};return await this.cache.set("search_tracks",e,d),d}catch(a){if(a.name==="AbortError")throw a;return console.error("Track search failed:",a),{items:[],limit:0,offset:0,totalNumberOfItems:0}}}async searchArtists(e,t={}){const s=await this.cache.get("search_artists",e);if(s)return s;try{const i=await(await this.fetchWithRetry(`/search/?a=${encodeURIComponent(e)}`,t)).json(),r=this.normalizeSearchResponse(i,"artists"),d={...r,items:r.items.map(l=>this.prepareArtist(l))};return await this.cache.set("search_artists",e,d),d}catch(a){if(a.name==="AbortError")throw a;return console.error("Artist search failed:",a),{items:[],limit:0,offset:0,totalNumberOfItems:0}}}async searchAlbums(e,t={}){const s=await this.cache.get("search_albums",e);if(s)return s;try{const i=await(await this.fetchWithRetry(`/search/?al=${encodeURIComponent(e)}`,t)).json(),r=this.normalizeSearchResponse(i,"albums"),d=r.items.map(o=>this.prepareAlbum(o)),l={...r,items:this.deduplicateAlbums(d)};return await this.cache.set("search_albums",e,l),l}catch(a){if(a.name==="AbortError")throw a;return console.error("Album search failed:",a),{items:[],limit:0,offset:0,totalNumberOfItems:0}}}async searchPlaylists(e,t={}){const s=await this.cache.get("search_playlists",e);if(s)return s;try{const i=await(await this.fetchWithRetry(`/search/?p=${encodeURIComponent(e)}`,t)).json(),r=this.normalizeSearchResponse(i,"playlists"),d={...r,items:r.items.map(l=>this.preparePlaylist(l))};return await this.cache.set("search_playlists",e,d),d}catch(a){if(a.name==="AbortError")throw a;return console.error("Playlist search failed:",a),{items:[],limit:0,offset:0,totalNumberOfItems:0}}}async getAlbum(e){const t=await this.cache.get("album",e);if(t)return t;const a=await(await this.fetchWithRetry(`/album/?id=${e}`)).json(),i=a.data||a;let r,d;if(i&&typeof i=="object"&&!Array.isArray(i)&&(("numberOfTracks"in i||"title"in i)&&(r=this.prepareAlbum(i)),"items"in i&&(d=i,!r&&i.items&&i.items.length>0))){const c=i.items[0],m=c.item||c;m&&m.album&&(r=this.prepareAlbum(m.album))}if(!r)throw new Error("Album not found");if(r&&!r.artist&&d?.items&&d.items.length>0){const c=d.items[0],m=c.item||c;m&&m.artist&&(r={...r,artist:m.artist})}if(r&&!r.releaseDate&&d?.items&&d.items.length>0){const c=d.items[0],m=c.item||c;m&&(m.album&&m.album.releaseDate?r={...r,releaseDate:m.album.releaseDate}:m.streamStartDate&&(r={...r,releaseDate:m.streamStartDate.split("T")[0]}))}let l=(d?.items||[]).map(c=>this.prepareTrack(c.item||c));if(r&&r.numberOfTracks>l.length){let c=l.length;const m=1e4;for(;l.length<r.numberOfTracks&&l.length<m;)try{const h=await(await this.fetchWithRetry(`/album/?id=${e}&offset=${c}&limit=500`)).json(),f=h.data||h;let g=[];if(f.items)g=f.items;else if(Array.isArray(f)){for(const w of f)if(w&&typeof w=="object"&&"items"in w&&Array.isArray(w.items)){g=w.items;break}}if(!g||g.length===0)break;const p=g.map(w=>this.prepareTrack(w.item||w));if(p.length===0||l.length>0&&p[0].id===l[0].id)break;l.length>0&&(p[0].id,l[l.length-1].id),l=l.concat(p),c+=p.length}catch(u){console.error(`Error fetching album tracks at offset ${c}:`,u);break}}const o={album:r,tracks:l};return await this.cache.set("album",e,o),o}async getPlaylist(e){const t=await this.cache.get("playlist",e);if(t)return t;const a=await(await this.fetchWithRetry(`/playlist/?id=${e}`)).json(),i=a.data||a;let r=null,d=null;if(i.playlist&&(r=i.playlist),i.items&&(d={items:i.items}),!r||!d){const c=Array.isArray(i)?i:[i];for(const m of c)!m||typeof m!="object"||(!r&&("uuid"in m||"numberOfTracks"in m||"title"in m&&"id"in m)&&(r=m),!d&&"items"in m&&(d=m))}if(!r&&Array.isArray(i)){for(const c of i)if(c&&typeof c=="object"&&("uuid"in c||"numberOfTracks"in c)){r=c;break}}if(!r)throw new Error("Playlist not found");let l=(d?.items||[]).map(c=>this.prepareTrack(c.item||c));if(r.numberOfTracks>l.length){let c=l.length;const m=1e4;for(;l.length<r.numberOfTracks&&l.length<m;)try{const h=await(await this.fetchWithRetry(`/playlist/?id=${e}&offset=${c}`)).json(),f=h.data||h;let g=[];if(f.items)g=f.items;else if(Array.isArray(f)){for(const w of f)if(w&&typeof w=="object"&&"items"in w&&Array.isArray(w.items)){g=w.items;break}}if(!g||g.length===0)break;const p=g.map(w=>this.prepareTrack(w.item||w));if(p.length===0||l.length>0&&p[0].id===l[0].id)break;l=l.concat(p),c+=p.length}catch(u){console.error(`Error fetching playlist tracks at offset ${c}:`,u);break}}const o={playlist:r,tracks:l};return await this.cache.set("playlist",e,o),o}async getMix(e){const t=await this.cache.get("mix",e);if(t)return t;const a=await(await this.fetchWithRetry(`/mix/?id=${e}`,{type:"api"})).json(),i=a.mix,r=a.items||[];if(!i)throw new Error("Mix metadata not found");const d=r.map(c=>this.prepareTrack(c.item||c)),o={mix:{id:i.id,title:i.title,subTitle:i.subTitle,description:i.description,mixType:i.mixType,cover:i.images?.LARGE?.url||i.images?.MEDIUM?.url||i.images?.SMALL?.url||null},tracks:d};return await this.cache.set("mix",e,o),o}async getArtist(e){const t=await this.cache.get("artist",e);if(t)return t;const[s,a]=await Promise.all([this.fetchWithRetry(`/artist/?id=${e}`),this.fetchWithRetry(`/artist/?f=${e}&skip_tracks=true`)]),i=await s.json();let r=i.data||i;const d=r.artist||(Array.isArray(r)?r[0]:r);if(!d)throw new Error("Primary artist details not found.");const l={...this.prepareArtist(d),picture:d.picture||r.cover||null,name:d.name||"Unknown Artist"},o=await a.json(),c=o.data||o,m=Array.isArray(c)?c:[c],u=new Map,h=new Map,f=v=>v?.id&&v.duration&&v.album,g=v=>v?.id&&"numberOfTracks"in v,p=(v,S=new Set)=>{if(!v||typeof v!="object"||S.has(v))return;if(S.add(v),Array.isArray(v)){v.forEach(A=>p(A,S));return}const L=v.item||v;g(L)&&u.set(L.id,this.prepareAlbum(L)),f(L)&&h.set(L.id,this.prepareTrack(L)),Object.values(v).forEach(A=>p(A,S))};m.forEach(v=>p(v));try{const v=await this.searchAlbums(l.name);if(v&&v.items){const S=Number(e);for(const L of v.items)(L.artist?.id===S||Array.isArray(L.artists)&&L.artists.some(x=>x.id===S))&&!u.has(L.id)&&u.set(L.id,L)}}catch(v){console.warn("Failed to fetch additional albums via search:",v)}const w=Array.from(u.values()),I=this.deduplicateAlbums(w).sort((v,S)=>new Date(S.releaseDate||0)-new Date(v.releaseDate||0)),y=I.filter(v=>v.type==="EP"||v.type==="SINGLE"),b=I.filter(v=>!y.includes(v)),k=Array.from(h.values()).sort((v,S)=>(S.popularity||0)-(v.popularity||0)).slice(0,15),T={...l,albums:b,eps:y,tracks:k};return await this.cache.set("artist",e,T),T}async getSimilarArtists(e){const t=await this.cache.get("similar_artists",e);if(t)return t;try{const a=await(await this.fetchWithRetry(`/artist/similar/?id=${e}`,{type:"api"})).json(),r=(a.artists||a.items||a.data||(Array.isArray(a)?a:[])).map(d=>this.prepareArtist(d));return await this.cache.set("similar_artists",e,r),r}catch(s){return console.warn("Failed to fetch similar artists:",s),[]}}async getSimilarAlbums(e){const t=await this.cache.get("similar_albums",e);if(t)return t;try{const a=await(await this.fetchWithRetry(`/album/similar/?id=${e}`,{type:"api"})).json(),r=(a.items||a.albums||a.data||(Array.isArray(a)?a:[])).map(d=>this.prepareAlbum(d));return await this.cache.set("similar_albums",e,r),r}catch(s){return console.warn("Failed to fetch similar albums:",s),[]}}async getRecommendedTracksForPlaylist(e,t=20){const s=new Map;for(const o of e)if(o.artist&&o.artist.id&&s.set(o.artist.id,o.artist),o.artists&&Array.isArray(o.artists))for(const c of o.artists)c.id&&s.set(c.id,c);if(s.size<3){console.log("Not enough artists from stored data, trying search approach...");for(const o of e.slice(0,5))try{const c=`"${o.title}" ${o.artist?.name||""}`.trim(),m=await this.searchTracks(c,{signal:AbortSignal.timeout(5e3)});if(m.items&&m.items.length>0){const u=m.items[0];if(u.artist&&u.artist.id&&s.set(u.artist.id,u.artist),u.artists&&Array.isArray(u.artists))for(const h of u.artists)h.id&&s.set(h.id,h)}}catch(c){console.warn(`Search failed for track "${o.title}":`,c)}}const a=Array.from(s.values());if(console.log(`Found ${a.length} unique artists from ${e.length} tracks`),a.length===0)return console.log("No artists found, cannot generate recommendations"),[];const i=[],r=new Set(e.map(o=>o.id)),d=a.slice(0,Math.min(5,a.length));console.log(`Processing ${d.length} artists for recommendations`);for(const o of d)try{console.log(`Fetching tracks for artist: ${o.name} (ID: ${o.id})`);const c=await this.getArtist(o.id);if(c&&c.tracks&&c.tracks.length>0){const m=c.tracks.filter(u=>!r.has(u.id)).slice(0,4);console.log(`Found ${m.length} new tracks from ${o.name}`),i.push(...m),r.add(...m.map(u=>u.id))}else console.warn(`No tracks found for artist ${o.name}`)}catch(c){console.warn(`Failed to get tracks for artist ${o.name}:`,c)}return console.log(`Total recommended tracks found: ${i.length}`),i.sort(()=>.5-Math.random()).slice(0,t)}normalizeTrackResponse(e){if(!e||typeof e!="object")return e;const t=e.data??e;return[{duration:t.duration??0,id:t.trackId??null},t]}async getTrack(e,t="LOSSLESS"){const s=`${e}_${t}`,a=await this.cache.get("track",s);if(a)return a;const r=await(await this.fetchWithRetry(`/track/?id=${e}&quality=${t}`,{type:"streaming"})).json(),d=this.parseTrackLookup(this.normalizeTrackResponse(r));return await this.cache.set("track",s,d),d}async getStreamUrl(e,t="LOSSLESS"){const s=`stream_${e}_${t}`;if(this.streamCache.has(s))return this.streamCache.get(s);const a=await this.getTrack(e,t);let i;if(a.originalTrackUrl)i=a.originalTrackUrl;else if(i=this.extractStreamUrlFromManifest(a.info.manifest),!i)throw new Error("Could not resolve stream URL");return this.streamCache.set(s,i),i}async downloadTrack(e,t="LOSSLESS",s,a={}){const{onProgress:i,track:r}=a;try{const d=await this.getTrack(e,t);let l;if(d.originalTrackUrl)l=d.originalTrackUrl;else if(l=this.extractStreamUrlFromManifest(d.info.manifest),!l)throw new Error("Could not resolve stream URL");const o=await fetch(l,{cache:"no-store",signal:a.signal});if(!o.ok)throw new Error(`Fetch failed: ${o.status}`);const c=o.headers.get("Content-Length"),m=c?parseInt(c,10):0;let u=0,h;if(o.body&&i){const f=o.body.getReader(),g=[];for(;;){const{done:p,value:w}=await f.read();if(p)break;w&&(g.push(w),u+=w.byteLength,i({stage:"downloading",receivedBytes:u,totalBytes:m||void 0}))}h=new Blob(g,{type:o.headers.get("Content-Type")||"audio/flac"})}else h=await o.blob(),i&&i({stage:"downloading",receivedBytes:h.size,totalBytes:h.size});r&&(i&&i({stage:"processing",message:"Adding metadata..."}),h=await _t(h,r,this,t)),this.triggerDownload(h,s)}catch(d){throw d.name==="AbortError"||(console.error("Download failed:",d),d.message===Mt)?d:new Error("Download failed. The stream may require a proxy.")}}triggerDownload(e,t){const s=URL.createObjectURL(e),a=document.createElement("a");a.href=s,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s)}getCoverUrl(e,t="320"){return e?`https://resources.tidal.com/images/${e.replace(/-/g,"/")}/${t}x${t}.jpg`:`https://picsum.photos/seed/${Math.random()}/${t}`}getArtistPictureUrl(e,t="320"){return e?typeof e=="string"&&(e.startsWith("blob:")||e.startsWith("assets/"))?e:`https://resources.tidal.com/images/${e.replace(/-/g,"/")}/${t}x${t}.jpg`:`https://picsum.photos/seed/${Math.random()}/${t}`}async clearCache(){await this.cache.clear(),this.streamCache.clear()}getCacheStats(){return{...this.cache.getCacheStats(),streamUrls:this.streamCache.size}}}const Fs={STORAGE_KEY:"monochrome-api-instances-v2",INSTANCES_URL:"instances.json",SPEED_TEST_CACHE_KEY:"monochrome-instance-speeds",SPEED_TEST_CACHE_DURATION:1e3*60*60,defaultInstances:{api:[],streaming:[]},instancesLoaded:!1,async loadInstancesFromGitHub(){if(this.instancesLoaded)return this.defaultInstances;try{const n=await fetch(this.INSTANCES_URL);if(!n.ok)throw new Error("Failed to fetch instances");const e=await n.json();let t={api:[],streaming:[]};if(Array.isArray(e))t.api=[...e],t.streaming=[...e];else{if(e.api&&Array.isArray(e.api))if(e.api.length>0&&typeof e.api[0]=="string")t.api=[...e.api];else for(const[a,i]of Object.entries(e.api))i.cors===!1&&Array.isArray(i.urls)&&t.api.push(...i.urls);e.streaming&&Array.isArray(e.streaming)?t.streaming=[...e.streaming]:t.api.length>0&&(t.streaming=[...t.api])}return this.defaultInstances=t,this.instancesLoaded=!0,t}catch(n){return console.error("Failed to load instances from GitHub:",n),this.defaultInstances={api:["https://tidal-api.binimum.org","https://monochrome-api.samidy.com"],streaming:["https://triton.squid.wtf","https://wolf.qqdl.site","https://maus.qqdl.site","https://vogel.qqdl.site","https://katze.qqdl.site","https://hund.qqdl.site","https://tidal.kinoplus.online","https://tidal-api.binimum.org"]},this.instancesLoaded=!0,this.defaultInstances}},async speedTestInstance(n,e="api"){let t;e==="streaming"?t=n.endsWith("/")?`${n}track/?id=204567804&quality=HIGH`:`${n}/track/?id=204567804&quality=HIGH`:t=n.endsWith("/")?`${n}artist/?id=3532302`:`${n}/artist/?id=3532302`;const s=performance.now();try{const a=new AbortController,i=setTimeout(()=>a.abort(),5e3),r=await fetch(t,{signal:a.signal,cache:"no-store"});if(clearTimeout(i),!r.ok)return{url:n,type:e,speed:1/0,error:`HTTP ${r.status}`};const l=performance.now()-s;return{url:n,type:e,speed:l,error:null}}catch(a){return{url:n,type:e,speed:1/0,error:a.message}}},getCachedSpeedTests(){try{const n=localStorage.getItem(this.SPEED_TEST_CACHE_KEY);if(!n)return{speeds:{},timestamp:Date.now()};const e=JSON.parse(n);return Date.now()-e.timestamp>this.SPEED_TEST_CACHE_DURATION?{speeds:{},timestamp:Date.now()}:e}catch{return{speeds:{},timestamp:Date.now()}}},updateSpeedCache(n){const e=this.getCachedSpeedTests();n.forEach(t=>{const s=t.type==="streaming"?`${t.url}#streaming`:t.url;e.speeds[s]={speed:t.speed,error:t.error}}),e.timestamp=Date.now();try{localStorage.setItem(this.SPEED_TEST_CACHE_KEY,JSON.stringify(e))}catch{console.warn("[SpeedTest] Failed to cache results")}return e},async testSpecificUrls(n,e){if(!n||n.length===0)return[];console.log(`[SpeedTest] Testing ${n.length} instances for ${e}...`);const t=await Promise.all(n.map(a=>this.speedTestInstance(a,e))),s=t.filter(a=>a.speed!==1/0);return console.log(`[SpeedTest] ${e} Results:`,s.map(a=>`${a.url}: ${a.speed.toFixed(0)}ms`)),t},async getInstances(n="api"){let e;const t=localStorage.getItem(this.STORAGE_KEY);t&&(e=JSON.parse(t)),e||(e=await this.loadInstancesFromGitHub());const s=e[n]||e.api||[];if(s.length===0)return[];const a=this.getCachedSpeedTests(),i=o=>n==="streaming"?`${o}#streaming`:o,r=s.filter(o=>!a.speeds[i(o)]);if(r.length>0){const o=await this.testSpecificUrls(r,n);this.updateSpeedCache(o),Object.assign(a,this.getCachedSpeedTests())}const l=(o=>[...o].sort((c,m)=>{const u=a.speeds[i(c)]?.speed??1/0,h=a.speeds[i(m)]?.speed??1/0;return u-h}))(s);return e[n]=l,this.saveInstances(e),l},async refreshSpeedTests(){const n=await this.loadInstancesFromGitHub(),e=[];n.api&&n.api.length&&e.push(this.testSpecificUrls(n.api,"api")),n.streaming&&n.streaming.length&&e.push(this.testSpecificUrls(n.streaming,"streaming"));const s=(await Promise.all(e)).flat();return this.updateSpeedCache(s),this.getInstances("api")},saveInstances(n,e){if(e)try{const t=localStorage.getItem(this.STORAGE_KEY);let s=t?JSON.parse(t):{api:[],streaming:[]};s[e]=n,localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s))}catch(t){console.error("Failed to save instances:",t)}else localStorage.setItem(this.STORAGE_KEY,JSON.stringify(n))}},ge={STORAGE_KEY:"monochrome-recent-activity",LIMIT:10,_get(){try{const n=localStorage.getItem(this.STORAGE_KEY),e=n?JSON.parse(n):{artists:[],albums:[],playlists:[],mixes:[]};return e.playlists||(e.playlists=[]),e.mixes||(e.mixes=[]),e}catch{return{artists:[],albums:[],playlists:[],mixes:[]}}},_save(n){localStorage.setItem(this.STORAGE_KEY,JSON.stringify(n))},getRecents(){return this._get()},_add(n,e){const t=this._get();t[n]=t[n].filter(s=>s.id!==e.id),t[n].unshift(e),t[n]=t[n].slice(0,this.LIMIT),this._save(t)},addArtist(n){this._add("artists",n)},addAlbum(n){this._add("albums",n)},addPlaylist(n){this._add("playlists",n)},addMix(n){this._add("mixes",n)}},oe={STORAGE_KEY:"monochrome-theme",CUSTOM_THEME_KEY:"monochrome-custom-theme",defaultThemes:{light:{},dark:{},monochrome:{},ocean:{},purple:{},forest:{},mocha:{},machiatto:{},frappe:{},latte:{}},getTheme(){try{return localStorage.getItem(this.STORAGE_KEY)||"system"}catch{return"system"}},setTheme(n){if(localStorage.setItem(this.STORAGE_KEY,n),n==="system"){const e=window.matchMedia("(prefers-color-scheme: dark)").matches;document.documentElement.setAttribute("data-theme",e?"dark":"light")}else document.documentElement.setAttribute("data-theme",n);if(n!=="custom"){const e=document.documentElement;["background","foreground","primary","secondary","muted","border","highlight"].forEach(t=>{e.style.removeProperty(`--${t}`)})}else{const e=this.getCustomTheme();e&&this.applyCustomTheme(e)}},getCustomTheme(){try{const n=localStorage.getItem(this.CUSTOM_THEME_KEY);return n?JSON.parse(n):null}catch{return null}},setCustomTheme(n){localStorage.setItem(this.CUSTOM_THEME_KEY,JSON.stringify(n)),this.applyCustomTheme(n),this.setTheme("custom")},applyCustomTheme(n){const e=document.documentElement;for(const[t,s]of Object.entries(n))e.style.setProperty(`--${t}`,s)}},le={STORAGE_KEY:"lastfm-enabled",LOVE_ON_LIKE_KEY:"lastfm-love-on-like",isEnabled(){try{return localStorage.getItem(this.STORAGE_KEY)==="true"}catch{return!1}},setEnabled(n){localStorage.setItem(this.STORAGE_KEY,n?"true":"false")},shouldLoveOnLike(){try{return localStorage.getItem(this.LOVE_ON_LIKE_KEY)==="true"}catch{return!1}},setLoveOnLike(n){localStorage.setItem(this.LOVE_ON_LIKE_KEY,n?"true":"false")}},at={STORAGE_KEY:"now-playing-mode",getMode(){try{return localStorage.getItem(this.STORAGE_KEY)||"cover"}catch{return"cover"}},setMode(n){localStorage.setItem(this.STORAGE_KEY,n)}},Ce={DOWNLOAD_WITH_TRACKS:"lyrics-download-with-tracks",shouldDownloadLyrics(){try{return localStorage.getItem(this.DOWNLOAD_WITH_TRACKS)==="true"}catch{return!1}},setDownloadLyrics(n){localStorage.setItem(this.DOWNLOAD_WITH_TRACKS,n?"true":"false")}},we={STORAGE_KEY:"album-background-enabled",isEnabled(){try{return localStorage.getItem(this.STORAGE_KEY)!=="false"}catch{return!0}},setEnabled(n){localStorage.setItem(this.STORAGE_KEY,n?"true":"false")}},it={STORAGE_KEY:"track-list-actions-mode",getMode(){try{const n=localStorage.getItem(this.STORAGE_KEY)||"dropdown";return document.documentElement.setAttribute("data-track-actions-mode",n),n}catch{return"dropdown"}},setMode(n){localStorage.setItem(this.STORAGE_KEY,n),document.documentElement.setAttribute("data-track-actions-mode",n)}},se={COMPACT_ARTIST_KEY:"card-compact-artist",COMPACT_ALBUM_KEY:"card-compact-album",isCompactArtist(){try{const n=localStorage.getItem(this.COMPACT_ARTIST_KEY);return n===null?!0:n==="true"}catch{return!0}},setCompactArtist(n){localStorage.setItem(this.COMPACT_ARTIST_KEY,n?"true":"false")},isCompactAlbum(){try{return localStorage.getItem(this.COMPACT_ALBUM_KEY)==="true"}catch{return!1}},setCompactAlbum(n){localStorage.setItem(this.COMPACT_ALBUM_KEY,n?"true":"false")}},ve={STORAGE_KEY_MODE:"replay-gain-mode",STORAGE_KEY_PREAMP:"replay-gain-preamp",getMode(){return localStorage.getItem(this.STORAGE_KEY_MODE)||"track"},setMode(n){localStorage.setItem(this.STORAGE_KEY_MODE,n)},getPreamp(){const n=parseFloat(localStorage.getItem(this.STORAGE_KEY_PREAMP));return isNaN(n)?3:n},setPreamp(n){localStorage.setItem(this.STORAGE_KEY_PREAMP,n)}},ce={STORAGE_KEY:"download-quality",getQuality(){try{return localStorage.getItem(this.STORAGE_KEY)||"LOSSLESS"}catch{return"LOSSLESS"}},setQuality(n){localStorage.setItem(this.STORAGE_KEY,n)}},rt={STORAGE_KEY:"waveform-seekbar-enabled",isEnabled(){try{return localStorage.getItem(this.STORAGE_KEY)==="true"}catch{return!1}},setEnabled(n){localStorage.setItem(this.STORAGE_KEY,n?"true":"false")}},ot={STORAGE_KEY:"smooth-scrolling-enabled",isEnabled(){try{return localStorage.getItem(this.STORAGE_KEY)==="true"}catch{return!1}},setEnabled(n){localStorage.setItem(this.STORAGE_KEY,n?"true":"false")}},vt={STORAGE_KEY:"monochrome-queue",getQueue(){try{const n=localStorage.getItem(this.STORAGE_KEY);return n?JSON.parse(n):null}catch{return null}},saveQueue(n){try{const e={queue:n.queue,shuffledQueue:n.shuffledQueue,originalQueueBeforeShuffle:n.originalQueueBeforeShuffle,currentQueueIndex:n.currentQueueIndex,shuffleActive:n.shuffleActive,repeatMode:n.repeatMode};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){console.warn("Failed to save queue to localStorage:",e)}}};typeof window<"u"&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",n=>{oe.getTheme()==="system"&&document.documentElement.setAttribute("data-theme",n.matches?"dark":"light")});class Hs{constructor(){this.panel=document.getElementById("side-panel"),this.titleElement=document.getElementById("side-panel-title"),this.controlsElement=document.getElementById("side-panel-controls"),this.contentElement=document.getElementById("side-panel-content"),this.currentView=null}open(e,t,s,a){if(this.currentView===e&&this.panel.classList.contains("active")){this.close();return}this.currentView=e,this.titleElement.textContent=t,this.controlsElement.innerHTML="",this.contentElement.innerHTML="",s&&s(this.controlsElement),a&&a(this.contentElement),this.panel.classList.add("active")}close(){this.panel.classList.remove("active"),this.currentView=null,setTimeout(()=>{this.panel.classList.contains("active")||(this.controlsElement.innerHTML="",this.contentElement.innerHTML="")},300)}isActive(e){return this.currentView===e&&this.panel.classList.contains("active")}refresh(e,t,s){this.isActive(e)&&(t&&(this.controlsElement.innerHTML="",t(this.controlsElement)),s&&(this.contentElement.innerHTML="",s(this.contentElement)))}updateContent(e,t){this.isActive(e)&&(this.contentElement.innerHTML="",t(this.contentElement))}}const j=new Hs;class Ht{constructor(e){this.api=e,this.currentLyrics=null,this.syncedLyrics=[],this.lyricsCache=new Map,this.componentLoaded=!1,this.amLyricsElement=null,this.animationFrameId=null,this.currentTrackId=null,this.mutationObserver=null,this.romajiObserver=null,this.isRomajiMode=!1,this.originalLyricsData=null,this.kuroshiroLoaded=!1,this.kuroshiroLoading=!1,this.romajiTextCache=new Map,this.convertedTracksCache=new Set}async loadKuroshiro(){if(this.kuroshiroLoaded)return!0;if(this.kuroshiroLoading)return new Promise(e=>{const t=setInterval(()=>{this.kuroshiroLoading||(clearInterval(t),e(this.kuroshiroLoaded))},100)});this.kuroshiroLoading=!0;try{window._originalXHROpen||(window._originalXHROpen=XMLHttpRequest.prototype.open,XMLHttpRequest.prototype.open=function(s,a,...i){const r=a.toString();if(r.includes("/dict/")&&r.includes(".dat.gz")){const l=`https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/${r.split("/").pop()}`;return window._originalXHROpen.call(this,s,l,...i)}return window._originalXHROpen.call(this,s,a,...i)}),window._originalFetch||(window._originalFetch=window.fetch,window.fetch=async(s,a)=>{const i=s.toString();if(i.includes("/dict/")&&i.includes(".dat.gz")){const r=i.split("/").pop(),d=`https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/${r}`;return console.log(`Redirecting dict fetch: ${r} -> CDN`),window._originalFetch(d,a)}return window._originalFetch(s,a)}),window.Kuroshiro||await this.loadScript("https://unpkg.com/kuroshiro@1.2.0/dist/kuroshiro.min.js"),window.KuromojiAnalyzer||await this.loadScript("https://unpkg.com/kuroshiro-analyzer-kuromoji@1.1.0/dist/kuroshiro-analyzer-kuromoji.min.js");const e=window.Kuroshiro.default||window.Kuroshiro,t=window.KuromojiAnalyzer.default||window.KuromojiAnalyzer;return this.kuroshiro=new e,await this.kuroshiro.init(new t({dictPath:"/dict/"})),this.kuroshiroLoaded=!0,this.kuroshiroLoading=!1,console.log("✓ Kuroshiro loaded and initialized successfully"),!0}catch(e){return console.error("✗ Failed to load Kuroshiro:",e),this.kuroshiroLoaded=!1,this.kuroshiroLoading=!1,!1}}loadScript(e){return new Promise((t,s)=>{if(document.querySelector(`script[src="${e}"]`)){t();return}const a=document.createElement("script");a.src=e,a.onload=t,a.onerror=()=>s(new Error(`Failed to load script: ${e}`)),document.head.appendChild(a)})}containsJapanese(e){return e?/[\u3040-\u30FF\u31F0-\u9FFF]/.test(e):!1}async convertToRomaji(e){if(!e)return e;if(this.romajiTextCache.has(e))return this.romajiTextCache.get(e);if(!this.kuroshiroLoaded&&!await this.loadKuroshiro()||!this.kuroshiro)return console.warn("Kuroshiro not available, skipping conversion"),e;try{const t=await this.kuroshiro.convert(e,{to:"romaji",mode:"spaced",romajiSystem:"hepburn"});return this.romajiTextCache.set(e,t),t}catch(t){return console.warn("Romaji conversion failed for text:",e.substring(0,30),t),e}}setRomajiMode(e){this.isRomajiMode=e;try{localStorage.setItem("lyricsRomajiMode",e?"true":"false")}catch(t){console.warn("Failed to save Romaji mode preference:",t)}}getRomajiMode(){try{return localStorage.getItem("lyricsRomajiMode")==="true"}catch{return!1}}async ensureComponentLoaded(){if(!this.componentLoaded){if(typeof customElements<"u"&&customElements.get("am-lyrics")){this.componentLoaded=!0;return}return new Promise((e,t)=>{const s=document.createElement("script");s.type="module",s.src="https://cdn.jsdelivr.net/npm/@uimaxbai/am-lyrics@0.6.2/dist/src/am-lyrics.min.js",s.onload=()=>{typeof customElements<"u"?customElements.whenDefined("am-lyrics").then(()=>{this.componentLoaded=!0,e()}).catch(t):e()},s.onerror=()=>t(new Error("Failed to load lyrics component")),document.head.appendChild(s)})}}async fetchLyrics(e,t=null){if(t){if(this.lyricsCache.has(e))return this.lyricsCache.get(e);try{const s=Array.isArray(t.artists)?t.artists.map(o=>o.name||o).join(", "):t.artist?.name||"",a=t.title||"",i=t.album?.title||"",r=t.duration?Math.round(t.duration):null;if(!a||!s)return console.warn("Missing required fields for LRCLIB"),null;const d=new URLSearchParams({track_name:a,artist_name:s});i&&d.append("album_name",i),r&&d.append("duration",r.toString());const l=await fetch(`https://lrclib.net/api/get?${d.toString()}`);if(l.ok){const o=await l.json();if(o.syncedLyrics){const c={subtitles:o.syncedLyrics,lyricsProvider:"LRCLIB"};return this.lyricsCache.set(e,c),c}}}catch(s){console.warn("LRCLIB fetch failed:",s)}}return null}parseSyncedLyrics(e){return e?e.split(`
`).filter(s=>s.trim()).map(s=>{const a=s.match(/\[(\d+):(\d+)\.(\d+)\]\s*(.+)/);if(a){const[,i,r,d,l]=a;return{time:parseInt(i)*60+parseInt(r)+parseInt(d)/100,text:l.trim()}}return null}).filter(Boolean):[]}generateLRCContent(e,t){if(!e||!e.subtitles)return null;const s=ne(t),a=ee(t);let i=`[ti:${s}]
`;return i+=`[ar:${a}]
`,i+=`[al:${t.album?.title||"Unknown Album"}]
`,i+=`[by:${e.lyricsProvider||"Unknown"}]
`,i+=`
`,i+=e.subtitles,i}downloadLRC(e,t){const s=this.generateLRCContent(e,t);if(!s){alert("No synced lyrics available for this track");return}const a=new Blob([s],{type:"application/octet-stream"}),i=URL.createObjectURL(a),r=document.createElement("a");r.href=i,r.download=Qe(t,"LOSSLESS").replace(/\.flac$/,".lrc"),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i)}getCurrentLine(e){if(!this.syncedLyrics||this.syncedLyrics.length===0)return-1;let t=-1;for(let s=0;s<this.syncedLyrics.length&&e>=this.syncedLyrics[s].time;s++)t=s;return t}setupLyricsObserver(e){if(this.stopLyricsObserver(),!e)return;const t=e.shadowRoot||e;this.romajiObserver=new MutationObserver(s=>{s.some(i=>i.type==="childList"&&i.addedNodes.length>0?!0:i.type==="characterData"&&i.target.textContent?this.containsJapanese(i.target.textContent):!1)&&(this.observerTimeout&&clearTimeout(this.observerTimeout),this.observerTimeout=setTimeout(async()=>{await this.convertLyricsContent(e)},100))}),this.romajiObserver.observe(t,{childList:!0,subtree:!0,characterData:!0,attributes:!1}),this.isRomajiMode&&this.convertLyricsContent(e)}async convertLyricsContent(e){if(!e||!this.isRomajiMode)return;const t=e.shadowRoot||e;if(!this.kuroshiroLoaded&&!await this.loadKuroshiro()){console.warn("Cannot convert lyrics - Kuroshiro load failed");return}const s=[],a=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null,!1);let i;for(;i=a.nextNode();)s.push(i);for(const r of s){if(!r.parentElement)continue;const d=r.parentElement.tagName?.toLowerCase(),l=String(r.parentElement.className||"");if(["script","style","code","input","textarea","time"].includes(d))continue;const c=r.textContent;if(!(l.includes("progress")&&!l.includes("progress-text")||l.includes("time")&&!l.includes("progress-text")||l.includes("timestamp"))&&!(!c||c.trim().length===0)&&this.containsJapanese(c)){const m=await this.convertToRomaji(c);m&&m!==c&&(r.textContent=m)}}this.currentTrackId&&this.convertedTracksCache.add(this.currentTrackId)}stopLyricsObserver(){this.romajiObserver&&(this.romajiObserver.disconnect(),this.romajiObserver=null),this.observerTimeout&&(clearTimeout(this.observerTimeout),this.observerTimeout=null)}async toggleRomajiMode(e){return this.isRomajiMode=!this.isRomajiMode,this.setRomajiMode(this.isRomajiMode),e&&(this.isRomajiMode?(this.setupLyricsObserver(e),await this.convertLyricsContent(e)):this.stopLyricsObserver()),this.isRomajiMode}}async function je(n,e,t){const s=t||new Ht;!s.kuroshiroLoaded&&!s.kuroshiroLoading&&(s.getRomajiMode()?await s.loadKuroshiro():s.loadKuroshiro().catch(r=>{console.warn("Failed to load Kuroshiro for Romaji conversion:",r)}));const a=r=>{const d=s.getRomajiMode();s.isRomajiMode=d,r.innerHTML=`
            <button id="close-side-panel-btn" class="btn-icon" title="Close">
                ${_e}
            </button>
            <button id="romaji-toggle-btn" class="btn-icon" title="Toggle Romaji (Japanese to Latin)" data-enabled="${d}" style="color: ${d?"var(--primary)":""}">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                </svg>
            </button>
        `,r.querySelector("#close-side-panel-btn").addEventListener("click",()=>{j.close(),Me(e,j.panel)});const l=r.querySelector("#romaji-toggle-btn");if(l){const o=()=>{const c=s.isRomajiMode;l.setAttribute("data-enabled",c),l.style.color=c?"var(--primary)":""};o(),l.addEventListener("click",async()=>{const c=j.panel.querySelector("am-lyrics");c&&(await s.toggleRomajiMode(c),o())})}},i=async r=>{Me(e,j.panel),await Os(r,n,e,s)};j.open("lyrics","Lyrics",a,i)}async function Os(n,e,t,s){n.innerHTML='<div class="lyrics-loading">Loading lyrics...</div>';try{await s.ensureComponentLoaded(),s.isRomajiMode=s.getRomajiMode(),s.currentTrackId=e.id;const a=e.title,i=ee(e),r=e.album?.title,d=e.duration?Math.round(e.duration*1e3):void 0,l=e.isrc||"";n.innerHTML="";const o=document.createElement("am-lyrics");o.setAttribute("song-title",a),o.setAttribute("song-artist",i),r&&o.setAttribute("song-album",r),d&&o.setAttribute("song-duration",d),o.setAttribute("query",`${a} ${i}`.trim()),l&&o.setAttribute("isrc",l),o.setAttribute("highlight-color","#93c5fd"),o.setAttribute("hover-background-color","rgba(59, 130, 246, 0.14)"),o.setAttribute("autoscroll",""),o.setAttribute("interpolate",""),o.style.height="100%",o.style.width="100%",n.appendChild(o),s.setupLyricsObserver(o),s.isRomajiMode&&!s.kuroshiroLoaded&&await s.loadKuroshiro(),await new Promise(u=>{const h=()=>o.querySelector(".lyric-line, [class*='lyric']")||o.shadowRoot&&o.shadowRoot.querySelector("[class*='lyric']")||o.textContent&&o.textContent.length>50;if(h()){u();return}let f=0;const g=25,p=setInterval(()=>{f++,(h()||f>=g)&&(clearInterval(p),u())},200)}),s.isRomajiMode&&(await s.convertLyricsContent(o),setTimeout(()=>s.convertLyricsContent(o),500));const m=Us(e,t,o);return n.lyricsCleanup=m,n.lyricsManager=s,o}catch(a){return console.error("Failed to load lyrics:",a),n.innerHTML='<div class="lyrics-error">Failed to load lyrics</div>',null}}function Us(n,e,t){let s=0,a=performance.now(),i=null;const r=()=>{const m=e.currentTime*1e3;s=m,a=performance.now(),t.currentTime=m},d=()=>{if(!e.paused){const u=performance.now()-a,h=s+u;t.currentTime=h,i=requestAnimationFrame(d)}},l=()=>{s=e.currentTime*1e3,a=performance.now(),d()},o=()=>{i&&(cancelAnimationFrame(i),i=null)},c=m=>{m.detail&&m.detail.timestamp&&(e.currentTime=m.detail.timestamp/1e3,e.play())};return e.addEventListener("timeupdate",r),e.addEventListener("play",l),e.addEventListener("pause",o),e.addEventListener("seeked",r),t.addEventListener("line-click",c),e.paused||d(),()=>{i&&cancelAnimationFrame(i),e.removeEventListener("timeupdate",r),e.removeEventListener("play",l),e.removeEventListener("pause",o),e.removeEventListener("seeked",r),t.removeEventListener("line-click",c)}}function Me(n,e){e&&e.lyricsCleanup&&(e.lyricsCleanup(),e.lyricsCleanup=null),e&&e.lyricsManager&&e.lyricsManager.stopLyricsObserver()}class Ot{constructor(){this.dbName="MonochromeDB",this.version=6,this.db=null}async open(){return this.db?this.db:new Promise((e,t)=>{const s=indexedDB.open(this.dbName,this.version);s.onerror=a=>{console.error("Database error:",a.target.error),t(a.target.error)},s.onsuccess=a=>{this.db=a.target.result,e(this.db)},s.onupgradeneeded=a=>{const i=a.target.result;i.objectStoreNames.contains("favorites_tracks")||i.createObjectStore("favorites_tracks",{keyPath:"id"}).createIndex("addedAt","addedAt",{unique:!1}),i.objectStoreNames.contains("favorites_albums")||i.createObjectStore("favorites_albums",{keyPath:"id"}).createIndex("addedAt","addedAt",{unique:!1}),i.objectStoreNames.contains("favorites_artists")||i.createObjectStore("favorites_artists",{keyPath:"id"}).createIndex("addedAt","addedAt",{unique:!1}),i.objectStoreNames.contains("favorites_playlists")||i.createObjectStore("favorites_playlists",{keyPath:"uuid"}).createIndex("addedAt","addedAt",{unique:!1}),i.objectStoreNames.contains("favorites_mixes")||i.createObjectStore("favorites_mixes",{keyPath:"id"}).createIndex("addedAt","addedAt",{unique:!1}),i.objectStoreNames.contains("history_tracks")||i.createObjectStore("history_tracks",{keyPath:"timestamp"}).createIndex("timestamp","timestamp",{unique:!0}),i.objectStoreNames.contains("user_playlists")||i.createObjectStore("user_playlists",{keyPath:"id"}).createIndex("createdAt","createdAt",{unique:!1}),i.objectStoreNames.contains("settings")||i.createObjectStore("settings")}})}async performTransaction(e,t,s){const a=await this.open();return new Promise((i,r)=>{const d=a.transaction(e,t),l=d.objectStore(e),o=s(l);d.oncomplete=()=>{i(o?.result)},d.onerror=c=>{r(c.target.error)}})}async addToHistory(e){const t="history_tracks",a={...this._minifyItem("track",e),timestamp:Date.now()};return(await this.open()).transaction(t,"readwrite").objectStore(t).put(a),a}async getHistory(){const e="history_tracks",t=await this.open();return new Promise((s,a)=>{const l=t.transaction(e,"readonly").objectStore(e).index("timestamp").getAll();l.onsuccess=()=>{s(l.result.reverse())},l.onerror=()=>a(l.error)})}async toggleFavorite(e,t){const a=`favorites_${e==="mix"?"mixes":`${e}s`}`,i=e==="playlist"?t.uuid:t.id;if(await this.isFavorite(e,i))return await this.performTransaction(a,"readwrite",d=>d.delete(i)),!1;{const l={...this._minifyItem(e,t),addedAt:Date.now()};return await this.performTransaction(a,"readwrite",o=>o.put(l)),!0}}async isFavorite(e,t){const a=`favorites_${e==="mix"?"mixes":`${e}s`}`;try{return!!await this.performTransaction(a,"readonly",r=>r.get(t))}catch{return!1}}async getFavorites(e){const s=`favorites_${e==="mix"?"mixes":`${e}s`}`,a=await this.open();return new Promise((i,r)=>{const c=a.transaction(s,"readonly").objectStore(s).index("addedAt").getAll();c.onsuccess=()=>{i(c.result.reverse())},c.onerror=()=>r(c.error)})}_minifyItem(e,t){if(!t)return t;const s={id:t.id,addedAt:t.addedAt||null};return e==="track"?{...s,title:t.title||null,duration:t.duration||null,explicit:t.explicit||!1,artist:t.artist||(t.artists&&t.artists.length>0?t.artists[0]:null)||null,artists:t.artists?.map(a=>({id:a.id,name:a.name||null}))||[],album:t.album?{id:t.album.id,title:t.album.title||null,cover:t.album.cover||null,releaseDate:t.album.releaseDate||null,vibrantColor:t.album.vibrantColor||null,artist:t.album.artist||null,numberOfTracks:t.album.numberOfTracks||null}:null,copyright:t.copyright||null,isrc:t.isrc||null,trackNumber:t.trackNumber||null,streamStartDate:t.streamStartDate||null,version:t.version||null,mixes:t.mixes||null}:e==="album"?{...s,title:t.title||null,cover:t.cover||null,releaseDate:t.releaseDate||null,explicit:t.explicit||!1,artist:t.artist?{name:t.artist.name||null,id:t.artist.id}:t.artists?.[0]?{name:t.artists[0].name||null,id:t.artists[0].id}:null,type:t.type||null,numberOfTracks:t.numberOfTracks||null}:e==="artist"?{...s,name:t.name||null,picture:t.picture||t.image||null}:e==="playlist"?{uuid:t.uuid||t.id,addedAt:t.addedAt||t.createdAt||null,title:t.title||t.name||null,image:t.image||t.squareImage||t.cover||null,numberOfTracks:t.numberOfTracks||(t.tracks?t.tracks.length:0),user:t.user?{name:t.user.name||null}:null}:e==="mix"?{id:t.id,addedAt:t.addedAt,title:t.title,subTitle:t.subTitle,description:t.description,mixType:t.mixType,cover:t.cover}:t}async exportData(){const e=await this.getFavorites("track"),t=await this.getFavorites("album"),s=await this.getFavorites("artist"),a=await this.getFavorites("playlist"),i=await this.getFavorites("mix"),r=await this.getHistory(),d=await this.getPlaylists(!0);return{favorites_tracks:e.map(o=>this._minifyItem("track",o)),favorites_albums:t.map(o=>this._minifyItem("album",o)),favorites_artists:s.map(o=>this._minifyItem("artist",o)),favorites_playlists:a.map(o=>this._minifyItem("playlist",o)),favorites_mixes:i.map(o=>this._minifyItem("mix",o)),history_tracks:r.map(o=>this._minifyItem("track",o)),user_playlists:d}}async importData(e,t=!1){const s=await this.open(),a=async(r,d)=>{if(d===void 0)return!1;let l=Array.isArray(d)?d:Object.values(d||{});return l.length===0?t?new Promise(o=>{const m=s.transaction(r,"readwrite").objectStore(r),u=m.count();u.onsuccess=()=>{u.result>0?(m.clear(),o(!0)):o(!1)},u.onerror=()=>o(!1)}):!1:new Promise((o,c)=>{const m=s.transaction(r,"readwrite"),u=m.objectStore(r);let h=!1;t&&(u.clear(),h=!0);let f=l.length;l.forEach(g=>{if(t){u.put(g),f--,f===0&&o(!0);return}let p;r==="favorites_playlists"?p=g.uuid:r==="history_tracks"?p=g.timestamp:p=g.id;const w=u.get(p);w.onsuccess=()=>{const I=w.result;(!I||JSON.stringify(I)!==JSON.stringify(g))&&(u.put(g),h=!0),f--,f===0&&o(h)},w.onerror=()=>{u.put(g),h=!0,f--,f===0&&o(h)}}),m.onerror=()=>c(m.error)})};return(await Promise.all([a("favorites_tracks",e.favorites_tracks),a("favorites_albums",e.favorites_albums),a("favorites_artists",e.favorites_artists),a("favorites_playlists",e.favorites_playlists),a("favorites_mixes",e.favorites_mixes),a("history_tracks",e.history_tracks),e.user_playlists?a("user_playlists",e.user_playlists):Promise.resolve(!1)])).some(r=>r)}_updatePlaylistMetadata(e){if(e.numberOfTracks=e.tracks?e.tracks.length:0,!e.cover){const t=[],s=new Set,a=e.tracks||[];for(const i of a){const r=i.album?.cover;if(r&&!s.has(r)&&(s.add(r),t.push(r),t.length>=4))break}e.images=t}return e}async createPlaylist(e,t=[],s=""){const i={id:crypto.randomUUID(),name:e,tracks:t.map(r=>this._minifyItem("track",r)),cover:s,createdAt:Date.now(),updatedAt:Date.now()};return this._updatePlaylistMetadata(i),await this.performTransaction("user_playlists","readwrite",r=>r.put(i)),i}async addTrackToPlaylist(e,t){const s=await this.performTransaction("user_playlists","readonly",i=>i.get(e));if(!s)throw new Error("Playlist not found");s.tracks=s.tracks||[];const a=this._minifyItem("track",t);if(!s.tracks.some(i=>i.id===t.id))return s.tracks.push(a),s.updatedAt=Date.now(),this._updatePlaylistMetadata(s),await this.performTransaction("user_playlists","readwrite",i=>i.put(s)),s}async removeTrackFromPlaylist(e,t){const s=await this.performTransaction("user_playlists","readonly",a=>a.get(e));if(!s)throw new Error("Playlist not found");return s.tracks=s.tracks||[],s.tracks=s.tracks.filter(a=>a.id!==t),s.updatedAt=Date.now(),this._updatePlaylistMetadata(s),await this.performTransaction("user_playlists","readwrite",a=>a.put(s)),s}async deletePlaylist(e){await this.performTransaction("user_playlists","readwrite",t=>t.delete(e))}async getPlaylist(e){return await this.performTransaction("user_playlists","readonly",t=>t.get(e))}async getPlaylists(e=!1){const t=await this.open();return new Promise((s,a)=>{const r=t.transaction("user_playlists","readwrite").objectStore("user_playlists"),l=r.index("createdAt").getAll();l.onsuccess=()=>{const c=l.result.reverse().map(m=>{let u=!1;if(typeof m.numberOfTracks>"u"&&(m.numberOfTracks=m.tracks?m.tracks.length:0,u=!0),!m.cover&&(!m.images||m.images.length===0)&&(this._updatePlaylistMetadata(m),u=!0),u)try{r.put(m)}catch(g){console.warn("Failed to update playlist metadata",g)}if(e)return m;const{tracks:h,...f}=m;return f});s(c)},l.onerror=()=>a(l.error)})}async updatePlaylistName(e,t){const s=await this.performTransaction("user_playlists","readonly",a=>a.get(e));if(!s)throw new Error("Playlist not found");return s.name=t,s.updatedAt=Date.now(),await this.performTransaction("user_playlists","readwrite",a=>a.put(s)),s}async updatePlaylistTracks(e,t){const s=await this.open();return new Promise((a,i)=>{const r=s.transaction("user_playlists","readwrite"),d=r.objectStore("user_playlists"),l=d.get(e);l.onsuccess=()=>{const o=l.result;if(!o){i(new Error("Playlist not found"));return}o.tracks=t,o.updatedAt=Date.now(),this._updatePlaylistMetadata(o);const c=d.put(o);c.onsuccess=()=>{a(o)},c.onerror=()=>{i(c.error)}},l.onerror=()=>{i(l.error)},r.onerror=o=>{i(o.target.error)}})}async saveSetting(e,t){await this.performTransaction("settings","readwrite",s=>s.put(t,e))}async getSetting(e){return await this.performTransaction("settings","readonly",t=>t.get(e))}}const M=new Ot,be=Object.freeze(Object.defineProperty({__proto__:null,MusicDatabase:Ot,db:M},Symbol.toStringTag,{value:"Module"}));function kt(n,e,t){n/=255,e/=255,t/=255;const s=Math.max(n,e,t),a=Math.min(n,e,t);let i,r,d=(s+a)/2;if(s===a)i=r=0;else{const l=s-a;switch(r=d>.5?l/(2-s-a):l/(s+a),s){case n:i=(e-t)/l+(e<t?6:0);break;case e:i=(t-n)/l+2;break;case t:i=(n-e)/l+4;break}i/=6}return[i,r,d]}function Ns(n,e,t){let s,a,i;if(e===0)s=a=i=t;else{const d=(c,m,u)=>(u<0&&(u+=1),u>1&&(u-=1),u<.16666666666666666?c+(m-c)*6*u:u<.5?m:u<.6666666666666666?c+(m-c)*(.6666666666666666-u)*6:c),l=t<.5?t*(1+e):t+e-t*e,o=2*t-l;s=d(o,l,n+1/3),a=d(o,l,n),i=d(o,l,n-1/3)}const r=d=>{const l=Math.round(d*255).toString(16);return l.length===1?"0"+l:l};return`#${r(s)}${r(a)}${r(i)}`}function js(n){const e=document.createElement("canvas"),t=e.getContext("2d");if(!t)return null;const s=64;let a=n.naturalWidth||n.width,i=n.naturalHeight||n.height;if(a>s||i>s){const c=Math.min(s/a,s/i);a=Math.floor(a*c),i=Math.floor(i*c)}e.width=a,e.height=i,t.drawImage(n,0,0,a,i);const d=t.getImageData(0,0,a,i).data,l=[];for(let c=0;c<d.length;c+=4){const m=d[c],u=d[c+1],h=d[c+2];if(d[c+3]<125)continue;const[g,p,w]=kt(m,u,h);p>=.3&&w>=.3&&w<=.8&&l.push({r:m,g:u,b:h,h:g,s:p,l:w})}if(l.length===0)for(let c=0;c<d.length;c+=4){const m=d[c],u=d[c+1],h=d[c+2];if(d[c+3]<125)continue;const[g,p,w]=kt(m,u,h);w>.1&&w<.95&&l.push({r:m,g:u,b:h,h:g,s:p,l:w})}if(l.length===0)return null;l.sort((c,m)=>m.s-c.s||.5-Math.abs(c.l-.5)-(.5-Math.abs(m.l-.5)));const o=l[0];return Ns(o.h,o.s,o.l)}let tt=null,X=null,ue=null,Ut=null;const Be="monochrome-firebase-config",qs={apiKey:"AIzaSyC9WVHW3mBLbRWjRvbVfV4lyqVq2HgPm0U",authDomain:"hyadamusic.firebaseapp.com",databaseURL:"https://hyadamusic-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"hyadamusic",storageBucket:"hyadamusic.firebasestorage.app",messagingSenderId:"145659331714",appId:"1:145659331714:web:29fb7f28e0b4996b0fa09b",measurementId:"G-XB56KPW0Y0"};function Qs(){try{const n=localStorage.getItem(Be);return n?JSON.parse(n):null}catch(n){return console.warn("Failed to parse Firebase config from storage",n),null}}const Nt=Qs(),Tt=Nt||qs;if(Tt)try{tt=Jt(Tt),X=Xt(tt),ue=is(tt),Ut=new Zt,console.log("Firebase initialized from "+(Nt?"saved":"default")+" config")}catch(n){console.error("Error initializing Firebase:",n)}else console.log("No Firebase config found.");function jt(n){n&&localStorage.setItem(Be,JSON.stringify(n))}function zs(){localStorage.removeItem(Be)}function Ks(n){if(!n)return null;try{const e=JSON.stringify(n),t=btoa(e),s=new URL(window.location.href);return s.hash=`#setup_firebase=${t}`,s.toString()}catch(e){return console.error("Failed to generate share link:",e),null}}function Ws(){const n=window.location.hash;if(!n.startsWith("#setup_firebase="))return!1;const e=n.split("#setup_firebase=")[1];if(!e)return!1;try{const t=atob(e),s=JSON.parse(t);if(!s.apiKey||!s.authDomain)return alert("The shared configuration link appears to be invalid."),!1;if(confirm("A Firebase configuration was detected in the link. Do you want to import it and enable Sync?"))return jt(s),window.history.replaceState(null,null,window.location.pathname),alert("Configuration imported successfully! The app will now reload."),window.location.reload(),!0;window.history.replaceState(null,null,window.location.pathname+"#settings")}catch(t){console.error("Failed to parse shared config:",t),alert("Failed to read configuration from link. The link might be corrupted.")}return!1}function Vs(){Ws();const n=document.getElementById("firebase-config-input"),e=document.getElementById("save-firebase-config-btn"),t=document.getElementById("clear-firebase-config-btn"),s=document.getElementById("share-firebase-config-btn"),a=document.getElementById("toggle-firebase-config-btn"),i=document.getElementById("custom-firebase-config-container");if(a&&i&&a.addEventListener("click",()=>{i.classList.contains("visible")?(i.classList.remove("visible"),a.textContent="Custom Configuration"):(i.classList.add("visible"),a.textContent="Hide Custom Configuration")}),n){const r=localStorage.getItem(Be);if(r)try{n.value=JSON.stringify(JSON.parse(r),null,2),i&&a&&(i.classList.add("visible"),a.textContent="Hide Custom Configuration")}catch{n.value=r}}s&&s.addEventListener("click",()=>{const r=localStorage.getItem(Be);if(!r){alert("No configuration saved to share.");return}try{const d=JSON.parse(r),l=Ks(d);l&&navigator.clipboard.writeText(l).then(()=>{alert("Magic Link copied to clipboard! Send it to your other device.")}).catch(o=>{console.error("Clipboard error:",o),prompt("Copy this link:",l)})}catch{alert("Invalid configuration found.")}}),e&&e.addEventListener("click",()=>{const r=n.value.trim();if(!r){alert("Please enter a valid configuration.");return}try{let d=r;d.includes("=")&&(d=d.substring(d.indexOf("=")+1)),d=d.trim(),d.endsWith(";")&&(d=d.slice(0,-1));const l=d.replace(/([{,]\s*)([a-zA-Z0-9_]+)\s*:/g,'$1"$2":').replace(/:\s*'([^']*)'/g,': "$1"').replace(/,\s*([}\]])/g,"$1"),o=JSON.parse(l);jt(o),alert("Configuration saved. Reloading..."),window.location.reload()}catch(d){console.error("Invalid Config:",d),alert("Could not parse configuration. Please ensure it looks like a valid JSON or JS object.")}}),t&&t.addEventListener("click",()=>{confirm("Are you sure you want to remove the custom configuration? The app will revert to the shared default database.")&&(zs(),window.location.reload())})}class qt{constructor(){this.user=null,this.userRef=null,this.unsubscribeFunctions=[],this.isSyncing=!1,this.listenersSetup=!1}initialize(e){!ue||!e||(this.user=e,this.userRef=De(ue,`users/${e.uid}`),console.log("Initializing SyncManager for user:",e.uid),this.performInitialSync())}disconnect(){this.userRef&&(this.unsubscribeFunctions.forEach(e=>e()),this.unsubscribeFunctions=[]),this.user=null,this.userRef=null,this.listenersSetup=!1,console.log("SyncManager disconnected")}async performInitialSync(){if(!this.isSyncing){this.isSyncing=!0;try{console.log("Starting initial sync...");const t=(await ft(this.userRef)).val()||{},s=await M.exportData();if(s.user_playlists&&Array.isArray(s.user_playlists)){const r=t.user_playlists||{};s.user_playlists=s.user_playlists.filter(d=>{const l=r[d.id];return!l||!l.deleted})}const a=this.mergeData(s,t);await Ye(this.userRef,a);const i={favorites_tracks:a.library?.tracks?Object.values(a.library.tracks):[],favorites_albums:a.library?.albums?Object.values(a.library.albums):[],favorites_artists:a.library?.artists?Object.values(a.library.artists):[],favorites_playlists:a.library?.playlists?Object.values(a.library.playlists):[],history_tracks:a.history?.recentTracks?Object.values(a.history.recentTracks):[],user_playlists:a.user_playlists?Object.values(a.user_playlists):[]};await M.importData(i,!0),console.log("Initial sync complete.")}catch(e){console.error("Initial sync failed:",e)}finally{this.setupListeners(),this.isSyncing=!1}}}mergeData(e,t){const s=(i,r,d="id")=>{const l=new Map;if(Array.isArray(i)?i.forEach(o=>l.set(o[d],o)):i&&typeof i=="object"&&Object.values(i).forEach(o=>l.set(o[d],o)),r){const o=(c,m)=>{if(!c||typeof c!="object")return;c.tracks&&typeof c.tracks=="object"&&!Array.isArray(c.tracks)&&(c.tracks=Object.values(c.tracks));const u=c[d]||m,h=l.get(u);if(c.deleted)l.delete(u);else if(h){const f=h.updatedAt||0,g=c.updatedAt||0;if(g>f){const p=Array.isArray(h.tracks)?h.tracks.length:0,w=Array.isArray(c.tracks)?c.tracks.length:0;p>0&&w===0||l.set(u,c)}else if(g===f){const p=Array.isArray(h.tracks)?h.tracks.length:0;(Array.isArray(c.tracks)?c.tracks.length:0)>=p&&l.set(u,c)}}else l.set(u,c)};Array.isArray(r)?r.forEach(c=>o(c)):Object.keys(r).forEach(c=>{const m=r[c];typeof m=="object"&&o(m,c)})}return Array.from(l.values())};return{library:{tracks:this.arrayToObject(s(e.favorites_tracks,t.library?.tracks),"id"),albums:this.arrayToObject(s(e.favorites_albums,t.library?.albums),"id"),artists:this.arrayToObject(s(e.favorites_artists,t.library?.artists),"id"),playlists:this.arrayToObject(s(e.favorites_playlists,t.library?.playlists,"uuid"),"uuid")},history:{recentTracks:this.arrayToObject(s(e.history_tracks,t.history?.recentTracks,"timestamp"),"timestamp")},user_playlists:this.arrayToObject(s(e.user_playlists,t.user_playlists),"id"),lastUpdated:Date.now()}}arrayToObject(e,t){const s={};return e.forEach(a=>{a&&a[t]&&(s[a[t]]=a)}),s}setupListeners(){if(!this.userRef||this.listenersSetup)return;this.listenersSetup=!0;const e=(o,c)=>{const m=fe(this.userRef,`library/${o}`),u=w=>{if(this.isSyncing)return;const I=w.val();if(I){const y={};y[c]=[I],M.importData(y,!1).then(b=>{b&&window.dispatchEvent(new Event("library-changed"))})}},h=w=>{if(this.isSyncing)return;const I=w.key;I&&M.performTransaction(c,"readwrite",y=>y.delete(I)).then(()=>{window.dispatchEvent(new Event("library-changed"))})},f=Je(m,u),g=gt(m,u),p=pt(m,h);this.unsubscribeFunctions.push(()=>de(m,"child_added",f)),this.unsubscribeFunctions.push(()=>de(m,"child_changed",g)),this.unsubscribeFunctions.push(()=>de(m,"child_removed",p))};e("tracks","favorites_tracks"),e("albums","favorites_albums"),e("artists","favorites_artists"),e("playlists","favorites_playlists");const t=fe(this.userRef,"history/recentTracks"),s=Je(t,o=>{if(this.isSyncing)return;const c=o.val();c&&M.importData({history_tracks:[c]},!1).then(m=>{m&&window.dispatchEvent(new Event("history-changed"))})});this.unsubscribeFunctions.push(()=>de(t,"child_added",s));const a=fe(this.userRef,"user_playlists"),i=o=>{if(this.isSyncing)return;const c=o.val();if(c&&c.deleted){M.deletePlaylist(c.id).then(()=>{window.dispatchEvent(new Event("library-changed"))});return}if(c){c.tracks&&typeof c.tracks=="object"&&!Array.isArray(c.tracks)&&(c.tracks=Object.values(c.tracks));const m={user_playlists:[c]};M.importData(m,!1).then(u=>{u&&window.dispatchEvent(new Event("library-changed"))})}},r=Je(a,i),d=gt(a,i),l=pt(a,o=>{if(this.isSyncing)return;const c=o.key;c&&M.deletePlaylist(c).then(()=>{window.dispatchEvent(new Event("library-changed"))})});this.unsubscribeFunctions.push(()=>{de(a,"child_added",r),de(a,"child_changed",d),de(a,"child_removed",l)})}async syncLibraryItem(e,t,s){if(!this.user||!this.userRef)return;const i={track:"tracks",album:"albums",artist:"artists",playlist:"playlists"}[e];if(!i)return;const r=e==="playlist"?t.uuid:t.id,d=`library/${i}/${r}`,l=fe(this.userRef,d);if(s){const o=M._minifyItem(e,t),c={...o,addedAt:t.addedAt||o.addedAt||Date.now()};await Fe(l,this.sanitizeForFirebase(c))}else await Xe(l)}async syncHistoryItem(e){if(!this.user||!this.userRef||!e.timestamp)return;const t=fe(this.userRef,`history/recentTracks/${e.timestamp}`);try{await Fe(t,this.sanitizeForFirebase(e));const s=await M.getHistory();if(s.length>50){const a=s.slice(50),i={};a.forEach(r=>{i[`history/recentTracks/${r.timestamp}`]=null}),await Ye(this.userRef,i)}}catch(s){console.error("Failed to sync history item:",s)}}async syncUserPlaylist(e,t){if(!this.user||!this.userRef)return;const a=`user_playlists/${e.id}`,i=fe(this.userRef,a);if(t==="create"||t==="update"){const r={...e,updatedAt:Date.now()};await Fe(i,this.sanitizeForFirebase(r))}else t==="delete"&&await Ye(i,{deleted:!0,updatedAt:Date.now()})}async clearCloudData(){if(!this.user||!this.userRef)throw new Error("Not authenticated");await Xe(this.userRef)}async publishPlaylist(e){if(!this.user)throw new Error("Not authenticated");const t=M._minifyItem("playlist",e),s=e.id||e.uuid;if(!s)throw new Error("Invalid playlist ID");const a={...t,uid:this.user.uid,originalId:s,publishedAt:Date.now(),tracks:e.tracks?e.tracks.map(r=>M._minifyItem("track",r)):[]},i=De(ue,`public_playlists/${s}`);await Fe(i,this.sanitizeForFirebase(a))}async unpublishPlaylist(e){if(!this.user)throw new Error("Not authenticated");const t=De(ue,`public_playlists/${e}`);await Xe(t)}async getPublicPlaylist(e){if(!ue)return console.warn("[Sync] Database not initialized, cannot fetch public playlist"),null;try{const t=De(ue,`public_playlists/${e}`),s=await ft(t);if(!s.exists())return console.warn(`[Sync] Public playlist ${e} not found in database.`),null;const a=s.val();return console.log(`[Sync] Public playlist fetch for ${e}: Found`),a}catch(t){return console.error("[Sync] Failed to fetch public playlist:",t),null}}sanitizeForFirebase(e){if(e===void 0||e===null)return null;if(typeof e!="object")return e;if(Array.isArray(e))return e.map(s=>this.sanitizeForFirebase(s));const t={};for(const s in e)if(Object.prototype.hasOwnProperty.call(e,s)){const a=this.sanitizeForFirebase(e[s]);a!==void 0&&(t[s]=a)}return t}}const U=new qt,st=Object.freeze(Object.defineProperty({__proto__:null,SyncManager:qt,syncManager:U},Symbol.toStringTag,{value:"Module"}));class Gs{constructor(e,t){this.api=e,this.player=t,this.currentTrack=null,this.searchAbortController=null,this.vibrantColorCache=new Map}createHeartIcon(e=!1){return e?ie.replace('class="heart-icon"','class="heart-icon filled"'):ie}async extractAndApplyColor(e){if(!we.isEnabled()||!e){this.resetVibrantColor();return}if(this.vibrantColorCache.has(e)){const a=this.vibrantColorCache.get(e);if(a){this.setVibrantColor(a);return}}const t=new Image;t.crossOrigin="Anonymous";const s=e.includes("?")?"&":"?";t.src=`${e}${s}not-from-cache-please`,t.onload=()=>{try{const a=js(t);a?(this.vibrantColorCache.set(e,a),this.setVibrantColor(a)):(this.vibrantColorCache.set(e,null),this.resetVibrantColor())}catch{this.vibrantColorCache.set(e,null),this.resetVibrantColor()}},t.onerror=()=>{this.vibrantColorCache.set(e,null),this.resetVibrantColor()}}async updateLikeState(e,t,s){const a=await M.isFavorite(t,s),i=e.querySelector(".like-btn");i&&(i.innerHTML=this.createHeartIcon(a),i.classList.toggle("active",a),i.title=a?"Remove from Liked":"Add to Liked")}setCurrentTrack(e){this.currentTrack=e,this.updateGlobalTheme();const t=document.getElementById("now-playing-like-btn"),s=document.getElementById("now-playing-add-playlist-btn"),a=document.getElementById("mobile-add-playlist-btn"),i=document.getElementById("toggle-lyrics-btn");if(e){const r=e.isLocal;t&&(r?t.style.display="none":(t.style.display="flex",this.updateLikeState(t.parentElement,"track",e.id))),s&&(r?s.style.setProperty("display","none","important"):s.style.removeProperty("display")),a&&(r?a.style.setProperty("display","none","important"):a.style.removeProperty("display")),i&&(r?i.style.display="none":i.style.removeProperty("display"))}else t&&(t.style.display="none"),s&&s.style.setProperty("display","none","important"),a&&a.style.setProperty("display","none","important"),i&&(i.style.display="none")}updateGlobalTheme(){document.getElementById("page-album").classList.contains("active")||(we.isEnabled()&&this.currentTrack?.album?.cover?this.extractAndApplyColor(this.api.getCoverUrl(this.currentTrack.album.cover,"80")):this.resetVibrantColor())}createExplicitBadge(){return'<span class="explicit-badge" title="Explicit">E</span>'}adjustTitleFontSize(e,t){e.classList.remove("long-title","very-long-title"),t.length>40?e.classList.add("very-long-title"):t.length>25&&e.classList.add("long-title")}createTrackItemHTML(e,t,s=!1,a=!1){const i=s?`<img src="${this.api.getCoverUrl(e.album?.cover)}" alt="Track Cover" class="track-item-cover" loading="lazy">`:"";let r;a&&!s?r=`${e.volumeNumber??e.discNumber??1}-${e.trackNumber}`:r=t+1;const d=`<div class="track-number">${s?i:r}</div>`,l=Ze(e)?this.createExplicitBadge():"",o=ee(e),c=ne(e),m=this.player?.currentTrack?.id===e.id;e.isLocal&&(s=!1);let u="";const h=e.album?.releaseDate||e.streamStartDate;if(h){const g=new Date(h);isNaN(g.getTime())||(u=` • ${g.getFullYear()}`)}const f=`
            <div class="track-actions-inline">
                <button class="track-action-btn like-btn" data-action="toggle-like" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
                <button class="track-action-btn" data-action="play-next" title="Play Next">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 6h6" />
                        <path d="M5 3v6" />
                        <path d="M11 6h10" />
                        <path d="M3 12h18" />
                        <path d="M3 18h18" />
                    </svg>
                </button>
                <button class="track-action-btn" data-action="add-to-queue" title="Add to Queue">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18" />
                        <path d="M3 12h18" />
                        <path d="M3 18h10" />
                        <path d="M16 18h6" />
                        <path d="M19 15v6" />
                    </svg>
                </button>
                <button class="track-action-btn" data-action="download" title="Download" ${e.isLocal?'style="display:none"':""}>
                    ${pe}
                </button>
            </div>
            <button class="track-menu-btn" type="button" title="More options" ${e.isLocal?'style="display:none"':""}>
                ${us}
            </button>
        `;return`
            <div class="track-item ${m?"playing":""}" data-track-id="${e.id}" ${e.isLocal?'data-is-local="true"':""}>
                ${d}
                <div class="track-item-info">
                    <div class="track-item-details">
                        <div class="title">
                            ${Y(c)}
                            ${l}
                        </div>
                        <div class="artist">${Y(o)}${u}</div>
                    </div>
                </div>
                <div class="track-item-duration">${e.duration?xe(e.duration):"--:--"}</div>
                <div class="track-item-actions">
                    ${f}
                </div>
            </div>
        `}createBaseCardHTML({type:e,id:t,href:s,title:a,subtitle:i,imageHTML:r,actionButtonsHTML:d,isCompact:l,extraClasses:o=""}){const c=e!=="artist"?`
            <button class="play-btn card-play-btn" data-action="play-card" data-type="${e}" data-id="${t}" title="Play">
                ${he}
            </button>
        `:"",m=e==="artist"?`<h4 class="card-title">${a}</h4>`:`<div class="card-info">
                    <h4 class="card-title">${a}</h4>
                    <p class="card-subtitle">${i}</p>
               </div>`;return`
            <div class="card ${o} ${l?"compact":""}" data-${e}-id="${t}" data-href="${s}" style="cursor: pointer;">
                <div class="card-image-wrapper">
                    ${r}
                    ${d}
                    ${l?"":c}
                </div>
                ${m}
                ${l?c:""}
            </div>
        `}createPlaylistCardHTML(e){const t=e.squareImage||e.image||e.uuid,s=se.isCompactAlbum();return this.createBaseCardHTML({type:"playlist",id:e.uuid,href:`#playlist/${e.uuid}`,title:e.title,subtitle:`${e.numberOfTracks||0} tracks`,imageHTML:`<img src="${this.api.getCoverUrl(t)}" alt="${e.title}" class="card-image" loading="lazy">`,actionButtonsHTML:`
                <button class="like-btn card-like-btn" data-action="toggle-like" data-type="playlist" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
            `,isCompact:s})}createMixCardHTML(e){const t=e.cover||"assets/appicon.png",s=e.subTitle||e.description||"",a=se.isCompactAlbum();return this.createBaseCardHTML({type:"mix",id:e.id,href:`#mix/${e.id}`,title:e.title,subtitle:s,imageHTML:`<img src="${t}" alt="${e.title}" class="card-image" loading="lazy">`,actionButtonsHTML:`
                <button class="like-btn card-like-btn" data-action="toggle-like" data-type="mix" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
            `,isCompact:a})}createUserPlaylistCardHTML(e){let t="";if(e.cover)t=`<img src="${e.cover}" alt="${e.name}" class="card-image" loading="lazy">`;else{const a=e.tracks||[];let i=e.images||[];const r=new Set(i);if(i.length===0)for(const d of a){const l=d.album?.cover;if(l&&!r.has(l)&&(r.add(l),i.push(l),i.length>=4))break}if(i.length>=2){const d=Math.min(i.length,4),l=d<4?`items-${d}`:"",o=i.slice(0,4);t=`
                    <div class="card-image card-collage ${l}">
                        ${o.map(c=>`<img src="${this.api.getCoverUrl(c)}" alt="" loading="lazy">`).join("")}
                    </div>
                `}else i.length>0?t=`<img src="${this.api.getCoverUrl(i[0])}" alt="${e.name}" class="card-image" loading="lazy">`:t=`<img src="assets/appicon.png" alt="${e.name}" class="card-image" loading="lazy">`}const s=se.isCompactAlbum();return this.createBaseCardHTML({type:"user-playlist",id:e.id,href:`#userplaylist/${e.id}`,title:Y(e.name),subtitle:`${e.tracks?e.tracks.length:e.numberOfTracks||0} tracks`,imageHTML:t,actionButtonsHTML:`
                <button class="edit-playlist-btn" data-action="edit-playlist" title="Edit Playlist">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                </button>
                <button class="delete-playlist-btn" data-action="delete-playlist" title="Delete Playlist">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18"/>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/>
                        <line x1="14" y1="11" x2="14" y2="17"/>
                    </svg>
                </button>
            `,isCompact:s,extraClasses:"user-playlist"})}createAlbumCardHTML(e){const t=Ze(e)?this.createExplicitBadge():"";let s="";if(e.releaseDate){const r=new Date(e.releaseDate);isNaN(r.getTime())||(s=`${r.getFullYear()}`)}let a="";e.type==="EP"?a=" • EP":e.type==="SINGLE"&&(a=" • Single");const i=se.isCompactAlbum();return this.createBaseCardHTML({type:"album",id:e.id,href:`#album/${e.id}`,title:`${Y(e.title)} ${t}`,subtitle:`${Y(e.artist?.name??"")} • ${s}${a}`,imageHTML:`<img src="${this.api.getCoverUrl(e.cover)}" alt="${Y(e.title)}" class="card-image" loading="lazy">`,actionButtonsHTML:`
                <button class="like-btn card-like-btn" data-action="toggle-like" data-type="album" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
            `,isCompact:i})}createArtistCardHTML(e){const t=se.isCompactArtist();return this.createBaseCardHTML({type:"artist",id:e.id,href:`#artist/${e.id}`,title:Y(e.name),subtitle:"",imageHTML:`<img src="${this.api.getArtistPictureUrl(e.picture)}" alt="${Y(e.name)}" class="card-image" loading="lazy">`,actionButtonsHTML:`
                <button class="like-btn card-like-btn" data-action="toggle-like" data-type="artist" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
            `,isCompact:t,extraClasses:"artist"})}createSkeletonTrack(e=!1){return`
            <div class="skeleton-track">
                ${e?'<div class="skeleton skeleton-track-cover"></div>':'<div class="skeleton skeleton-track-number"></div>'}
                <div class="skeleton-track-info">
                    <div class="skeleton-track-details">
                        <div class="skeleton skeleton-track-title"></div>
                        <div class="skeleton skeleton-track-artist"></div>
                    </div>
                </div>
                <div class="skeleton skeleton-track-duration"></div>
            </div>
        `}createSkeletonCard(e=!1){return`
            <div class="skeleton-card ${e?"artist":""}">
                <div class="skeleton skeleton-card-image"></div>
                <div class="skeleton skeleton-card-title"></div>
                ${e?"":'<div class="skeleton skeleton-card-subtitle"></div>'}
            </div>
        `}createSkeletonTracks(e=5,t=!1){return`<div class="skeleton-container">${Array(e).fill(0).map(()=>this.createSkeletonTrack(t)).join("")}</div>`}createSkeletonCards(e=6,t=!1){return`<div class="card-grid">${Array(e).fill(0).map(()=>this.createSkeletonCard(t)).join("")}</div>`}renderListWithTracks(e,t,s){const a=document.createDocumentFragment(),i=document.createElement("div"),r=t.some(d=>(d.volumeNumber||d.discNumber||1)>1);for(i.innerHTML=t.map((d,l)=>this.createTrackItemHTML(d,l,s,r)).join("");i.firstChild;)a.appendChild(i.firstChild);e.innerHTML="",e.appendChild(a),t.forEach(d=>{const l=e.querySelector(`[data-track-id="${d.id}"]`);l&&(H.set(l,d),this.updateLikeState(l,"track",d.id))})}setPageBackground(e){const t=document.getElementById("page-background");we.isEnabled()&&e?(t.style.backgroundImage=`url('${e}')`,t.classList.add("active"),document.body.classList.add("has-page-background")):(t.classList.remove("active"),document.body.classList.remove("has-page-background"),setTimeout(()=>{t.classList.contains("active")||(t.style.backgroundImage="")},500))}setVibrantColor(e){if(!e)return;const t=document.documentElement,a=t.getAttribute("data-theme")==="light";let i=e.replace("#","");i.length===3&&(i=i.split("").map(h=>h+h).join(""));let r=parseInt(i.substr(0,2),16),d=parseInt(i.substr(2,2),16),l=parseInt(i.substr(4,2),16),o=(r*299+d*587+l*114)/1e3;if(a)for(;o>150;)r=Math.floor(r*.9),d=Math.floor(d*.9),l=Math.floor(l*.9),o=(r*299+d*587+l*114)/1e3;else for(;o<80&&(r=Math.min(255,Math.max(r+1,Math.floor(r*1.15))),d=Math.min(255,Math.max(d+1,Math.floor(d*1.15))),l=Math.min(255,Math.max(l+1,Math.floor(l*1.15))),o=(r*299+d*587+l*114)/1e3,!(r>=255&&d>=255&&l>=255)););const c=`#${r.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}`,m=o>128?"#000000":"#ffffff";t.style.setProperty("--primary",c),t.style.setProperty("--primary-foreground",m),t.style.setProperty("--highlight",c),t.style.setProperty("--highlight-rgb",`${r}, ${d}, ${l}`),t.style.setProperty("--active-highlight",c),t.style.setProperty("--ring",c);let u;if(o>200){const h=Math.floor(r*.85),f=Math.floor(d*.85),g=Math.floor(l*.85);u=`rgba(${h}, ${f}, ${g}, 0.25)`}else u=`rgba(${r}, ${d}, ${l}, 0.15)`;t.style.setProperty("--track-hover-bg",u)}resetVibrantColor(){const e=document.documentElement;e.style.removeProperty("--primary"),e.style.removeProperty("--primary-foreground"),e.style.removeProperty("--highlight"),e.style.removeProperty("--highlight-rgb"),e.style.removeProperty("--active-highlight"),e.style.removeProperty("--ring"),e.style.removeProperty("--track-hover-bg")}async showFullscreenCover(e,t,s,a){if(!e)return;const i=document.getElementById("fullscreen-cover-overlay"),r=document.getElementById("fullscreen-cover-image"),d=document.getElementById("fullscreen-track-title"),l=document.getElementById("fullscreen-track-artist"),o=document.getElementById("fullscreen-next-track");document.getElementById("fullscreen-lyrics-container");const c=document.getElementById("toggle-fullscreen-lyrics-btn"),m=this.api.getCoverUrl(e.album?.cover,"1280");if(r.src=m,d.textContent=e.title,l.textContent=ee(e),t?(o.style.display="flex",o.querySelector(".value").textContent=`${t.title} • ${ee(t)}`,o.classList.remove("animate-in"),o.offsetWidth,o.classList.add("animate-in")):(o.style.display="none",o.classList.remove("animate-in")),i.style.setProperty("--bg-image",`url('${m}')`),s&&a){c.style.display="flex",c.classList.remove("active");const u=()=>{je(e,a,s),c.classList.toggle("active")},h=c.cloneNode(!0);c.parentNode.replaceChild(h,c),h.addEventListener("click",u)}else c.style.display="none";i.style.display="flex"}closeFullscreenCover(){const e=document.getElementById("fullscreen-cover-overlay");e.style.display="none"}showPage(e){document.querySelectorAll(".page").forEach(t=>{t.classList.toggle("active",t.id===`page-${e}`)}),document.querySelectorAll(".sidebar-nav a").forEach(t=>{t.classList.toggle("active",t.hash===`#${e}`)}),document.querySelector(".main-content").scrollTop=0,["album","artist","playlist","mix"].includes(e)||(this.setPageBackground(null),this.updateGlobalTheme()),e==="settings"&&this.renderApiSettings()}async renderLibraryPage(){this.showPage("library");const e=document.getElementById("library-tracks-container"),t=document.getElementById("library-albums-container"),s=document.getElementById("library-artists-container"),a=document.getElementById("library-playlists-container"),i=document.getElementById("library-local-container"),r=await M.getFavorites("track");r.length?this.renderListWithTracks(e,r,!0):e.innerHTML=N("No liked tracks yet.");const d=await M.getFavorites("album");d.length?(t.innerHTML=d.map(f=>this.createAlbumCardHTML(f)).join(""),d.forEach(f=>{const g=t.querySelector(`[data-album-id="${f.id}"]`);g&&(H.set(g,f),this.updateLikeState(g,"album",f.id))})):t.innerHTML=N("No liked albums yet.");const l=await M.getFavorites("artist");l.length?(s.innerHTML=l.map(f=>this.createArtistCardHTML(f)).join(""),l.forEach(f=>{const g=s.querySelector(`[data-artist-id="${f.id}"]`);g&&(H.set(g,f),this.updateLikeState(g,"artist",f.id))})):s.innerHTML=N("No liked artists yet.");const o=await M.getFavorites("playlist"),c=await M.getFavorites("mix");let m=[];o.length&&m.push(...o.map(f=>({...f,_type:"playlist"}))),c.length&&m.push(...c.map(f=>({...f,_type:"mix"}))),m.sort((f,g)=>g.addedAt-f.addedAt),m.length?(a.innerHTML=m.map(f=>f._type==="playlist"?this.createPlaylistCardHTML(f):this.createMixCardHTML(f)).join(""),o.forEach(f=>{const g=a.querySelector(`[data-playlist-id="${f.uuid}"]`);g&&(H.set(g,f),this.updateLikeState(g,"playlist",f.uuid))}),c.forEach(f=>{const g=a.querySelector(`[data-mix-id="${f.id}"]`);g&&(H.set(g,f),this.updateLikeState(g,"mix",f.id))})):a.innerHTML=N("No liked playlists or mixes yet.");const u=document.getElementById("my-playlists-container"),h=await M.getPlaylists();h.length?(u.innerHTML=h.map(f=>this.createUserPlaylistCardHTML(f)).join(""),h.forEach(f=>{const g=u.querySelector(`[data-user-playlist-id="${f.id}"]`);g&&H.set(g,f)})):u.innerHTML=N("No playlists yet. Create your first playlist!"),this.renderLocalFiles(i)}async renderLocalFiles(e){if(!e)return;const t=document.getElementById("local-files-intro"),s=document.getElementById("local-files-header"),a=document.getElementById("local-files-list"),i=document.getElementById("select-local-folder-text"),r=await M.getSetting("local_folder_handle");r?(i&&(i.textContent=`Load "${r.name}"`),window.localFilesCache&&window.localFilesCache.length>0?(t&&(t.style.display="none"),s&&(s.style.display="flex",s.querySelector("h3").textContent=`Local Files (${window.localFilesCache.length})`),a&&this.renderListWithTracks(a,window.localFilesCache,!1)):(t&&(t.style.display="block"),s&&(s.style.display="none"),a&&(a.innerHTML=""))):(i&&(i.textContent="Select Music Folder"),t&&(t.style.display="block"),s&&(s.style.display="none"),a&&(a.innerHTML=""))}async renderHomePage(){this.showPage("home");const e=ge.getRecents(),t=document.getElementById("home-recent-albums"),s=document.getElementById("home-recent-artists"),a=document.getElementById("home-recent-playlists");if(e.albums.length?(t.innerHTML=e.albums.map(i=>this.createAlbumCardHTML(i)).join(""),e.albums.forEach(i=>{const r=t.querySelector(`[data-album-id="${i.id}"]`);r&&(H.set(r,i),this.updateLikeState(r,"album",i.id))})):t.innerHTML=N("You haven't viewed any albums yet."),e.artists.length?(s.innerHTML=e.artists.map(i=>this.createArtistCardHTML(i)).join(""),e.artists.forEach(i=>{const r=s.querySelector(`[data-artist-id="${i.id}"]`);r&&(H.set(r,i),this.updateLikeState(r,"artist",i.id))})):s.innerHTML=N("You haven't viewed any artists yet."),a){const i=e.playlists||[],r=e.mixes||[],d=[...i,...r];d.length?(a.innerHTML=d.map(l=>l.isUserPlaylist?this.createUserPlaylistCardHTML(l):l.mixType?this.createMixCardHTML(l):this.createPlaylistCardHTML(l)).join(""),d.forEach(l=>{if(l.isUserPlaylist){const o=a.querySelector(`[data-user-playlist-id="${l.id}"]`);o&&H.set(o,l)}else if(l.mixType){const o=a.querySelector(`[data-mix-id="${l.id}"]`);o&&(H.set(o,l),this.updateLikeState(o,"mix",l.id))}else{const o=a.querySelector(`[data-playlist-id="${l.uuid}"]`);o&&(H.set(o,l),this.updateLikeState(o,"playlist",l.uuid))}})):a.innerHTML=N("You haven't viewed any playlists or mixes yet.")}}async renderSearchPage(e){this.showPage("search"),document.getElementById("search-results-title").textContent=`Search Results for "${e}"`;const t=document.getElementById("search-tracks-container"),s=document.getElementById("search-artists-container"),a=document.getElementById("search-albums-container"),i=document.getElementById("search-playlists-container");t.innerHTML=this.createSkeletonTracks(8,!0),s.innerHTML=this.createSkeletonCards(6,!0),a.innerHTML=this.createSkeletonCards(6,!1),i.innerHTML=this.createSkeletonCards(6,!1),this.searchAbortController&&this.searchAbortController.abort(),this.searchAbortController=new AbortController;const r=this.searchAbortController.signal;try{const[d,l,o,c]=await Promise.all([this.api.searchTracks(e,{signal:r}),this.api.searchArtists(e,{signal:r}),this.api.searchAlbums(e,{signal:r}),this.api.searchPlaylists(e,{signal:r})]);let m=d.items,u=l.items,h=o.items,f=c.items;if(u.length===0&&m.length>0){const g=new Map;m.forEach(p=>{p.artist&&!g.has(p.artist.id)&&g.set(p.artist.id,p.artist),p.artists&&p.artists.forEach(w=>{g.has(w.id)||g.set(w.id,w)})}),u=Array.from(g.values())}if(h.length===0&&m.length>0){const g=new Map;m.forEach(p=>{p.album&&!g.has(p.album.id)&&g.set(p.album.id,p.album)}),h=Array.from(g.values())}m.length?this.renderListWithTracks(t,m,!0):t.innerHTML=N("No tracks found."),s.innerHTML=u.length?u.map(g=>this.createArtistCardHTML(g)).join(""):N("No artists found."),u.forEach(g=>{const p=s.querySelector(`[data-artist-id="${g.id}"]`);p&&(H.set(p,g),this.updateLikeState(p,"artist",g.id))}),a.innerHTML=h.length?h.map(g=>this.createAlbumCardHTML(g)).join(""):N("No albums found."),h.forEach(g=>{const p=a.querySelector(`[data-album-id="${g.id}"]`);p&&(H.set(p,g),this.updateLikeState(p,"album",g.id))}),i.innerHTML=f.length?f.map(g=>this.createPlaylistCardHTML(g)).join(""):N("No playlists found."),f.forEach(g=>{const p=i.querySelector(`[data-playlist-id="${g.uuid}"]`);p&&(H.set(p,g),this.updateLikeState(p,"playlist",g.uuid))})}catch(d){if(d.name==="AbortError")return;console.error("Search failed:",d);const l=N(`Error during search. ${d.message}`);t.innerHTML=l,s.innerHTML=l,a.innerHTML=l,i.innerHTML=l}}async renderAlbumPage(e){this.showPage("album");const t=document.getElementById("album-detail-image"),s=document.getElementById("album-detail-title"),a=document.getElementById("album-detail-meta"),i=document.getElementById("album-detail-producer"),r=document.getElementById("album-detail-tracklist"),d=document.getElementById("play-album-btn");d&&(d.innerHTML=`${he}<span>Play Album</span>`);const l=document.getElementById("download-album-btn");l&&(l.innerHTML=`${pe}<span>Download Album</span>`);const o=document.getElementById("album-mix-btn");o&&(o.style.display="none"),t.src="",t.style.backgroundColor="var(--muted)",s.innerHTML='<div class="skeleton" style="height: 48px; width: 300px; max-width: 90%;"></div>',a.innerHTML='<div class="skeleton" style="height: 16px; width: 200px; max-width: 80%;"></div>',i.innerHTML='<div class="skeleton" style="height: 16px; width: 200px; max-width: 80%;"></div>',r.innerHTML=`
            <div class="track-list-header">
                <span style="width: 40px; text-align: center;">#</span>
                <span>Title</span>
                <span class="duration-header">Duration</span>
            </div>
            ${this.createSkeletonTracks(10,!1)}
        `;try{const{album:c,tracks:m}=await this.api.getAlbum(e),u=this.api.getCoverUrl(c.cover);t.src=u,t.style.backgroundColor="",this.setPageBackground(u),we.isEnabled()&&c.cover&&this.extractAndApplyColor(this.api.getCoverUrl(c.cover,"80"));const h=Ze(c)?this.createExplicitBadge():"";s.innerHTML=`${Y(c.title)} ${h}`,this.adjustTitleFontSize(s,c.title);const f=Ee(m);let g="";if(c.releaseDate){const x=new Date(c.releaseDate);if(!isNaN(x.getTime())){const B=x.getFullYear();g=window.innerWidth>768?x.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):B}}const p=m.find(x=>x.copyright)?.copyright;a.innerHTML=(g?`${g} • `:"")+`${m.length} tracks • ${Se(f)}`,i.innerHTML=`By <a href="#artist/${c.artist.id}">${c.artist.name}</a>`+(p?` • ${p}`:""),r.innerHTML=`
                <div class="track-list-header">
                    <span style="width: 40px; text-align: center;">#</span>
                    <span>Title</span>
                    <span class="duration-header">Duration</span>
                </div>
            `,m.sort((x,B)=>{const P=x.volumeNumber??x.discNumber??1,$=B.volumeNumber??B.discNumber??1;return P!==$?P-$:x.trackNumber-B.trackNumber}),this.renderListWithTracks(r,m,!1),ge.addAlbum(c);const w=document.getElementById("like-album-btn");if(w){const x=await M.isFavorite("album",c.id);w.innerHTML=this.createHeartIcon(x),w.classList.toggle("active",x)}document.title=`${c.title} - ${c.artist.name}`;const I=document.getElementById("album-section-more-albums"),y=document.getElementById("album-detail-more-albums"),b=document.getElementById("album-title-more-albums"),k=document.getElementById("album-section-eps"),T=document.getElementById("album-detail-eps"),v=document.getElementById("album-title-eps"),S=document.getElementById("album-section-similar-artists"),L=document.getElementById("album-detail-similar-artists"),A=document.getElementById("album-section-similar-albums"),C=document.getElementById("album-detail-similar-albums");[I,k,S,A].forEach(x=>{x&&(x.style.display="none")});try{const x=await this.api.getArtist(c.artist.id),B=document.getElementById("album-mix-btn");B&&x.mixes&&x.mixes.ARTIST_MIX&&(B.style.display="flex",B.onclick=()=>window.location.hash=`#mix/${x.mixes.ARTIST_MIX}`);const P=($,R,O,z,G)=>{if(!R||!O)return;const te=($||[]).filter(q=>q.id!=c.id).filter((q,E,_)=>E===_.findIndex(D=>D.title===q.title)).slice(0,12);te.length!==0&&(R.innerHTML=te.map(q=>this.createAlbumCardHTML(q)).join(""),z&&G&&(z.textContent=G),O.style.display="block",te.forEach(q=>{const E=R.querySelector(`[data-album-id="${q.id}"]`);E&&(H.set(E,q),this.updateLikeState(E,"album",q.id))}))};P(x.albums,y,I,b,`More albums from ${c.artist.name}`),P(x.eps,T,k,v,`EPs and Singles from ${c.artist.name}`),this.api.getSimilarArtists(c.artist.id).then($=>{$&&$.length>0&&L&&S&&(L.innerHTML=$.map(R=>this.createArtistCardHTML(R)).join(""),S.style.display="block")}).catch($=>console.warn("Failed to load similar artists:",$)),this.api.getSimilarAlbums(e).then($=>{$&&$.length>0&&C&&A&&(C.innerHTML=$.map(R=>this.createAlbumCardHTML(R)).join(""),A.style.display="block",$.forEach(R=>{const O=C.querySelector(`[data-album-id="${R.id}"]`);O&&(H.set(O,R),this.updateLikeState(O,"album",R.id))}))}).catch($=>console.warn("Failed to load similar albums:",$))}catch(x){console.warn('Failed to load "More from artist":',x)}}catch(c){console.error("Failed to load album:",c),r.innerHTML=N(`Could not load album details. ${c.message}`)}}async loadRecommendedSongsForPlaylist(e){const t=document.getElementById("playlist-section-recommended"),s=document.getElementById("playlist-detail-recommended");if(!t||!s){console.warn("Recommended songs section not found in DOM");return}try{const a=await this.api.getRecommendedTracksForPlaylist(e,30);a.length>0?(this.renderListWithTracks(s,a,!0),s.querySelectorAll(".track-item").forEach(r=>{const d=r.querySelector(".track-item-actions");if(d){const l=document.createElement("button");l.className="track-action-btn add-to-playlist-btn",l.title="Add to this playlist",l.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>',l.onclick=async c=>{c.stopPropagation();const m=H.get(r);if(m)try{const h=window.location.hash.match(/#userplaylist\/([^/]+)/);if(h){const f=h[1];await M.addTrackToPlaylist(f,m);const g=await M.getPlaylist(f);U.syncUserPlaylist(g,"update");const p=document.getElementById("playlist-detail-tracklist");if(p&&g.tracks){p.innerHTML=`
                                                <div class="track-list-header">
                                                    <span style="width: 40px; text-align: center;">#</span>
                                                    <span>Title</span>
                                                    <span class="duration-header">Duration</span>
                                                </div>
                                            `,this.renderListWithTracks(p,g.tracks,!0),document.querySelector(".remove-from-playlist-btn")&&this.enableTrackReordering(p,g.tracks,f,U);const w=document.getElementById("playlist-detail-meta");if(w){const I=Ee(g.tracks);w.textContent=`${g.tracks.length} tracks • ${Se(I)}`}}showNotification(`Added "${m.title}" to playlist`)}}catch(u){console.error("Failed to add track to playlist:",u),showNotification("Failed to add track to playlist")}};const o=d.querySelector(".track-menu-btn");o?d.insertBefore(l,o):d.appendChild(l)}}),t.style.display="block"):t.style.display="none"}catch(a){console.error("Failed to load recommended songs:",a),t.style.display="none"}}async renderPlaylistPage(e,t=null){this.showPage("playlist");const s=document.getElementById("playlist-detail-image"),a=document.getElementById("playlist-detail-title"),i=document.getElementById("playlist-detail-meta"),r=document.getElementById("playlist-detail-description"),d=document.getElementById("playlist-detail-tracklist"),l=document.getElementById("play-playlist-btn");l&&(l.innerHTML=`${he}<span>Play</span>`);const o=document.getElementById("download-playlist-btn");o&&(o.innerHTML=`${pe}<span>Download</span>`),s.src="",s.style.backgroundColor="var(--muted)",a.innerHTML='<div class="skeleton" style="height: 48px; width: 300px; max-width: 90%;"></div>',i.innerHTML='<div class="skeleton" style="height: 16px; width: 200px; max-width: 80%;"></div>',r.innerHTML='<div class="skeleton" style="height: 16px; width: 100%;"></div>',d.innerHTML=`
            <div class="track-list-header">
                <span style="width: 40px; text-align: center;">#</span>
                <span>Title</span>
                <span class="duration-header">Duration</span>
            </div>
            ${this.createSkeletonTracks(10,!0)}
        `;try{const c=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e);let m=null,u=null;if((t==="user"||!t&&c)&&(u=await M.getPlaylist(e),m=u,!m))try{m=await U.getPublicPlaylist(e)}catch(h){console.warn("Failed to check public Firebase playlists:",h)}if(m){s.src=m.cover||"assets/appicon.png",s.style.backgroundColor="",a.textContent=m.name||m.title,this.adjustTitleFontSize(a,a.textContent);const h=m.tracks||[],f=Ee(h);i.textContent=`${h.length} tracks • ${Se(f)}`,r.textContent=m.description||"",d.innerHTML=`
                    <div class="track-list-header">
                        <span style="width: 40px; text-align: center;">#</span>
                        <span>Title</span>
                        <span class="duration-header">Duration</span>
                    </div>
                `,this.renderListWithTracks(d,h,!0),u&&(d.querySelectorAll(".track-item").forEach((b,k)=>{const T=b.querySelector(".track-item-actions"),v=document.createElement("button");v.className="track-action-btn remove-from-playlist-btn",v.title="Remove from playlist",v.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>',v.dataset.trackIndex=k;const S=T.querySelector(".track-menu-btn");T.insertBefore(v,S)}),this.enableTrackReordering(d,h,e,U));const g=document.getElementById("like-playlist-btn");g&&(g.style.display="none"),u&&this.loadRecommendedSongsForPlaylist(h),this.updatePlaylistHeaderActions(m,!!u,h);const p=[],w=new Set,I=m.tracks||[];for(const y of I){const b=y.album?.cover;if(b&&!w.has(b)&&(w.add(b),p.push(b),p.length>=4))break}ge.addPlaylist({id:m.id||m.uuid,name:m.name||m.title,title:m.title||m.name,uuid:m.uuid||m.id,cover:m.cover,images:p,numberOfTracks:m.tracks?m.tracks.length:0,isUserPlaylist:!0}),document.title=`${m.name||m.title} - Monochrome`}else{if(t==="user")throw new Error("Playlist not found. If this is a custom playlist, make sure it is set to Public.");let h=await this.api.getPlaylist(e);const{playlist:f,tracks:g}=h,p=f.squareImage||f.image;p?(s.src=this.api.getCoverUrl(p,"1080"),this.setPageBackground(s.src),this.extractAndApplyColor(this.api.getCoverUrl(p,"160"))):(s.src="assets/appicon.png",this.setPageBackground(null),this.resetVibrantColor()),a.textContent=f.title,this.adjustTitleFontSize(a,f.title);const w=Ee(g);i.textContent=`${f.numberOfTracks} tracks • ${Se(w)}`,r.textContent=f.description||"",d.innerHTML=`
                    <div class="track-list-header">
                        <span style="width: 40px; text-align: center;">#</span>
                        <span>Title</span>
                        <span class="duration-header">Duration</span>
                    </div>
                `,this.renderListWithTracks(d,g,!0);const I=document.getElementById("like-playlist-btn");if(I){const k=await M.isFavorite("playlist",f.uuid);I.innerHTML=this.createHeartIcon(k),I.classList.toggle("active",k),I.style.display="flex"}const y=document.getElementById("delete-playlist-btn");y&&(y.style.display="none");const b=document.getElementById("playlist-section-recommended");b&&(b.style.display="none"),this.updatePlaylistHeaderActions(f,!1,g,!1),ge.addPlaylist(f),document.title=f.title||"Artist Mix"}}catch(c){console.error("Failed to load playlist:",c),d.innerHTML=N(`Could not load playlist details. ${c.message}`)}}async renderMixPage(e){this.showPage("mix");const t=document.getElementById("mix-detail-image"),s=document.getElementById("mix-detail-title"),a=document.getElementById("mix-detail-meta"),i=document.getElementById("mix-detail-description"),r=document.getElementById("mix-detail-tracklist"),d=document.getElementById("play-mix-btn");d&&(d.innerHTML=`${he}<span>Play</span>`);const l=document.getElementById("download-mix-btn");l&&(l.innerHTML=`${pe}<span>Download</span>`),t.src="",t.style.backgroundColor="var(--muted)",s.innerHTML='<div class="skeleton" style="height: 48px; width: 300px; max-width: 90%;"></div>',a.innerHTML='<div class="skeleton" style="height: 16px; width: 200px; max-width: 80%;"></div>',i.innerHTML='<div class="skeleton" style="height: 16px; width: 100%;"></div>',r.innerHTML=`
            <div class="track-list-header">
                <span style="width: 40px; text-align: center;">#</span>
                <span>Title</span>
                <span class="duration-header">Duration</span>
            </div>
            ${this.createSkeletonTracks(10,!0)}
        `;try{const{mix:o,tracks:c}=await this.api.getMix(e);o.cover?(t.src=o.cover,this.setPageBackground(o.cover),this.extractAndApplyColor(o.cover)):c.length>0&&c[0].album?.cover?(t.src=this.api.getCoverUrl(c[0].album.cover),this.setPageBackground(t.src),this.extractAndApplyColor(this.api.getCoverUrl(c[0].album.cover,"160"))):(t.src="assets/appicon.png",this.setPageBackground(null),this.resetVibrantColor()),t.style.backgroundColor="";const m=o.title||"Mix";s.textContent=m,this.adjustTitleFontSize(s,m);const u=Ee(c);a.textContent=`${c.length} tracks • ${Se(u)}`,i.innerHTML=`${o.subTitle}`,r.innerHTML=`
                <div class="track-list-header">
                    <span style="width: 40px; text-align: center;">#</span>
                    <span>Title</span>
                    <span class="duration-header">Duration</span>
                </div>
            `,this.renderListWithTracks(r,c,!0),d.onclick=()=>{this.player.setQueue(c,0),this.player.playTrackFromQueue()},ge.addMix(o);const h=document.getElementById("like-mix-btn");if(h){h.style.display="flex";const f=await M.isFavorite("mix",o.id);h.innerHTML=this.createHeartIcon(f),h.classList.toggle("active",f)}document.title=m}catch(o){console.error("Failed to load mix:",o),r.innerHTML=N(`Could not load mix details. ${o.message}`)}}async renderArtistPage(e){this.showPage("artist");const t=document.getElementById("artist-detail-image"),s=document.getElementById("artist-detail-name"),a=document.getElementById("artist-detail-meta"),i=document.getElementById("artist-detail-tracks"),r=document.getElementById("artist-detail-albums"),d=document.getElementById("artist-detail-eps"),l=document.getElementById("artist-section-eps"),o=document.getElementById("artist-detail-similar"),c=document.getElementById("artist-section-similar"),m=document.getElementById("download-discography-btn");m&&(m.innerHTML=`${pe}<span>Download Discography</span>`),t.src="",t.style.backgroundColor="var(--muted)",s.innerHTML='<div class="skeleton" style="height: 48px; width: 300px; max-width: 90%;"></div>',a.innerHTML='<div class="skeleton" style="height: 16px; width: 150px;"></div>',i.innerHTML=this.createSkeletonTracks(5,!0),r.innerHTML=this.createSkeletonCards(6,!1),d&&(d.innerHTML=this.createSkeletonCards(6,!1)),l&&(l.style.display="none"),o&&(o.innerHTML=this.createSkeletonCards(6,!0)),c&&(c.style.display="block");try{const u=await this.api.getArtist(e),h=document.getElementById("artist-mix-btn");h&&(u.mixes&&u.mixes.ARTIST_MIX?(h.style.display="flex",h.onclick=()=>window.location.hash=`#mix/${u.mixes.ARTIST_MIX}`):h.style.display="none"),o&&c&&this.api.getSimilarArtists(e).then(p=>{p&&p.length>0?(o.innerHTML=p.map(w=>this.createArtistCardHTML(w)).join(""),c.style.display="block"):c.style.display="none"}).catch(()=>{c.style.display="none"}),t.src=this.api.getArtistPictureUrl(u.picture),t.style.backgroundColor="",s.textContent=u.name,this.setPageBackground(t.src);const f=this.api.getArtistPictureUrl(u.picture,"160");this.extractAndApplyColor(f),this.adjustTitleFontSize(s,u.name),a.innerHTML=`
                <span>${u.popularity}% popularity</span>
                <div class="artist-tags">
                    ${(u.artistRoles||[]).filter(p=>p.category).map(p=>`<span class="artist-tag">${p.category}</span>`).join("")}
                </div>
            `,this.renderListWithTracks(i,u.tracks,!0);const g=document.getElementById("like-artist-btn");if(g){const p=await M.isFavorite("artist",u.id);g.innerHTML=this.createHeartIcon(p),g.classList.toggle("active",p)}r.innerHTML=u.albums.map(p=>this.createAlbumCardHTML(p)).join(""),r.innerHTML=u.albums.length?u.albums.map(p=>this.createAlbumCardHTML(p)).join(""):N("No albums found."),d&&l&&(u.eps&&u.eps.length>0?(d.innerHTML=u.eps.map(p=>this.createAlbumCardHTML(p)).join(""),l.style.display="block"):l.style.display="none"),u.albums.forEach(p=>{const w=r.querySelector(`[data-album-id="${p.id}"]`);w&&(H.set(w,p),this.updateLikeState(w,"album",p.id))}),ge.addArtist(u),document.title=u.name}catch(u){console.error("Failed to load artist:",u),i.innerHTML=r.innerHTML=N(`Could not load artist details. ${u.message}`)}}async renderRecentPage(){this.showPage("recent");const e=document.getElementById("recent-tracks-container");e.innerHTML=this.createSkeletonTracks(10,!0);try{const t=await M.getHistory();if(t.length===0){e.innerHTML=N("You haven't played any tracks yet.");return}const s={},a=new Date().setHours(0,0,0,0),i=new Date(a-864e5).setHours(0,0,0,0);t.forEach(r=>{const d=new Date(r.timestamp),l=new Date(d).setHours(0,0,0,0);let o;l===a?o="Today":l===i?o="Yesterday":o=d.toLocaleDateString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric"}),s[o]||(s[o]=[]),s[o].push(r)}),e.innerHTML="";for(const[r,d]of Object.entries(s)){const l=document.createElement("h3");l.className="track-list-header-group",l.textContent=r,l.style.margin="1.5rem 0 0.5rem 0",l.style.fontSize="1.1rem",l.style.fontWeight="600",l.style.color="var(--foreground)",l.style.paddingLeft="0.5rem",e.appendChild(l);const o=document.createElement("div");for(this.renderListWithTracks(o,d,!0);o.firstChild;)e.appendChild(o.firstChild)}}catch(t){console.error("Failed to load history:",t),e.innerHTML=N("Failed to load history.")}}updatePlaylistHeaderActions(e,t,s,a=!1){const i=document.getElementById("page-playlist").querySelector(".detail-header-actions");["shuffle-playlist-btn","edit-playlist-btn","delete-playlist-btn","share-playlist-btn"].forEach(o=>{const c=i.querySelector(`#${o}`);c&&c.remove()});const r=document.createDocumentFragment(),d=document.createElement("button");if(d.id="shuffle-playlist-btn",d.className="btn-primary",d.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 14 4 4-4 4"/><path d="m18 2 4 4-4 4"/><path d="M2 18h1.973a4 4 0 0 0 3.3-1.7l5.454-8.6a4 4 0 0 1 3.3-1.7H22"/><path d="M2 6h1.972a4 4 0 0 1 3.6 2.2"/><path d="M22 18h-6.041a4 4 0 0 1-3.3-1.8l-.359-.45"/></svg><span>Shuffle</span>',d.onclick=()=>{const o=[...s].sort(()=>Math.random()-.5);this.player.setQueue(o,0),this.player.playTrackFromQueue()},r.appendChild(d),t){const o=document.createElement("button");o.id="edit-playlist-btn",o.className="btn-secondary",o.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg><span>Edit</span>',r.appendChild(o);const c=document.createElement("button");c.id="delete-playlist-btn",c.className="btn-secondary danger",c.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg><span>Delete</span>',r.appendChild(c)}if(a||t&&e.isPublic){const o=document.createElement("button");o.id="share-playlist-btn",o.className="btn-secondary",o.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg><span>Share</span>',o.onclick=()=>{const c=`${window.location.origin}${window.location.pathname}#userplaylist/${e.id||e.uuid}`;navigator.clipboard.writeText(c).then(()=>alert("Link copied to clipboard!"))},r.appendChild(o)}const l=i.querySelector("#download-playlist-btn");if(l)for(i.insertBefore(d,l);r.firstChild;)i.appendChild(r.firstChild);else i.appendChild(r)}enableTrackReordering(e,t,s,a){let i=null,r=-1;Array.from(e.querySelectorAll(".track-item")).forEach((h,f)=>{h.draggable=!0,h.dataset.index=f});const l=h=>{i=h.target,r=parseInt(h.target.dataset.index),h.dataTransfer.effectAllowed="move",h.dataTransfer.setData("text/plain",r),i.classList.add("dragging")},o=()=>{i&&(i.classList.remove("dragging"),i=null)},c=h=>{if(h.preventDefault(),h.dataTransfer.dropEffect="move",!i)return;const f=u(e,h.clientY);f!==i&&(f?e.insertBefore(i,f):e.appendChild(i))},m=async h=>{if(h.preventDefault(),!!i)try{const f=Array.from(e.querySelectorAll(".track-item")),g=f.map(w=>{const I=parseInt(w.dataset.index);return t[I]});f.forEach((w,I)=>{w.dataset.index=I}),t.splice(0,t.length,...g);const p=await M.updatePlaylistTracks(s,g);a.syncUserPlaylist(p,"update"),i=null,r=-1}catch(f){console.error("Error updating playlist tracks:",f),i&&(i.classList.remove("dragging"),i=null),r=-1}};e.addEventListener("dragstart",l),e.addEventListener("dragend",o),e.addEventListener("dragover",c),e.addEventListener("drop",m);function u(h,f){return[...h.querySelectorAll(".track-item:not(.dragging)")].reduce((p,w)=>{const I=w.getBoundingClientRect(),y=f-I.top-I.height/2;return y<0&&y>p.offset?{offset:y,element:w}:p},{offset:Number.NEGATIVE_INFINITY}).element}}getDragAfterElement(e,t){return[...e.querySelectorAll(".track-item:not(.dragging)")].reduce((a,i)=>{const r=i.getBoundingClientRect(),d=t-r.top-r.height/2;return d<0&&d>a.offset?{offset:d,element:i}:a},{offset:Number.NEGATIVE_INFINITY}).element}renderApiSettings(){const e=document.getElementById("api-instance-list");Promise.all([this.api.settings.getInstances("api"),this.api.settings.getInstances("streaming")]).then(([t,s])=>{const i=this.api.settings.getCachedSpeedTests()?.speeds||{},r=(o,c)=>{if(!o||o.length===0)return"";const m=o.map((u,h)=>{const f=c==="streaming"?`${u}#streaming`:u,g=i[f],p=g?g.speed===1/0||typeof g.speed!="number"?'<span style="color: var(--muted-foreground); font-size: 0.8rem;">Failed</span>':`<span style="color: var(--muted-foreground); font-size: 0.8rem;">${g.speed.toFixed(0)}ms</span>`:"";return`
                        <li data-index="${h}" data-type="${c}">
                            <div style="flex: 1; min-width: 0;">
                                <div class="instance-url">${u}</div>
                                ${p}
                            </div>
                            <div class="controls">
                                <button class="move-up" title="Move Up" ${h===0?"disabled":""}>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 19V5M5 12l7-7 7 7"/>
                                    </svg>
                                </button>
                                <button class="move-down" title="Move Down" ${h===o.length-1?"disabled":""}>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 5v14M19 12l-7 7-7-7"/>
                                    </svg>
                                </button>
                            </div>
                        </li>
                    `}).join("");return`
                    <li class="group-header" style="font-weight: bold; padding: 1rem 0 0.5rem; background: transparent; border: none; pointer-events: none;">
                        ${c==="api"?"API Instances":"Streaming Instances"}
                    </li>
                    ${m}
                `};e.innerHTML=r(t,"api")+r(s,"streaming");const d=this.api.getCacheStats(),l=document.getElementById("cache-info");l&&(l.textContent=`Cache: ${d.memoryEntries}/${d.maxSize} entries`)})}}class Ys{constructor(e,t,s="LOSSLESS"){this.audio=e,this.api=t,this.quality=s,this.queue=[],this.shuffledQueue=[],this.originalQueueBeforeShuffle=[],this.currentQueueIndex=-1,this.shuffleActive=!1,this.repeatMode=J.OFF,this.preloadCache=new Map,this.preloadAbortController=null,this.currentTrack=null,this.currentRgValues=null,this.userVolume=parseFloat(localStorage.getItem("volume")||"0.7"),this.sleepTimer=null,this.sleepTimerEndTime=null,this.sleepTimerInterval=null,this.loadQueueState(),this.setupMediaSession(),window.addEventListener("beforeunload",()=>{this.saveQueueState()})}setVolume(e){this.userVolume=Math.max(0,Math.min(1,e)),localStorage.setItem("volume",this.userVolume),this.applyReplayGain()}applyReplayGain(){const e=ve.getMode();let t=0,s=1;if(e!=="off"&&this.currentRgValues){const{trackReplayGain:r,trackPeakAmplitude:d,albumReplayGain:l,albumPeakAmplitude:o}=this.currentRgValues;e==="album"&&l!==void 0?(t=l,s=o||1):r!==void 0&&(t=r,s=d||1),t+=ve.getPreamp()}let a=Math.pow(10,t/20);a*s>1&&(a=1/s);const i=this.userVolume*a;this.audio.volume=Math.max(0,Math.min(1,i))}loadQueueState(){const e=vt.getQueue();if(e){this.queue=e.queue||[],this.shuffledQueue=e.shuffledQueue||[],this.originalQueueBeforeShuffle=e.originalQueueBeforeShuffle||[],this.currentQueueIndex=e.currentQueueIndex??-1,this.shuffleActive=e.shuffleActive||!1,this.repeatMode=e.repeatMode||J.OFF;const t=this.shuffleActive?this.shuffledQueue:this.queue;if(this.currentQueueIndex>=0&&this.currentQueueIndex<t.length){this.currentTrack=t[this.currentQueueIndex];const s=this.currentTrack,a=ne(s),i=bt(s);let r="";const d=s.album?.releaseDate||s.streamStartDate;if(d){const h=new Date(d);isNaN(h.getTime())||(r=` • ${h.getFullYear()}`)}const l=document.querySelector(".now-playing-bar .cover"),o=document.querySelector(".now-playing-bar .title"),c=document.querySelector(".now-playing-bar .artist");l&&(l.src=this.api.getCoverUrl(s.album?.cover)),o&&(o.textContent=a),c&&(c.innerHTML=i+r);const m=document.getElementById("now-playing-mix-btn");m&&(m.style.display=s.mixes&&s.mixes.TRACK_MIX?"flex":"none");const u=document.getElementById("total-duration");u&&(u.textContent=xe(s.duration)),document.title=`${a} • ${ee(s)}`,this.updatePlayingTrackIndicator(),this.updateMediaSession(s)}}}saveQueueState(){vt.saveQueue({queue:this.queue,shuffledQueue:this.shuffledQueue,originalQueueBeforeShuffle:this.originalQueueBeforeShuffle,currentQueueIndex:this.currentQueueIndex,shuffleActive:this.shuffleActive,repeatMode:this.repeatMode})}setupMediaSession(){"mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",()=>{this.audio.play().catch(console.error)}),navigator.mediaSession.setActionHandler("pause",()=>{this.audio.pause()}),navigator.mediaSession.setActionHandler("previoustrack",()=>{this.playPrev()}),navigator.mediaSession.setActionHandler("nexttrack",()=>{this.playNext()}),navigator.mediaSession.setActionHandler("seekbackward",e=>{const t=e.seekOffset||10;this.seekBackward(t)}),navigator.mediaSession.setActionHandler("seekforward",e=>{const t=e.seekOffset||10;this.seekForward(t)}),navigator.mediaSession.setActionHandler("seekto",e=>{e.seekTime!==void 0&&(this.audio.currentTime=Math.max(0,e.seekTime),this.updateMediaSessionPositionState())}),navigator.mediaSession.setActionHandler("stop",()=>{this.audio.pause(),this.audio.currentTime=0,this.updateMediaSessionPlaybackState()}))}setQuality(e){this.quality=e}async preloadNextTracks(){this.preloadAbortController&&this.preloadAbortController.abort(),this.preloadAbortController=new AbortController;const e=this.shuffleActive?this.shuffledQueue:this.queue,t=[];for(let s=1;s<=2;s++){const a=this.currentQueueIndex+s;a<e.length&&t.push({track:e[a],index:a})}for(const{track:s}of t)if(!this.preloadCache.has(s.id)&&!s.isLocal)try{const a=await this.api.getStreamUrl(s.id,this.quality);if(this.preloadAbortController.signal.aborted)break;this.preloadCache.set(s.id,a),fetch(a,{method:"HEAD",signal:this.preloadAbortController.signal}).catch(()=>{})}catch(a){a.name!=="AbortError"&&console.debug("Failed to get stream URL for preload:",trackTitle)}}async playTrackFromQueue(e=0){const t=this.shuffleActive?this.shuffledQueue:this.queue;if(this.currentQueueIndex<0||this.currentQueueIndex>=t.length)return;this.saveQueueState();const s=t[this.currentQueueIndex];this.currentTrack=s;const a=ne(s),i=bt(s);let r="";const d=s.album?.releaseDate||s.streamStartDate;if(d){const o=new Date(d);isNaN(o.getTime())||(r=` • ${o.getFullYear()}`)}document.querySelector(".now-playing-bar .cover").src=this.api.getCoverUrl(s.album?.cover),document.querySelector(".now-playing-bar .title").textContent=a,document.querySelector(".now-playing-bar .artist").innerHTML=i+r;const l=document.getElementById("now-playing-mix-btn");l&&(l.style.display=s.mixes&&s.mixes.TRACK_MIX?"flex":"none"),document.title=`${a} • ${ee(s)}`,this.updatePlayingTrackIndicator();try{let o;if(s.isLocal&&s.file)o=URL.createObjectURL(s.file),this.currentRgValues=null,this.applyReplayGain();else{const c=await this.api.getTrack(s.id,this.quality);c&&c.info?this.currentRgValues={trackReplayGain:c.info.trackReplayGain,trackPeakAmplitude:c.info.trackPeakAmplitude,albumReplayGain:c.info.albumReplayGain,albumPeakAmplitude:c.info.albumPeakAmplitude}:this.currentRgValues=null,this.applyReplayGain(),this.preloadCache.has(s.id)?o=this.preloadCache.get(s.id):c.originalTrackUrl?o=c.originalTrackUrl:o=this.api.extractStreamUrlFromManifest(c.info.manifest)}this.audio.src=o,e>0&&(this.audio.currentTime=e),await this.audio.play(),this.updateMediaSession(s),this.updateMediaSessionPlaybackState(),this.preloadNextTracks()}catch(o){console.error(`Could not play track: ${a}`,o),document.querySelector(".now-playing-bar .title").textContent=`Error: ${a}`,document.querySelector(".now-playing-bar .artist").textContent=o.message||"Could not load track"}}playAtIndex(e){const t=this.shuffleActive?this.shuffledQueue:this.queue;e>=0&&e<t.length&&(this.currentQueueIndex=e,this.playTrackFromQueue())}playNext(){const e=this.shuffleActive?this.shuffledQueue:this.queue,t=this.currentQueueIndex>=e.length-1;if(this.repeatMode===J.ONE){this.audio.currentTime=0,this.audio.play();return}if(!t)this.currentQueueIndex++;else if(this.repeatMode===J.ALL)this.currentQueueIndex=0;else return;this.playTrackFromQueue()}playPrev(){this.audio.currentTime>3?(this.audio.currentTime=0,this.updateMediaSessionPositionState()):this.currentQueueIndex>0&&(this.currentQueueIndex--,this.playTrackFromQueue())}handlePlayPause(){if(!this.audio.src||this.audio.error){this.currentTrack&&this.playTrackFromQueue();return}this.audio.paused?this.audio.play().catch(e=>{e.name==="NotAllowedError"||e.name==="AbortError"||(console.error("Play failed, reloading track:",e),this.currentTrack&&this.playTrackFromQueue())}):(this.audio.pause(),this.saveQueueState())}seekBackward(e=10){const t=Math.max(0,this.audio.currentTime-e);this.audio.currentTime=t,this.updateMediaSessionPositionState()}seekForward(e=10){const t=this.audio.duration||0,s=Math.min(t,this.audio.currentTime+e);this.audio.currentTime=s,this.updateMediaSessionPositionState()}toggleShuffle(){if(this.shuffleActive=!this.shuffleActive,this.shuffleActive){this.originalQueueBeforeShuffle=[...this.queue];const e=this.queue[this.currentQueueIndex];this.shuffledQueue=[...this.queue].sort(()=>Math.random()-.5),this.currentQueueIndex=this.shuffledQueue.findIndex(t=>t.id===e?.id),this.currentQueueIndex===-1&&e&&(this.shuffledQueue.unshift(e),this.currentQueueIndex=0)}else{const e=this.shuffledQueue[this.currentQueueIndex];this.queue=[...this.originalQueueBeforeShuffle],this.currentQueueIndex=this.queue.findIndex(t=>t.id===e?.id)}this.preloadCache.clear(),this.preloadNextTracks(),this.saveQueueState()}toggleRepeat(){return this.repeatMode=(this.repeatMode+1)%3,this.saveQueueState(),this.repeatMode}setQueue(e,t=0){this.queue=e,this.currentQueueIndex=t,this.shuffleActive=!1,this.preloadCache.clear(),this.saveQueueState()}addToQueue(e){this.queue.push(e),(!this.currentTrack||this.currentQueueIndex===-1)&&(this.currentQueueIndex=this.queue.length-1,this.playTrackFromQueue()),this.saveQueueState()}addNextToQueue(e){const t=this.shuffleActive?this.shuffledQueue:this.queue,s=this.currentQueueIndex+1;t.splice(s,0,e),this.shuffleActive&&this.originalQueueBeforeShuffle.push(e),this.saveQueueState(),this.preloadNextTracks()}removeFromQueue(e){const t=this.shuffleActive?this.shuffledQueue:this.queue;this.currentQueueIndex,e<this.currentQueueIndex&&this.currentQueueIndex--;const s=t.splice(e,1)[0];if(this.shuffleActive){const a=this.originalQueueBeforeShuffle.findIndex(i=>i.id===s.id);a!==-1&&this.originalQueueBeforeShuffle.splice(a,1)}this.saveQueueState(),this.preloadNextTracks()}clearQueue(){this.queue=[],this.shuffledQueue=[],this.originalQueueBeforeShuffle=[],this.currentQueueIndex=-1,this.preloadCache.clear(),this.saveQueueState()}moveInQueue(e,t){const s=this.shuffleActive?this.shuffledQueue:this.queue;if(e<0||e>=s.length||t<0||t>=s.length)return;const[a]=s.splice(e,1);s.splice(t,0,a),this.currentQueueIndex===e?this.currentQueueIndex=t:e<this.currentQueueIndex&&t>=this.currentQueueIndex?this.currentQueueIndex--:e>this.currentQueueIndex&&t<=this.currentQueueIndex&&this.currentQueueIndex++,this.saveQueueState()}getCurrentQueue(){return this.shuffleActive?this.shuffledQueue:this.queue}getNextTrack(){const e=this.getCurrentQueue();if(this.currentQueueIndex===-1||e.length===0)return null;const t=this.currentQueueIndex+1;return t<e.length?e[t]:this.repeatMode===J.ALL?e[0]:null}updatePlayingTrackIndicator(){const e=this.getCurrentQueue()[this.currentQueueIndex];document.querySelectorAll(".track-item").forEach(t=>{t.classList.toggle("playing",e&&t.dataset.trackId==e.id)}),document.querySelectorAll(".queue-track-item").forEach(t=>{const s=parseInt(t.dataset.queueIndex);t.classList.toggle("playing",s===this.currentQueueIndex)})}updateMediaSession(e){if(!("mediaSession"in navigator))return;navigator.mediaSession.metadata=null;const t=[],s=["320"],a=e.album?.cover,i=ne(e);a&&s.forEach(r=>{t.push({src:this.api.getCoverUrl(a,r),sizes:`${r}x${r}`,type:"image/jpeg"})}),navigator.mediaSession.metadata=new MediaMetadata({title:i||"Unknown Title",artist:ee(e)||"Unknown Artist",album:e.album?.title||"Unknown Album",artwork:t.length>0?t:void 0}),this.updateMediaSessionPlaybackState(),this.updateMediaSessionPositionState()}updateMediaSessionPlaybackState(){"mediaSession"in navigator&&(navigator.mediaSession.playbackState=this.audio.paused?"paused":"playing")}updateMediaSessionPositionState(){if(!("mediaSession"in navigator)||!("setPositionState"in navigator.mediaSession))return;const e=this.audio.duration;if(!(!e||isNaN(e)||!isFinite(e)))try{navigator.mediaSession.setPositionState({duration:e,playbackRate:this.audio.playbackRate||1,position:Math.min(this.audio.currentTime,e)})}catch(t){console.debug("Failed to update Media Session position:",t)}}setSleepTimer(e){this.clearSleepTimer(),this.sleepTimerEndTime=Date.now()+e*60*1e3,this.sleepTimer=setTimeout(()=>{this.audio.pause(),this.clearSleepTimer(),this.updateSleepTimerUI()},e*60*1e3),this.sleepTimerInterval=setInterval(()=>{this.updateSleepTimerUI()},1e3),this.updateSleepTimerUI()}clearSleepTimer(){this.sleepTimer&&(clearTimeout(this.sleepTimer),this.sleepTimer=null),this.sleepTimerInterval&&(clearInterval(this.sleepTimerInterval),this.sleepTimerInterval=null),this.sleepTimerEndTime=null,this.updateSleepTimerUI()}getSleepTimerRemaining(){if(!this.sleepTimerEndTime)return null;const e=Math.max(0,this.sleepTimerEndTime-Date.now());return Math.ceil(e/1e3)}isSleepTimerActive(){return this.sleepTimer!==null}updateSleepTimerUI(){const e=document.getElementById("sleep-timer-btn"),t=document.getElementById("sleep-timer-btn-desktop"),s=a=>{if(a)if(this.isSleepTimerActive()){const i=this.getSleepTimerRemaining();if(i>0){const r=Math.floor(i/60),d=i%60;a.innerHTML=`<span style="font-size: 12px; font-weight: bold;">${r}:${d.toString().padStart(2,"0")}</span>`,a.title=`Sleep Timer: ${r}:${d.toString().padStart(2,"0")} remaining`,a.classList.add("active"),a.style.color="var(--primary)"}else a.innerHTML=`
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12,6 12,12 16,14"/>
                        </svg>
                    `,a.title="Sleep Timer",a.classList.remove("active"),a.style.color=""}else a.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                `,a.title="Sleep Timer",a.classList.remove("active"),a.style.color=""};s(e),s(t)}}const Js="modulepreload",Xs=function(n,e){return new URL(n,e).href},Et={},Q=function(e,t,s){let a=Promise.resolve();if(t&&t.length>0){let o=function(c){return Promise.all(c.map(m=>Promise.resolve(m).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};const r=document.getElementsByTagName("link"),d=document.querySelector("meta[property=csp-nonce]"),l=d?.nonce||d?.getAttribute("nonce");a=o(t.map(c=>{if(c=Xs(c,s),c in Et)return;Et[c]=!0;const m=c.endsWith(".css"),u=m?'[rel="stylesheet"]':"";if(s)for(let f=r.length-1;f>=0;f--){const g=r[f];if(g.href===c&&(!m||g.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${u}`))return;const h=document.createElement("link");if(h.rel=m?"stylesheet":Js,m||(h.as="script"),h.crossOrigin="",h.href=c,l&&h.setAttribute("nonce",l),document.head.appendChild(h),m)return new Promise((f,g)=>{h.addEventListener("load",f),h.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${c}`)))})}))}function i(r){const d=new Event("vite:preloadError",{cancelable:!0});if(d.payload=r,window.dispatchEvent(d),!d.defaultPrevented)throw r}return a.then(r=>{for(const d of r||[])d.status==="rejected"&&i(d.reason);return e().catch(i)})};class Zs{constructor(){this.API_KEY="0ecf01914957b40c17030db822845a76",this.API_SECRET="bd37e61e0b16b8c7bf8de2862de5493c",this.API_URL="https://ws.audioscrobbler.com/2.0/",this.sessionKey=null,this.username=null,this.currentTrack=null,this.scrobbleTimer=null,this.scrobbleThreshold=0,this.hasScrobbled=!1,this.loadSession()}loadSession(){try{const e=localStorage.getItem("lastfm-session");if(e){const t=JSON.parse(e);this.sessionKey=t.key,this.username=t.name}}catch(e){console.error("Failed to load Last.fm session:",e)}}saveSession(e,t){this.sessionKey=e,this.username=t,localStorage.setItem("lastfm-session",JSON.stringify({key:e,name:t}))}clearSession(){this.sessionKey=null,this.username=null,localStorage.removeItem("lastfm-session")}isAuthenticated(){return!!this.sessionKey}async generateSignature(e){const t={...e};delete t.format,delete t.callback;const a=Object.keys(t).sort().map(i=>`${i}${t[i]}`).join("")+this.API_SECRET;console.log("Signature string:",a);try{const{default:i}=await Q(async()=>{const{default:r}=await import("https://cdn.jsdelivr.net/npm/md5@2.3.0/+esm");return{default:r}},[],import.meta.url);return i(a)}catch{throw console.error("MD5 library not available"),new Error("MD5 library required for Last.fm")}}async makeRequest(e,t={},s=!1){const a={method:e,api_key:this.API_KEY,...t};s&&this.sessionKey&&(a.sk=this.sessionKey);const i=await this.generateSignature(a),r=new URLSearchParams({...a,api_sig:i,format:"json"});try{const l=await(await fetch(this.API_URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r})).json();if(l.error)throw new Error(l.message||"Last.fm API error");return l}catch(d){throw console.error("Last.fm API request failed:",d),d}}async getAuthUrl(){try{const t=(await this.makeRequest("auth.getToken")).token;return{token:t,url:`https://www.last.fm/api/auth/?api_key=${this.API_KEY}&token=${t}`}}catch(e){throw console.error("Failed to get auth URL:",e),e}}async completeAuthentication(e){try{const t=await this.makeRequest("auth.getSession",{token:e});if(t.session)return this.saveSession(t.session.key,t.session.name),{success:!0,username:t.session.name};throw new Error("No session returned")}catch(t){throw console.error("Authentication failed:",t),t}}async updateNowPlaying(e){if(this.isAuthenticated()){this.currentTrack=e,this.hasScrobbled=!1,this.clearScrobbleTimer();try{const t={artist:e.artist?.name||e.artists?.[0]?.name||"Unknown Artist",track:e.title};e.album?.title&&(t.album=e.album.title),e.duration&&(t.duration=Math.floor(e.duration)),e.trackNumber&&(t.trackNumber=e.trackNumber),await this.makeRequest("track.updateNowPlaying",t,!0),console.log("Now playing updated:",e.title),this.scrobbleThreshold=Math.min(e.duration/2,240),this.scheduleScrobble(this.scrobbleThreshold*1e3)}catch(t){console.error("Failed to update now playing:",t)}}}scheduleScrobble(e){this.clearScrobbleTimer(),this.scrobbleTimer=setTimeout(()=>{this.scrobbleCurrentTrack()},e)}clearScrobbleTimer(){this.scrobbleTimer&&(clearTimeout(this.scrobbleTimer),this.scrobbleTimer=null)}async scrobbleCurrentTrack(){if(!(!this.isAuthenticated()||!this.currentTrack||this.hasScrobbled))try{const e=Math.floor(Date.now()/1e3),t={artist:this.currentTrack.artist?.name||this.currentTrack.artists?.[0]?.name||"Unknown Artist",track:this.currentTrack.title,timestamp:e};this.currentTrack.album?.title&&(t.album=this.currentTrack.album.title),this.currentTrack.duration&&(t.duration=Math.floor(this.currentTrack.duration)),this.currentTrack.trackNumber&&(t.trackNumber=this.currentTrack.trackNumber),await this.makeRequest("track.scrobble",t,!0),this.hasScrobbled=!0,console.log("Scrobbled:",this.currentTrack.title)}catch(e){console.error("Failed to scrobble:",e)}}async loveTrack(e){if(this.isAuthenticated())try{const t={artist:e.artist?.name||e.artists?.[0]?.name||"Unknown Artist",track:e.title};await this.makeRequest("track.love",t,!0),console.log("Loved track on Last.fm:",e.title)}catch(t){console.error("Failed to love track on Last.fm:",t)}}onTrackChange(e){this.isAuthenticated()&&this.updateNowPlaying(e)}onPlaybackStop(){this.clearScrobbleTimer()}disconnect(){this.clearSession(),this.clearScrobbleTimer(),this.currentTrack=null}}function en(n){return()=>{const t=window.location.hash.substring(1)||"home",[s,a]=t.split("/");switch(s){case"search":n.renderSearchPage(decodeURIComponent(a));break;case"album":n.renderAlbumPage(a);break;case"artist":n.renderArtistPage(a);break;case"playlist":n.renderPlaylistPage(a,"api");break;case"userplaylist":n.renderPlaylistPage(a,"user");break;case"mix":n.renderMixPage(a);break;case"library":n.renderLibraryPage();break;case"recent":n.renderRecentPage();break;case"home":n.renderHomePage();break;default:n.showPage(s);break}}}function Qt(n){if(n.currentTrack){const e=n.currentTrack;document.title=`${e.title} • ${ee(e)}`}else{const e=window.location.hash;if(e.includes("#album/")||e.includes("#playlist/"))return;document.title="Monochrome Music"}}class tn{constructor(){this.user=null,this.unsubscribe=null,this.init()}init(){X&&(this.unsubscribe=es(X,e=>{this.user=e,this.updateUI(e),e?(console.log("User logged in:",e.uid),U.initialize(e)):(console.log("User logged out"),U.disconnect())}))}async signInWithGoogle(){if(!X){alert("Firebase is not configured. Please check console.");return}try{return(await ts(X,Ut)).user}catch(e){throw console.error("Login failed:",e),alert(`Login failed: ${e.message}`),e}}async signInWithEmail(e,t){if(!X){alert("Firebase is not configured.");return}try{return(await ss(X,e,t)).user}catch(s){throw console.error("Email Login failed:",s),alert(`Login failed: ${s.message}`),s}}async signUpWithEmail(e,t){if(!X){alert("Firebase is not configured.");return}try{return(await ns(X,e,t)).user}catch(s){throw console.error("Sign Up failed:",s),alert(`Sign Up failed: ${s.message}`),s}}async signOut(){if(X)try{await as(X)}catch(e){throw console.error("Logout failed:",e),e}}updateUI(e){const t=document.getElementById("firebase-connect-btn"),s=document.getElementById("firebase-clear-cloud-btn"),a=document.getElementById("firebase-status"),i=document.getElementById("email-auth-container"),r=document.getElementById("toggle-email-auth-btn");t&&(e?(t.textContent="Sign Out",t.classList.add("danger"),t.onclick=()=>this.signOut(),s&&(s.style.display="block"),i&&(i.style.display="none"),r&&(r.style.display="none"),a&&(a.textContent=`Signed in as ${e.email}`)):(t.textContent="Connect with Google",t.classList.remove("danger"),t.onclick=()=>this.signInWithGoogle(),s&&(s.style.display="none"),r&&(r.style.display="inline-block"),a&&(a.textContent="Sync your library across devices")))}}const Ae=new tn;function sn(n,e,t,s){Ae.updateUI(Ae.user),Vs();const a=document.getElementById("toggle-email-auth-btn"),i=document.getElementById("cancel-email-auth-btn"),r=document.getElementById("email-auth-container"),d=document.getElementById("auth-buttons-container"),l=document.getElementById("auth-email"),o=document.getElementById("auth-password"),c=document.getElementById("email-signin-btn"),m=document.getElementById("email-signup-btn");a&&r&&d&&a.addEventListener("click",()=>{r.style.display="flex",d.style.display="none"}),i&&r&&d&&i.addEventListener("click",()=>{r.style.display="none",d.style.display="flex"}),c&&c.addEventListener("click",async()=>{const E=l.value,_=o.value;if(!E||!_){alert("Please enter both email and password.");return}try{await Ae.signInWithEmail(E,_),r.style.display="none",d.style.display="flex",l.value="",o.value=""}catch{}}),m&&m.addEventListener("click",async()=>{const E=l.value,_=o.value;if(!E||!_){alert("Please enter both email and password.");return}try{await Ae.signUpWithEmail(E,_),r.style.display="none",d.style.display="flex",l.value="",o.value=""}catch{}});const u=document.getElementById("lastfm-connect-btn"),h=document.getElementById("lastfm-status"),f=document.getElementById("lastfm-toggle"),g=document.getElementById("lastfm-toggle-setting"),p=document.getElementById("lastfm-love-toggle"),w=document.getElementById("lastfm-love-setting");function I(){n.isAuthenticated()?(h.textContent=`Connected as ${n.username}`,u.textContent="Disconnect",u.classList.add("danger"),g.style.display="flex",w.style.display="flex",f.checked=le.isEnabled(),p.checked=le.shouldLoveOnLike()):(h.textContent="Connect your Last.fm account to scrobble tracks",u.textContent="Connect Last.fm",u.classList.remove("danger"),g.style.display="none",w.style.display="none")}I(),u?.addEventListener("click",async()=>{if(n.isAuthenticated()){confirm("Disconnect from Last.fm?")&&(n.disconnect(),I());return}const E=window.open("","_blank");u.disabled=!0,u.textContent="Opening Last.fm...";try{const{token:_,url:D}=await n.getAuthUrl();if(E)E.location.href=D;else{alert("Popup blocked! Please allow popups."),u.textContent="Connect Last.fm",u.disabled=!1;return}u.textContent="Waiting for authorization...";let F=0;const ae=30,K=setInterval(async()=>{if(F++,F>ae){clearInterval(K),u.textContent="Connect Last.fm",u.disabled=!1,E&&!E.closed&&E.close(),alert("Authorization timed out. Please try again.");return}try{const Ge=await n.completeAuthentication(_);Ge.success&&(clearInterval(K),E&&!E.closed&&E.close(),I(),u.disabled=!1,le.setEnabled(!0),f.checked=!0,alert(`Successfully connected to Last.fm as ${Ge.username}!`))}catch{}},2e3)}catch(_){console.error("Last.fm connection failed:",_),alert("Failed to connect to Last.fm: "+_.message),u.textContent="Connect Last.fm",u.disabled=!1,E&&!E.closed&&E.close()}}),f?.addEventListener("change",E=>{le.setEnabled(E.target.checked)}),p?.addEventListener("change",E=>{le.setLoveOnLike(E.target.checked)});const y=document.getElementById("theme-picker"),b=oe.getTheme();y.querySelectorAll(".theme-option").forEach(E=>{E.dataset.theme===b&&E.classList.add("active"),E.addEventListener("click",()=>{const _=E.dataset.theme;y.querySelectorAll(".theme-option").forEach(D=>D.classList.remove("active")),E.classList.add("active"),_==="custom"?(document.getElementById("custom-theme-editor").classList.add("show"),k(),oe.setTheme("custom")):(document.getElementById("custom-theme-editor").classList.remove("show"),oe.setTheme(_))})});function k(){const E=document.getElementById("theme-color-grid"),_=oe.getCustomTheme()||{background:"#000000",foreground:"#fafafa",primary:"#ffffff",secondary:"#27272a",muted:"#27272a",border:"#27272a",highlight:"#ffffff"};E.innerHTML=Object.entries(_).map(([D,F])=>`
            <div class="theme-color-input">
                <label>${D}</label>
                <input type="color" data-color="${D}" value="${F}">
            </div>
        `).join("")}document.getElementById("apply-custom-theme")?.addEventListener("click",()=>{const E={};document.querySelectorAll('#theme-color-grid input[type="color"]').forEach(_=>{E[_.dataset.color]=_.value}),oe.setCustomTheme(E)}),document.getElementById("reset-custom-theme")?.addEventListener("click",()=>{k()});const T=document.getElementById("streaming-quality-setting");if(T){const E=localStorage.getItem("playback-quality")||"LOSSLESS";T.value=E,e.setQuality(E),T.addEventListener("change",_=>{const D=_.target.value;e.setQuality(D),localStorage.setItem("playback-quality",D)})}const v=document.getElementById("download-quality-setting");v&&(v.value=ce.getQuality(),v.addEventListener("change",E=>{ce.setQuality(E.target.value)}));const S=document.getElementById("replay-gain-mode");S&&(S.value=ve.getMode(),S.addEventListener("change",E=>{ve.setMode(E.target.value),e.applyReplayGain()}));const L=document.getElementById("replay-gain-preamp");L&&(L.value=ve.getPreamp(),L.addEventListener("change",E=>{ve.setPreamp(parseFloat(E.target.value)||3),e.applyReplayGain()}));const A=document.getElementById("now-playing-mode");A&&(A.value=at.getMode(),A.addEventListener("change",E=>{at.setMode(E.target.value)}));const C=document.getElementById("track-list-actions-mode");C&&(C.value=it.getMode(),C.addEventListener("change",E=>{it.setMode(E.target.value)}));const x=document.getElementById("compact-artist-toggle");x&&(x.checked=se.isCompactArtist(),x.addEventListener("change",E=>{se.setCompactArtist(E.target.checked)}));const B=document.getElementById("compact-album-toggle");B&&(B.checked=se.isCompactAlbum(),B.addEventListener("change",E=>{se.setCompactAlbum(E.target.checked)}));const P=document.getElementById("download-lyrics-toggle");P&&(P.checked=Ce.shouldDownloadLyrics(),P.addEventListener("change",E=>{Ce.setDownloadLyrics(E.target.checked)}));const $=document.getElementById("romaji-lyrics-toggle");$&&($.checked=localStorage.getItem("lyricsRomajiMode")==="true",$.addEventListener("change",E=>{localStorage.setItem("lyricsRomajiMode",E.target.checked?"true":"false")}));const R=document.getElementById("album-background-toggle");R&&(R.checked=we.isEnabled(),R.addEventListener("change",E=>{we.setEnabled(E.target.checked)}));const O=document.getElementById("waveform-toggle");O&&(O.checked=rt.isEnabled(),O.addEventListener("change",E=>{rt.setEnabled(E.target.checked),window.dispatchEvent(new CustomEvent("waveform-toggle",{detail:{enabled:E.target.checked}}))}));const z=document.getElementById("smooth-scrolling-toggle");z&&(z.checked=ot.isEnabled(),z.addEventListener("change",E=>{ot.setEnabled(E.target.checked),window.dispatchEvent(new CustomEvent("smooth-scrolling-toggle",{detail:{enabled:E.target.checked}}))}));const G=document.getElementById("filename-template");G&&(G.value=localStorage.getItem("filename-template")||"{trackNumber} - {artist} - {title}",G.addEventListener("change",E=>{localStorage.setItem("filename-template",E.target.value)}));const te=document.getElementById("zip-folder-template");te&&(te.value=localStorage.getItem("zip-folder-template")||"{albumTitle} - {albumArtist}",te.addEventListener("change",E=>{localStorage.setItem("zip-folder-template",E.target.value)})),document.getElementById("refresh-speed-test-btn")?.addEventListener("click",async()=>{const E=document.getElementById("refresh-speed-test-btn"),_=E.textContent;E.textContent="Testing...",E.disabled=!0;try{await t.settings.refreshSpeedTests(),s.renderApiSettings(),E.textContent="Done!",setTimeout(()=>{E.textContent=_,E.disabled=!1},1500)}catch(D){console.error("Failed to refresh speed tests:",D),E.textContent="Error",setTimeout(()=>{E.textContent=_,E.disabled=!1},1500)}}),document.getElementById("api-instance-list")?.addEventListener("click",async E=>{const _=E.target.closest("button");if(!_)return;const D=_.closest("li"),F=parseInt(D.dataset.index,10),ae=D.dataset.type||"api",K=await t.settings.getInstances(ae);_.classList.contains("move-up")&&F>0?[K[F],K[F-1]]=[K[F-1],K[F]]:_.classList.contains("move-down")&&F<K.length-1&&([K[F],K[F+1]]=[K[F+1],K[F]]),t.settings.saveInstances(K,ae),s.renderApiSettings()}),document.getElementById("clear-cache-btn")?.addEventListener("click",async()=>{const E=document.getElementById("clear-cache-btn"),_=E.textContent;E.textContent="Clearing...",E.disabled=!0;try{await t.clearCache(),E.textContent="Cleared!",setTimeout(()=>{E.textContent=_,E.disabled=!1,window.location.hash.includes("settings")&&s.renderApiSettings()},1500)}catch(D){console.error("Failed to clear cache:",D),E.textContent="Error",setTimeout(()=>{E.textContent=_,E.disabled=!1},1500)}}),document.getElementById("firebase-clear-cloud-btn")?.addEventListener("click",async()=>{if(confirm("Are you sure you want to delete ALL your data from the cloud? This cannot be undone."))try{await U.clearCloudData(),alert("Cloud data cleared successfully."),Ae.signOut()}catch(E){console.error("Failed to clear cloud data:",E),alert("Failed to clear cloud data: "+E.message)}}),document.getElementById("export-library-btn")?.addEventListener("click",async()=>{const E=await M.exportData(),_=new Blob([JSON.stringify(E,null,2)],{type:"application/json"}),D=URL.createObjectURL(_),F=document.createElement("a");F.href=D,F.download=`monochrome-library-${new Date().toISOString().split("T")[0]}.json`,F.click(),URL.revokeObjectURL(D)});const q=document.getElementById("import-library-input");document.getElementById("import-library-btn")?.addEventListener("click",()=>{q.click()}),q?.addEventListener("change",async E=>{const _=E.target.files[0];if(!_)return;const D=new FileReader;D.onload=async F=>{try{const ae=JSON.parse(F.target.result);await M.importData(ae),alert("Library imported successfully!"),window.location.reload()}catch(ae){console.error("Import failed:",ae),alert("Failed to import library. Please check the file format.")}},D.readAsText(_)})}const $e=new Map,Pe=new Map,nt=new Set;let V=null;function dt(n,e,t){if(!t)return;const s=e?`${e}/cover.jpg`:"cover.jpg";n.file(s)||n.file(s,t)}async function nn(){try{return(await Q(()=>import("https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm"),[],import.meta.url)).default}catch(n){throw console.error("Failed to load JSZip:",n),new Error("Failed to load ZIP library")}}function ut(){return V||(V=document.createElement("div"),V.id="download-notifications",document.body.appendChild(V)),V}function W(n){const e=ut(),t=document.createElement("div");t.className="download-task",t.innerHTML=`
        <div style="display: flex; align-items: start;">
            ${n}
        </div>
    `,e.appendChild(t),setTimeout(()=>{t.style.animation="slideOut 0.3s ease",setTimeout(()=>t.remove(),300)},1500)}function zt(n,e,t,s,a){const i=ut(),r=document.createElement("div");r.className="download-task",r.dataset.trackId=n;const d=ne(e),l=ee(e);return r.innerHTML=`
        <div style="display: flex; align-items: start; gap: 0.75rem;">
            <img src="${s.getCoverUrl(e.album?.cover)}"
                 style="width: 40px; height: 40px; border-radius: 4px; flex-shrink: 0;">
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 500; font-size: 0.9rem; margin-bottom: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${d}</div>
                <div style="font-size: 0.8rem; color: var(--muted-foreground); margin-bottom: 0.5rem;">${l}</div>
                <div class="download-progress-bar" style="height: 4px; background: var(--secondary); border-radius: 2px; overflow: hidden;">
                    <div class="download-progress-fill" style="width: 0%; height: 100%; background: var(--highlight); transition: width 0.2s;"></div>
                </div>
                <div class="download-status" style="font-size: 0.75rem; color: var(--muted-foreground); margin-top: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Starting...</div>
            </div>
            <button class="download-cancel" style="background: transparent; border: none; color: var(--muted-foreground); cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s;">
                ${_e}
            </button>
        </div>
    `,i.appendChild(r),$e.set(n,{taskEl:r,abortController:a}),r.querySelector(".download-cancel").addEventListener("click",()=>{a.abort(),qe(n)}),{taskEl:r,abortController:a}}function Kt(n,e){const t=$e.get(n);if(!t)return;const{taskEl:s}=t,a=s.querySelector(".download-progress-fill"),i=s.querySelector(".download-status");if(e.stage==="downloading"){const r=e.totalBytes?Math.round(e.receivedBytes/e.totalBytes*100):0;a.style.width=`${r}%`;const d=(e.receivedBytes/(1024*1024)).toFixed(1),l=e.totalBytes?(e.totalBytes/(1024*1024)).toFixed(1):"?";i.textContent=`Downloading: ${d}MB / ${l}MB (${r}%)`}}function lt(n,e=!0,t=null){const s=$e.get(n);if(!s)return;const{taskEl:a}=s,i=a.querySelector(".download-progress-fill"),r=a.querySelector(".download-status"),d=a.querySelector(".download-cancel");e?(i.style.width="100%",i.style.background="#10b981",r.textContent="✓ Downloaded",r.style.color="#10b981",d.remove(),setTimeout(()=>qe(n),3e3)):(i.style.background="#ef4444",r.textContent=t||"✗ Download failed",r.style.color="#ef4444",d.innerHTML=`
            ${_e}
        `,d.onclick=()=>qe(n),setTimeout(()=>qe(n),5e3))}function qe(n){const e=$e.get(n);if(!e)return;const{taskEl:t}=e;t.style.animation="slideOut 0.3s ease",setTimeout(()=>{t.remove(),$e.delete(n),V&&V.children.length===0&&(V.remove(),V=null)},300)}function an(n){Pe.get(n)&&(n.style.animation="slideOut 0.3s ease",setTimeout(()=>{n.remove(),Pe.delete(n),V&&V.children.length===0&&(V.remove(),V=null)},300))}async function Wt(n,e,t,s=null,a=null){let i={...n,artist:n.artist||(n.artists&&n.artists.length>0?n.artists[0]:null)};if(i.album&&!i.album.title&&i.album.id)try{const c=await t.getAlbum(i.album.id);c.album&&(i.album={...i.album,...c.album})}catch(c){console.warn("Failed to fetch album data for metadata:",c)}const r=await t.getTrack(n.id,e);let d;if(r.originalTrackUrl)d=r.originalTrackUrl;else if(d=t.extractStreamUrlFromManifest(r.info.manifest),!d)throw new Error("Could not resolve stream URL");const l=await fetch(d,{signal:a});if(!l.ok)throw new Error(`Failed to fetch track: ${l.status}`);let o=await l.blob();return o=await _t(o,i,t,e),o}async function Ke(n,e,t,s,a=null){ht(t,s,s,"Creating ZIP...");try{if(a){const i=await a.createWritable();await new Promise((r,d)=>{n.generateInternalStream({type:"uint8array",compression:"STORE",streamFiles:!0}).on("data",(l,o)=>{i.write(l)}).on("error",l=>{i.close(),d(l)}).on("end",()=>{i.close(),r()}).resume()})}else{const i=await n.generateAsync({type:"blob",compression:"STORE",streamFiles:!0}),r=URL.createObjectURL(i),d=document.createElement("a");d.href=r,d.download=`${e}.zip`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(r)}Te(t,!0)}catch(i){console.error("ZIP generation failed:",i),Te(t,!1,"ZIP creation failed")}}async function We(n,e=!1){const t=await nn(),s=new t;let a=null;if(e&&window.showSaveFilePicker)try{a=await window.showSaveFilePicker({suggestedName:`${n}.zip`,types:[{description:"ZIP Archive",accept:{"application/zip":[".zip"]}}]})}catch(i){if(i.name==="AbortError")return null;throw i}return{zip:s,fileHandle:a}}async function mt(n,e,t,s,a,i,r,d=0,l=e.length){const{abortController:o}=Pe.get(r),c=o.signal;for(let m=0;m<e.length;m++){const u=e[m],h=d+m,f=Qe(u,a),g=ne(u);ht(r,h,l,g);try{const p=await Wt(u,a,s,null,c);if(n.file(`${t}/${f}`,p),i&&Ce.shouldDownloadLyrics())try{const w=await i.fetchLyrics(u.id,u);if(w){const I=i.generateLRCContent(w,u);if(I){const y=f.replace(/\.[^.]+$/,".lrc");n.file(`${t}/${y}`,I)}}}catch{console.log("Could not add lyrics for:",g)}}catch(p){if(p.name==="AbortError")throw p;console.error(`Failed to download track ${g}:`,p)}}}async function rn(n,e,t,s=null){const a=`Queue - ${new Date().toISOString().slice(0,10)}`,i=await We(a,n.length>=20);if(!i)return;const{zip:r,fileHandle:d}=i,l=Ve("queue","Queue",n.length);try{await mt(r,n,a,e,t,s,l),await Ke(r,a,l,n.length,d)}catch(o){if(o.name==="AbortError")return;throw Te(l,!1,o.message),o}}async function Vt(n,e,t,s,a=null){const i=n.releaseDate||(e[0]?.streamStartDate?e[0].streamStartDate.split("T")[0]:""),r=i?new Date(i):null,d=r&&!isNaN(r.getTime())?r.getFullYear():"",l=ze(localStorage.getItem("zip-folder-template")||"{albumTitle} - {albumArtist}",{albumTitle:n.title,albumArtist:n.artist?.name,year:d}),o=await We(l,e.length>=20);if(!o)return;const{zip:c,fileHandle:m}=o,u=await Re(t,n.cover||n.album?.cover||n.coverId),h=Ve("album",n.title,e.length);try{dt(c,l,u),await mt(c,e,l,t,s,a,h),await Ke(c,l,h,e.length,m)}catch(f){if(f.name==="AbortError")return;throw Te(h,!1,f.message),f}}async function ct(n,e,t,s,a=null){const i=ze(localStorage.getItem("zip-folder-template")||"{albumTitle} - {albumArtist}",{albumTitle:n.title,albumArtist:"Playlist",year:new Date().getFullYear()}),r=await We(i,e.length>=20);if(!r)return;const{zip:d,fileHandle:l}=r,o=Ve("playlist",n.title,e.length);try{const c=e.find(u=>u.album?.cover),m=await Re(t,c?.album?.cover);dt(d,i,m),await mt(d,e,i,t,s,a,o),await Ke(d,i,o,e.length,l)}catch(c){if(c.name==="AbortError")return;throw Te(o,!1,c.message),c}}async function Gt(n,e,t,s,a=null){const i=`${ye(n.name)} discography`,r=await We(i,!0);if(!r)return;const{zip:d,fileHandle:l}=r,o=Ve("discography",n.name,e.length),{abortController:c}=Pe.get(o),m=c.signal;try{for(let u=0;u<e.length;u++){const h=e[u];ht(o,u,e.length,h.title);try{const{album:f,tracks:g}=await t.getAlbum(h.id),p=await Re(t,f.cover||h.cover),w=f.releaseDate||(g[0]?.streamStartDate?g[0].streamStartDate.split("T")[0]:""),I=w?new Date(w):null,y=I&&!isNaN(I.getTime())?I.getFullYear():"",b=ze(localStorage.getItem("zip-folder-template")||"{albumTitle} - {albumArtist}",{albumTitle:f.title,albumArtist:f.artist?.name,year:y}),k=`${i}/${b}`;dt(d,k,p);for(const T of g){const v=Qe(T,s);try{const S=await Wt(T,s,t,null,m);if(d.file(`${k}/${v}`,S),a&&Ce.shouldDownloadLyrics())try{const L=await a.fetchLyrics(T.id,T);if(L){const A=a.generateLRCContent(L,T);if(A){const C=v.replace(/\.[^.]+$/,".lrc");d.file(`${k}/${C}`,A)}}}catch{}}catch(S){if(S.name==="AbortError")throw S;console.error(`Failed to download track ${T.title}:`,S)}}}catch(f){if(f.name==="AbortError")throw f;console.error(`Failed to download album ${h.title}:`,f)}}await Ke(d,i,o,e.length,l)}catch(u){if(u.name==="AbortError")return;throw Te(o,!1,u.message),u}}function Ve(n,e,t){const s=ut(),a=document.createElement("div");a.className="download-task bulk-download",a.dataset.bulkType=n,a.dataset.bulkName=e;const i=n==="album"?"Album":n==="playlist"?"Playlist":"Discography";a.innerHTML=`
        <div style="display: flex; align-items: start; gap: 0.75rem;">
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.25rem;">
                    Downloading ${i}
                </div>
                <div style="font-size: 0.85rem; color: var(--muted-foreground); margin-bottom: 0.5rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${e}</div>
                <div class="download-progress-bar" style="height: 4px; background: var(--secondary); border-radius: 2px; overflow: hidden;">
                    <div class="download-progress-fill" style="width: 0%; height: 100%; background: var(--highlight); transition: width 0.2s;"></div>
                </div>
                <div class="download-status" style="font-size: 0.75rem; color: var(--muted-foreground); margin-top: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Starting...</div>
            </div>
            <button class="download-cancel" style="background: transparent; border: none; color: var(--muted-foreground); cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s;">
                ${_e}
            </button>
        </div>
    `,s.appendChild(a);const r=new AbortController;return Pe.set(a,{abortController:r}),a.querySelector(".download-cancel").addEventListener("click",()=>{r.abort(),an(a)}),a}function ht(n,e,t,s){const a=n.querySelector(".download-progress-fill"),i=n.querySelector(".download-status"),r=t>0?Math.round(e/t*100):0;a.style.width=`${r}%`,i.textContent=`${e}/${t} - ${s}`}function Te(n,e=!0,t=null){const s=n.querySelector(".download-progress-fill"),a=n.querySelector(".download-status");e?(s.style.width="100%",s.style.background="#10b981",a.textContent="✓ Download complete",a.style.color="#10b981",setTimeout(()=>{n.style.animation="slideOut 0.3s ease",setTimeout(()=>n.remove(),300)},3e3)):(s.style.background="#ef4444",a.textContent=t||"✗ Download failed",a.style.color="#ef4444",setTimeout(()=>{n.style.animation="slideOut 0.3s ease",setTimeout(()=>n.remove(),300)},5e3))}async function Yt(n,e,t,s=null,a=null){if(!n){alert("No track is currently playing");return}const i=`track-${n.id}`;if(nt.has(i)){W("This track is already being downloaded");return}let r={...n,artist:n.artist||(n.artists&&n.artists.length>0?n.artists[0]:null)};if(r.album&&!r.album.title&&r.album.id)try{const o=await t.getAlbum(r.album.id);o.album&&(r.album={...r.album,...o.album})}catch(o){console.warn("Failed to fetch album data for metadata:",o)}const d=Qe(r,e),l=a||new AbortController;nt.add(i);try{const{taskEl:o}=zt(n.id,r,d,t,l);if(await t.downloadTrack(n.id,e,d,{signal:l.signal,track:r,onProgress:c=>{Kt(n.id,c)}}),lt(n.id,!0),s&&Ce.shouldDownloadLyrics())try{const c=await s.fetchLyrics(n.id,n);c&&s.downloadLRC(c,n)}catch{console.log("Could not download lyrics for track")}}catch(o){if(o.name!=="AbortError"){const c=o.message===Mt?o.message:"Download failed. Please try again.";lt(n.id,!1,c)}}finally{nt.delete(i)}}const Oe=Object.freeze(Object.defineProperty({__proto__:null,addDownloadTask:zt,completeDownloadTask:lt,downloadAlbumAsZip:Vt,downloadDiscography:Gt,downloadPlaylistAsZip:ct,downloadTrackWithMetadata:Yt,downloadTracks:rn,showNotification:W,updateDownloadProgress:Kt},Symbol.toStringTag,{value:"Module"}));class on{constructor(){this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.cache=new Map}async getWaveform(e,t){if(this.cache.has(t))return this.cache.get(t);try{const a=await(await fetch(e)).arrayBuffer(),i=await this.audioContext.decodeAudioData(a),d={peaks:this.extractPeaks(i),duration:i.duration};return this.cache.set(t,d),d}catch(s){return console.error("Waveform generation failed:",s),null}}extractPeaks(e){const{length:t,duration:s}=e,a=Math.min(Math.floor(4*s),1e3),i=new Float32Array(a),r=e.getChannelData(0),d=Math.floor(t/a),l=8;for(let c=0;c<a;c++){let m=0;const u=c*d,h=u+d;for(let f=u;f<h;f+=l){const g=r[f];g>m?m=g:-g>m&&(m=-g)}i[c]=m}let o=0;for(let c=0;c<a;c++)i[c]>o&&(o=i[c]);if(o>0)for(let c=0;c<a;c++)i[c]/=o;return i}drawWaveform(e,t){if(!e||!t)return;const s=e.getContext("2d"),a=e.width,i=e.height;s.clearRect(0,0,a,i);const r=a/t.length,d=i/2;s.fillStyle="#000",s.beginPath(),s.moveTo(0,d);for(let l=0;l<t.length;l++){const o=t[l],c=Math.max(1.5,o*i*.9);s.lineTo(l*r,d-c/2)}for(let l=t.length-1;l>=0;l--){const o=t[l],c=Math.max(1.5,o*i*.9);s.lineTo(l*r,d+c/2)}s.closePath(),s.fill()}}const Ue=new on;let Ne=null;function ln(n,e,t,s){const a=document.querySelector(".play-pause-btn"),i=document.getElementById("next-btn"),r=document.getElementById("prev-btn"),d=document.getElementById("shuffle-btn"),l=document.getElementById("repeat-btn"),o=document.getElementById("sleep-timer-btn-desktop"),c=document.getElementById("sleep-timer-btn");let m=null;n.shuffleActive&&d.classList.add("active"),n.repeatMode!==J.OFF?(l.classList.add("active"),n.repeatMode===J.ONE&&l.classList.add("repeat-one"),l.title=n.repeatMode===J.ALL?"Repeat Queue":"Repeat One"):l.title="Repeat",e.addEventListener("play",()=>{n.currentTrack&&(t.isAuthenticated()&&le.isEnabled()&&t.updateNowPlaying(n.currentTrack),Ue.audioContext.state==="suspended"&&Ue.audioContext.resume(),g()),a.innerHTML=ls,n.updateMediaSessionPlaybackState(),n.updateMediaSessionPositionState(),Qt(n)}),e.addEventListener("playing",()=>{n.updateMediaSessionPlaybackState(),n.updateMediaSessionPositionState()}),e.addEventListener("pause",()=>{a.innerHTML=he,n.updateMediaSessionPlaybackState(),n.updateMediaSessionPositionState()}),e.addEventListener("ended",()=>{n.playNext()}),e.addEventListener("timeupdate",async()=>{const{currentTime:y,duration:b}=e;if(b){const k=document.getElementById("progress-fill"),T=document.getElementById("current-time");if(k.style.width=`${y/b*100}%`,T.textContent=xe(y),y>=10&&n.currentTrack&&n.currentTrack.id!==m){m=n.currentTrack.id;const v=await M.addToHistory(n.currentTrack);U.syncHistoryItem(v),window.location.hash==="#recent"&&s.renderRecentPage()}}}),e.addEventListener("loadedmetadata",()=>{const y=document.getElementById("total-duration");y.textContent=xe(e.duration),n.updateMediaSessionPositionState()}),e.addEventListener("error",y=>{console.error("Audio playback error:",y),document.querySelector(".now-playing-bar .artist").textContent="Playback error. Try another track.",a.innerHTML=he}),a.addEventListener("click",()=>n.handlePlayPause()),i.addEventListener("click",()=>n.playNext()),r.addEventListener("click",()=>n.playPrev()),d.addEventListener("click",()=>{n.toggleShuffle(),d.classList.toggle("active",n.shuffleActive),window.renderQueueFunction&&window.renderQueueFunction()}),l.addEventListener("click",()=>{const y=n.toggleRepeat();l.classList.toggle("active",y!==J.OFF),l.classList.toggle("repeat-one",y===J.ONE),l.title=y===J.OFF?"Repeat":y===J.ALL?"Repeat Queue":"Repeat One"}),o&&o.addEventListener("click",()=>{n.isSleepTimerActive()?(n.clearSleepTimer(),W("Sleep timer cancelled")):Lt(n)}),c&&c.addEventListener("click",()=>{n.isSleepTimerActive()?(n.clearSleepTimer(),W("Sleep timer cancelled")):Lt(n)});const u=document.getElementById("volume-bar"),h=document.getElementById("volume-fill"),f=document.getElementById("volume-btn"),g=async()=>{const y=document.getElementById("progress-bar"),b=document.querySelector(".player-controls");if(!rt.isEnabled()||!n.currentTrack){y&&(y.style.webkitMaskImage="",y.style.maskImage="",y.classList.remove("has-waveform","waveform-loaded")),b&&b.classList.remove("waveform-loaded"),Ne=null;return}if(y&&Ne!==n.currentTrack.id){Ne=n.currentTrack.id,y.classList.add("has-waveform"),y.classList.remove("waveform-loaded"),b&&b.classList.remove("waveform-loaded"),y.style.webkitMaskImage="",y.style.maskImage="";try{const k=await n.api.getStreamUrl(n.currentTrack.id,"LOW"),T=await Ue.getWaveform(k,n.currentTrack.id);if(T&&Ne===n.currentTrack.id){let{peaks:v,duration:S}=T;const L=n.currentTrack.duration;if(L&&S&&S<L){const B=L-S;if(B>.5){const P=v.length/S,$=Math.floor(B*P);if($>0){const R=new Float32Array(v.length+$);R.set(v,$),v=R}}}const A=document.createElement("canvas"),C=y.getBoundingClientRect();A.width=C.width||500,A.height=28,Ue.drawWaveform(A,v);const x=A.toDataURL();y.style.webkitMaskImage=`url(${x})`,y.style.webkitMaskSize="100% 100%",y.style.webkitMaskRepeat="no-repeat",y.style.maskImage=`url(${x})`,y.style.maskSize="100% 100%",y.style.maskRepeat="no-repeat",y.classList.add("waveform-loaded"),b&&b.classList.add("waveform-loaded")}}catch(k){console.error("Failed to load waveform mask:",k)}}};window.addEventListener("waveform-toggle",y=>{if(!y.detail.enabled){const b=document.getElementById("progress-bar"),k=document.querySelector(".player-controls");b&&(b.style.webkitMaskImage="",b.style.maskImage="",b.classList.remove("has-waveform","waveform-loaded")),k&&k.classList.remove("waveform-loaded")}g()});const p=()=>{const{muted:y}=e,b=n.userVolume;f.innerHTML=y||b===0?ds:cs;const k=y?0:b*100;h.style.setProperty("--volume-level",`${k}%`),h.style.width=`${k}%`};f.addEventListener("click",()=>{e.muted=!e.muted,localStorage.setItem("muted",e.muted)}),e.addEventListener("volumechange",p);const w=parseFloat(localStorage.getItem("volume")||"0.7"),I=localStorage.getItem("muted")==="true";n.setVolume(w),e.muted=I,h.style.width=`${w*100}%`,u.style.setProperty("--volume-level",`${w*100}%`),p(),cn(e,n)}function cn(n,e){const t=document.getElementById("progress-bar"),s=document.getElementById("progress-fill"),a=document.getElementById("volume-bar"),i=document.getElementById("volume-fill"),r=document.getElementById("volume-btn");let d=!1,l=!1,o=!1;const c=(m,u,h)=>{const f=m.getBoundingClientRect(),g=Math.max(0,Math.min(1,(u.clientX-f.left)/f.width));h(g)};t.addEventListener("mousedown",m=>{d=!0,l=!n.paused,l&&n.pause(),c(t,m,u=>{isNaN(n.duration)||(n.currentTime=u*n.duration,s.style.width=`${u*100}%`)})}),t.addEventListener("touchstart",m=>{m.preventDefault(),d=!0,l=!n.paused,l&&n.pause();const u=m.touches[0],h=t.getBoundingClientRect(),f=Math.max(0,Math.min(1,(u.clientX-h.left)/h.width));isNaN(n.duration)||(n.currentTime=f*n.duration,s.style.width=`${f*100}%`)}),document.addEventListener("mousemove",m=>{d&&c(t,m,u=>{isNaN(n.duration)||(n.currentTime=u*n.duration,s.style.width=`${u*100}%`)}),o&&c(a,m,u=>{n.muted&&(n.muted=!1,localStorage.setItem("muted",!1)),e.setVolume(u),i.style.width=`${u*100}%`,a.style.setProperty("--volume-level",`${u*100}%`)})}),document.addEventListener("touchmove",m=>{if(d){const u=m.touches[0],h=t.getBoundingClientRect(),f=Math.max(0,Math.min(1,(u.clientX-h.left)/h.width));isNaN(n.duration)||(n.currentTime=f*n.duration,s.style.width=`${f*100}%`)}if(o){const u=m.touches[0],h=a.getBoundingClientRect(),f=Math.max(0,Math.min(1,(u.clientX-h.left)/h.width));n.muted&&(n.muted=!1,localStorage.setItem("muted",!1)),e.setVolume(f),i.style.width=`${f*100}%`,a.style.setProperty("--volume-level",`${f*100}%`)}}),document.addEventListener("mouseup",m=>{d&&(c(t,m,u=>{isNaN(n.duration)||(n.currentTime=u*n.duration,e.updateMediaSessionPositionState(),l&&n.play())}),d=!1),o&&(o=!1)}),document.addEventListener("touchend",m=>{d&&(isNaN(n.duration)||(e.updateMediaSessionPositionState(),l&&n.play()),d=!1),o&&(o=!1)}),t.addEventListener("click",m=>{d||c(t,m,u=>{if(!isNaN(n.duration)&&n.duration>0&&n.duration!==1/0)n.currentTime=u*n.duration,e.updateMediaSessionPositionState();else if(e.currentTrack&&e.currentTrack.duration){const h=u*e.currentTrack.duration,f=document.querySelector(".progress-fill");f&&(f.style.width=`${u*100}%`),e.playTrackFromQueue(h)}})}),a.addEventListener("mousedown",m=>{o=!0,c(a,m,u=>{n.muted&&(n.muted=!1,localStorage.setItem("muted",!1)),e.setVolume(u),i.style.width=`${u*100}%`,a.style.setProperty("--volume-level",`${u*100}%`)})}),a.addEventListener("touchstart",m=>{m.preventDefault(),o=!0;const u=m.touches[0],h=a.getBoundingClientRect(),f=Math.max(0,Math.min(1,(u.clientX-h.left)/h.width));n.muted&&(n.muted=!1,localStorage.setItem("muted",!1)),e.setVolume(f),i.style.width=`${f*100}%`,a.style.setProperty("--volume-level",`${f*100}%`)}),a.addEventListener("click",m=>{o||c(a,m,u=>{n.muted&&(n.muted=!1,localStorage.setItem("muted",!1)),e.setVolume(u),i.style.width=`${u*100}%`,a.style.setProperty("--volume-level",`${u*100}%`)})}),a.addEventListener("wheel",m=>{m.preventDefault();const u=m.deltaY>0?-.05:.05,h=Math.max(0,Math.min(1,e.userVolume+u));u>0&&n.muted&&(n.muted=!1,localStorage.setItem("muted",!1)),e.setVolume(h),i.style.width=`${h*100}%`,a.style.setProperty("--volume-level",`${h*100}%`)},{passive:!1}),r?.addEventListener("wheel",m=>{m.preventDefault();const u=m.deltaY>0?-.05:.05,h=Math.max(0,Math.min(1,e.userVolume+u));u>0&&n.muted&&(n.muted=!1,localStorage.setItem("muted",!1)),e.setVolume(h),i.style.width=`${h*100}%`,a.style.setProperty("--volume-level",`${h*100}%`)},{passive:!1})}async function me(n,e,t,s,a,i="track",r=null,d=null){if(e){if(n==="add-to-queue")t.addToQueue(e),window.renderQueueFunction&&window.renderQueueFunction(),W(`Added to queue: ${e.title}`);else if(n==="play-next")t.addNextToQueue(e),window.renderQueueFunction&&window.renderQueueFunction(),W(`Playing next: ${e.title}`);else if(n==="track-mix")e.mixes&&e.mixes.TRACK_MIX&&(window.location.hash=`#mix/${e.mixes.TRACK_MIX}`);else if(n==="play-card")try{let l=[];if(i==="album")l=(await s.getAlbum(e.id)).tracks;else if(i==="playlist")l=(await s.getPlaylist(e.uuid)).tracks;else if(i==="user-playlist"){let o=await M.getPlaylist(e.id);if(!o)try{o=await U.getPublicPlaylist(e.id)}catch{}l=o?o.tracks:e.tracks||[]}if(l.length>0){t.setQueue(l,0);const o=document.getElementById("shuffle-btn");o&&o.classList.remove("active"),t.playAtIndex(0);const c=i==="user-playlist"?e.name:e.title;W(`Playing ${i.replace("user-","")}: ${c}`)}else W(`No tracks found in this ${i}`)}catch(l){console.error("Failed to play card:",l),W(`Failed to play ${i}`)}else if(n==="download")await Yt(e,ce.getQuality(),s,a);else if(n==="toggle-like"){const l=await M.toggleFavorite(i,e);U.syncLibraryItem(i,e,l),l&&i==="track"&&d&&le.isEnabled()&&le.shouldLoveOnLike()&&d.loveTrack(e);const o=i==="playlist"?e.uuid:e.id,c=i==="track"?`[data-track-id="${o}"] .like-btn`:`.card[data-${i}-id="${o}"] .like-btn, .card[data-playlist-id="${o}"] .like-btn`,m=document.getElementById(`like-${i}-btn`),u=[...document.querySelectorAll(c)];m&&u.push(m);const h=document.getElementById("now-playing-like-btn");if(h&&i==="track"&&t?.currentTrack?.id===e.id&&u.push(h),u.forEach(f=>{const g=f.querySelector("svg");g&&(g.classList.toggle("filled",l),g.hasAttribute("fill")&&g.setAttribute("fill",l?"currentColor":"none")),f.classList.toggle("active",l),f.title=l?"Remove from Favorites":"Add to Favorites"}),window.location.hash==="#library"){const f=i==="track"?`.track-item[data-track-id="${o}"]`:`.card[data-${i}-id="${o}"], .card[data-playlist-id="${o}"]`,g=document.querySelector(f);if(!l&&g){const p=g.parentElement;if(g.remove(),p&&p.children.length===0){const w=i==="track"?"No liked tracks yet.":`No liked ${i}s yet.`;p.innerHTML=`<div class="placeholder-text">${w}</div>`}}else if(l&&!g&&r&&i==="track"){const p=document.getElementById("library-tracks-container");if(p){const w=p.querySelector(".placeholder-text");w&&w.remove();const I=p.children.length,y=r.createTrackItemHTML(e,I,!0,!1),b=document.createElement("div");b.innerHTML=y;const k=b.firstElementChild;k&&(p.appendChild(k),H.set(k,e),r.updateLikeState(k,"track",e.id))}}}}else if(n==="add-to-playlist"){const l=await M.getPlaylists(!0);if(l.length===0){W("No playlists yet. Create one first.");return}const o=document.getElementById("playlist-select-modal"),c=document.getElementById("playlist-select-list"),m=document.getElementById("playlist-select-cancel"),u=o.querySelector(".modal-overlay"),h=e.id,f=new Set;for(const y of l)y.tracks&&y.tracks.some(b=>b.id==h)&&f.add(y.id);const g='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';c.innerHTML=l.map(y=>{const b=f.has(y.id);return`
                <div class="modal-option ${b?"already-contains":""}" data-id="${y.id}">
                    <span>${y.name}</span>
                    ${b?`<span class="checkmark">${g}</span>`:""}
                </div>
            `}).join("");const p=()=>{o.classList.remove("active"),I()},w=async y=>{const b=y.target.closest(".modal-option");if(b){const k=b.dataset.id;if(f.has(k))return;await M.addTrackToPlaylist(k,e);const v=await M.getPlaylist(k);U.syncUserPlaylist(v,"update"),W(`Added to playlist: ${b.querySelector("span").textContent}`),p()}},I=()=>{m.removeEventListener("click",p),u.removeEventListener("click",p),c.removeEventListener("click",w)};m.addEventListener("click",p),u.addEventListener("click",p),c.addEventListener("click",w),o.classList.add("active")}}}async function St(n,e){if(!n||!e)return;const t=n.querySelector('li[data-action="toggle-like"]');if(t){const{db:a}=await Q(async()=>{const{db:r}=await Promise.resolve().then(()=>be);return{db:r}},void 0,import.meta.url),i=await a.isFavorite("track",e.id);t.textContent=i?"Unlike":"Like"}const s=n.querySelector('li[data-action="track-mix"]');if(s){const a=e.mixes&&e.mixes.TRACK_MIX;s.style.display=a?"block":"none"}}function dn(n,e,t,s,a,i,r){let d=null;t.addEventListener("click",async u=>{const h=u.target.closest(".track-action-btn, .like-btn, .play-btn");if(h&&h.dataset.action){u.preventDefault(),u.stopPropagation();const w=h.closest(".track-item, .card"),I=h.dataset.action,y=h.dataset.type||"track";let b=w?H.get(w):null;if(!b&&I==="toggle-like"){const k=window.location.hash.split("/")[1];if(k)try{y==="album"?b=(await e.getAlbum(k)).album:y==="artist"?b=await e.getArtist(k):y==="playlist"?b=(await e.getPlaylist(k)).playlist:y==="mix"&&(b=(await e.getMix(k)).mix)}catch(T){console.error(T)}}b&&await me(I,b,n,e,a,y,i,r);return}const f=u.target.closest(".track-menu-btn");if(f){u.stopPropagation();const w=f.closest(".track-item");if(w&&!w.dataset.queueIndex){const I=H.get(w);if(I&&I.isLocal)return;if(s.style.display==="block"&&d&&I&&d.id===I.id){s.style.display="none";return}if(d=I,d){await St(s,d);const y=f.getBoundingClientRect();It(s,y.left,y.bottom+5,y)}}return}const g=u.target.closest(".track-item");if(g&&!g.dataset.queueIndex&&!u.target.closest(".remove-from-playlist-btn")){const w=g.closest(".track-list"),y=Array.from(w.querySelectorAll(".track-item")).map(b=>H.get(b)).filter(Boolean);if(y.length>0){const b=g.dataset.trackId,k=y.findIndex(T=>T.id==b);n.setQueue(y,k),document.getElementById("shuffle-btn").classList.remove("active"),n.playTrackFromQueue()}}const p=u.target.closest(".card");if(p){if(u.target.closest(".edit-playlist-btn")||u.target.closest(".delete-playlist-btn"))return;const w=p.dataset.href;if(w){if(u.target.closest("a"))return;u.preventDefault(),window.location.hash=w}}}),t.addEventListener("contextmenu",async u=>{const h=u.target.closest(".track-item, .queue-track-item");if(h){if(u.preventDefault(),h.classList.contains("queue-track-item")){const f=parseInt(h.dataset.queueIndex);d=n.getCurrentQueue()[f]}else d=H.get(h);if(d){if(d.isLocal)return;await St(s,d),It(s,u.pageX,u.pageY)}}}),document.addEventListener("click",()=>{s.style.display="none"}),s.addEventListener("click",async u=>{u.stopPropagation();const h=u.target.dataset.action,f=s._contextTrack||d;h&&f&&await me(h,f,n,e,a,"track",i,r),s.style.display="none"}),document.querySelector(".now-playing-bar .title").addEventListener("click",()=>{const u=n.currentTrack;u?.album?.id&&(window.location.hash=`#album/${u.album.id}`)}),document.querySelector(".now-playing-bar .artist").addEventListener("click",u=>{const h=u.target.closest(".artist-link");if(h){u.stopPropagation();const g=h.dataset.artistId;g&&(window.location.hash=`#artist/${g}`);return}const f=n.currentTrack;f?.artist?.id&&(window.location.hash=`#artist/${f.artist.id}`)});const l=document.getElementById("now-playing-like-btn");l&&l.addEventListener("click",async u=>{u.stopPropagation(),n.currentTrack&&await me("toggle-like",n.currentTrack,n,e,a,"track",i,r)});const o=document.getElementById("now-playing-mix-btn");o&&o.addEventListener("click",async u=>{u.stopPropagation(),n.currentTrack&&await me("track-mix",n.currentTrack,n,e,a,"track",i,r)});const c=document.getElementById("now-playing-add-playlist-btn");c&&c.addEventListener("click",async u=>{u.stopPropagation(),n.currentTrack&&await me("add-to-playlist",n.currentTrack,n,e,a,"track",i,r)});const m=document.getElementById("mobile-add-playlist-btn");m&&m.addEventListener("click",async u=>{u.stopPropagation(),n.currentTrack&&await me("add-to-playlist",n.currentTrack,n,e,a,"track",i,r)})}function Lt(n){const e=document.getElementById("sleep-timer-modal");if(!e)return;const t=()=>{e.classList.remove("active"),i()},s=r=>{const d=r.target.closest(".timer-option");if(d){let l;if(d.id==="custom-timer-btn"){const o=document.getElementById("custom-minutes");if(l=parseInt(o.value),!l||l<1){W("Please enter a valid number of minutes");return}}else l=parseInt(d.dataset.minutes);l&&(n.setSleepTimer(l),W(`Sleep timer set for ${l} minute${l===1?"":"s"}`),t())}},a=r=>{(r.target.id==="cancel-sleep-timer"||r.target.classList.contains("modal-overlay"))&&t()},i=()=>{e.removeEventListener("click",s),e.removeEventListener("click",a)};e.addEventListener("click",s),e.addEventListener("click",a),e.classList.add("active")}function It(n,e,t,s=null){n.style.visibility="hidden",n.style.display="block";const a=n.offsetWidth,i=n.offsetHeight,r=window.innerWidth,d=window.innerHeight;let l=e,o=t;s?(l+a>r-10&&(l=s.right-a,l<10&&(l=10)),o+i>d-10&&(o=s.top-i-5)):(l+a>r-10&&(l=r-a-10),o+i>d-10&&(o=t-i)),n.style.top=`${o}px`,n.style.left=`${l}px`,n.style.visibility="visible"}function un(n,e){const t=document.querySelector(".sidebar"),s=document.getElementById("sidebar-overlay"),a=document.getElementById("hamburger-btn"),i=document.getElementById("queue-btn");let r=null;a.addEventListener("click",()=>{t.classList.add("is-open"),s.classList.add("is-visible")});const d=()=>{t.classList.remove("is-open"),s.classList.remove("is-visible")};s.addEventListener("click",d),t.addEventListener("click",u=>{u.target.closest("a")&&d()});const l=u=>{const h=n.getCurrentQueue(),f=h.length>0;u.innerHTML=`
            <button id="download-queue-btn" class="btn-icon" title="Download Queue" style="display: ${f?"flex":"none"}">
                ${pe}
            </button>
            <button id="like-queue-btn" class="btn-icon" title="Add Queue to Liked" style="display: ${f?"flex":"none"}">
                ${ie}
            </button>
            <button id="add-queue-to-playlist-btn" class="btn-icon" title="Add Queue to Playlist" style="display: ${f?"flex":"none"}">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
            </button>
            <button id="clear-queue-btn" class="btn-icon" title="Clear Queue" style="display: ${f?"flex":"none"}">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
            </button>
            <button id="close-side-panel-btn" class="btn-icon" title="Close">
                ${_e}
            </button>
        `,u.querySelector("#close-side-panel-btn").addEventListener("click",()=>{j.close()});const g=u.querySelector("#download-queue-btn");g&&g.addEventListener("click",async()=>{const{downloadTracks:y}=await Q(async()=>{const{downloadTracks:b}=await Promise.resolve().then(()=>Oe);return{downloadTracks:b}},void 0,import.meta.url);y(h,e,ce.getQuality())});const p=u.querySelector("#like-queue-btn");p&&p.addEventListener("click",async()=>{const{db:y}=await Q(async()=>{const{db:v}=await Promise.resolve().then(()=>be);return{db:v}},void 0,import.meta.url),{syncManager:b}=await Q(async()=>{const{syncManager:v}=await Promise.resolve().then(()=>st);return{syncManager:v}},void 0,import.meta.url),{showNotification:k}=await Q(async()=>{const{showNotification:v}=await Promise.resolve().then(()=>Oe);return{showNotification:v}},void 0,import.meta.url);let T=0;for(const v of h)await y.toggleFavorite("track",v)&&(b.syncLibraryItem("track",v,!0),T++);T>0?k(`Added ${T} track${T>1?"s":""} to Liked`):k("All tracks in queue are already liked"),c()});const w=u.querySelector("#add-queue-to-playlist-btn");w&&w.addEventListener("click",async()=>{const{db:y}=await Q(async()=>{const{db:L}=await Promise.resolve().then(()=>be);return{db:L}},void 0,import.meta.url),{syncManager:b}=await Q(async()=>{const{syncManager:L}=await Promise.resolve().then(()=>st);return{syncManager:L}},void 0,import.meta.url),{showNotification:k}=await Q(async()=>{const{showNotification:L}=await Promise.resolve().then(()=>Oe);return{showNotification:L}},void 0,import.meta.url),T=await y.getPlaylists();if(T.length===0){k("No playlists yet. Create one first.");return}const v=document.createElement("div");v.className="modal active",v.innerHTML=`
                    <div class="modal-overlay"></div>
                    <div class="modal-content">
                        <h3>Add Queue to Playlist</h3>
                        <div class="modal-list">
                            ${T.map(L=>`
                                <div class="modal-option" data-id="${L.id}">${Y(L.name)}</div>
                            `).join("")}
                        </div>
                        <div class="modal-actions">
                            <button class="btn-secondary cancel-btn">Cancel</button>
                        </div>
                    </div>
                `,document.body.appendChild(v);const S=()=>{v.remove()};v.addEventListener("click",async L=>{if(L.target.classList.contains("modal-overlay")||L.target.classList.contains("cancel-btn")){S();return}const A=L.target.closest(".modal-option");if(A){const C=A.dataset.id,x=A.textContent;try{let B=0;for(const $ of h){const R=await y.addTrackToPlaylist(C,$);B++}const P=await y.getPlaylist(C);b.syncUserPlaylist(P,"update"),k(`Added ${B} tracks to playlist: ${x}`)}catch(B){console.error("Failed to add tracks to playlist:",B),k("Failed to add tracks to playlist")}S()}})});const I=u.querySelector("#clear-queue-btn");I&&I.addEventListener("click",()=>{n.clearQueue(),c()})},o=u=>{const h=n.getCurrentQueue();if(h.length===0){u.innerHTML='<div class="placeholder-text">Queue is empty.</div>';return}const f=h.map((g,p)=>{const w=p===n.currentQueueIndex,I=ne(g),y=ee(g,{fallback:"Unknown"});return`
                <div class="queue-track-item ${w?"playing":""}" data-queue-index="${p}" data-track-id="${g.id}" draggable="true">
                    <div class="drag-handle">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="8" x2="19" y2="8"></line>
                            <line x1="5" y1="16" x2="19" y2="16"></line>
                        </svg>
                    </div>
                    <div class="track-item-info">
                        <img src="${e.getCoverUrl(g.album?.cover)}"
                             class="track-item-cover" loading="lazy">
                        <div class="track-item-details">
                            <div class="title">${Y(I)}</div>
                            <div class="artist">${Y(y)}</div>
                        </div>
                    </div>
                    <div class="track-item-duration">${xe(g.duration)}</div>
                    <button class="queue-like-btn" data-action="toggle-like" title="Add to Liked">
                        ${ie}
                    </button>
                    <button class="queue-remove-btn" data-track-index="${p}" title="Remove from queue">
                        ${ms}
                    </button>
                </div>
            `}).join("");u.innerHTML=f,u.querySelectorAll(".queue-track-item").forEach(async g=>{const p=parseInt(g.dataset.queueIndex),w=n.getCurrentQueue()[p],I=g.querySelector(".queue-like-btn");if(I&&w){const{db:y}=await Q(async()=>{const{db:k}=await Promise.resolve().then(()=>be);return{db:k}},void 0,import.meta.url),b=await y.isFavorite("track",w.id);I.classList.toggle("active",b),I.innerHTML=b?ie.replace('class="heart-icon"','class="heart-icon filled"'):ie}g.addEventListener("click",async y=>{if(y.target.closest(".queue-remove-btn")){y.stopPropagation(),n.removeFromQueue(p),c();return}const k=y.target.closest(".queue-like-btn");if(k&&k.dataset.action==="toggle-like"){y.stopPropagation();const T=n.getCurrentQueue()[p];if(T){const{db:v}=await Q(async()=>{const{db:C}=await Promise.resolve().then(()=>be);return{db:C}},void 0,import.meta.url),{syncManager:S}=await Q(async()=>{const{syncManager:C}=await Promise.resolve().then(()=>st);return{syncManager:C}},void 0,import.meta.url),{showNotification:L}=await Q(async()=>{const{showNotification:C}=await Promise.resolve().then(()=>Oe);return{showNotification:C}},void 0,import.meta.url),A=await v.toggleFavorite("track",T);S.syncLibraryItem("track",T,A),k.classList.toggle("active",A),k.innerHTML=A?ie.replace('class="heart-icon"','class="heart-icon filled"'):ie,L(A?`Added to Liked: ${T.title}`:`Removed from Liked: ${T.title}`)}return}n.playAtIndex(p),c()}),g.addEventListener("contextmenu",async y=>{y.preventDefault();const b=document.getElementById("context-menu");if(b){const k=n.getCurrentQueue()[p];if(k){const{db:T}=await Q(async()=>{const{db:P}=await Promise.resolve().then(()=>be);return{db:P}},void 0,import.meta.url),v=await T.isFavorite("track",k.id),S=b.querySelector('li[data-action="toggle-like"]');S&&(S.textContent=v?"Unlike":"Like");const L=b.querySelector('li[data-action="track-mix"]');if(L){const P=k.mixes&&k.mixes.TRACK_MIX;L.style.display=P?"block":"none"}g.getBoundingClientRect();const A=150,C=200;let x=y.clientX,B=y.clientY;x+A>window.innerWidth&&(x=window.innerWidth-A-10),B+C>window.innerHeight&&(B=y.clientY-C-10),b.style.left=`${x}px`,b.style.top=`${B}px`,b.style.display="block",b._contextTrack=k}}}),g.addEventListener("dragstart",y=>{r=p,g.style.opacity="0.5"}),g.addEventListener("dragend",()=>{g.style.opacity="1"}),g.addEventListener("dragover",y=>{y.preventDefault()}),g.addEventListener("drop",y=>{y.preventDefault(),r!==null&&r!==p&&(n.moveInQueue(r,p),c())})})},c=()=>{j.refresh("queue",l,o)},m=()=>{j.open("queue","Queue",l,o)};i.addEventListener("click",m),window.renderQueueFunction=()=>{j.isActive("queue")&&c()},document.querySelectorAll(".search-tab").forEach(u=>{u.addEventListener("click",()=>{const h=u.closest(".page");if(!h)return;h.querySelectorAll(".search-tab").forEach(p=>p.classList.remove("active")),h.querySelectorAll(".search-tab-content").forEach(p=>p.classList.remove("active")),u.classList.add("active");const g=`${h.id==="page-library"?"library-tab-":"search-tab-"}${u.dataset.tab}`;document.getElementById(g)?.classList.add("active")})})}function mn(n={}){const{immediate:e=!1,onNeedRefresh:t,onOfflineReady:s,onRegistered:a,onRegisteredSW:i,onRegisterError:r}=n;let d,l,o;const c=async(u=!0)=>{await l,o?.()};async function m(){if("serviceWorker"in navigator){if(d=await Q(async()=>{const{Workbox:u}=await import("./workbox-window.prod.es5-BIl4cyR9.js");return{Workbox:u}},[],import.meta.url).then(({Workbox:u})=>new u("./sw.js",{scope:"./",type:"classic"})).catch(u=>{r?.(u)}),!d)return;o=()=>{d?.messageSkipWaiting()};{let u=!1;const h=()=>{u=!0,d?.addEventListener("controlling",f=>{f.isUpdate&&window.location.reload()}),t?.()};d.addEventListener("installed",f=>{typeof f.isUpdate>"u"?typeof f.isExternal<"u"&&f.isExternal?h():!u&&s?.():f.isUpdate||s?.()}),d.addEventListener("waiting",h)}d.register({immediate:e}).then(u=>{i?i("./sw.js",u):a?.(u)}).catch(u=>{r?.(u)})}}return l=m(),c}let ke=null;function At(){if(ke)return;ke=new Lenis({wrapper:document.querySelector(".main-content"),content:document.querySelector(".main-content"),lerp:.1,smoothWheel:!0,smoothTouch:!1,normalizeWheel:!0,wheelMultiplier:.8});function n(e){ke.raf(e),requestAnimationFrame(n)}requestAnimationFrame(n)}function hn(){ke&&(ke.destroy(),ke=null)}function xt(){ot.isEnabled()&&At(),window.addEventListener("smooth-scrolling-toggle",function(e){e.detail.enabled?At():hn()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",xt):xt();function fn(n,e){e&&("remote"in n?(n.remote.watchAvailability(t=>{t&&(e.style.display="flex",e.classList.add("available"))}).catch(t=>{console.log("Remote playback not available:",t),window.innerWidth>768&&(e.style.display="flex")}),e.addEventListener("click",()=>{if(!n.src){alert("Please play a track first to enable casting.");return}n.remote.prompt().catch(t=>{if(t.name!=="NotAllowedError"){if(t.name==="NotFoundError"){alert("No remote playback devices (Chromecast/AirPlay) were found on your network.");return}console.log("Cast prompt error:",t)}})}),n.addEventListener("playing",()=>{n.remote&&n.remote.state==="connected"&&e.classList.add("connected")}),n.addEventListener("pause",()=>{n.remote&&n.remote.state==="disconnected"&&e.classList.remove("connected")})):n.webkitShowPlaybackTargetPicker?(e.style.display="flex",e.classList.add("available"),e.addEventListener("click",()=>{n.webkitShowPlaybackTargetPicker()}),n.addEventListener("webkitplaybacktargetavailabilitychanged",t=>{t.availability==="available"&&e.classList.add("available")}),n.addEventListener("webkitcurrentplaybacktargetiswirelesschanged",()=>{n.webkitCurrentPlaybackTargetIsWireless?e.classList.add("connected"):e.classList.remove("connected")})):window.innerWidth>768&&(e.style.display="flex",e.addEventListener("click",()=>{alert("Casting is not supported in this browser. Try Chrome for Chromecast or Safari for AirPlay.")})))}function gn(n,e){document.addEventListener("keydown",t=>{if(!t.target.matches("input, textarea"))switch(t.key.toLowerCase()){case" ":t.preventDefault(),n.handlePlayPause();break;case"arrowright":t.shiftKey?n.playNext():e.currentTime=Math.min(e.duration,e.currentTime+10);break;case"arrowleft":t.shiftKey?n.playPrev():e.currentTime=Math.max(0,e.currentTime-10);break;case"arrowup":t.preventDefault(),n.setVolume(n.userVolume+.1);break;case"arrowdown":t.preventDefault(),n.setVolume(n.userVolume-.1);break;case"m":e.muted=!e.muted;break;case"s":document.getElementById("shuffle-btn")?.click();break;case"r":document.getElementById("repeat-btn")?.click();break;case"q":document.getElementById("queue-btn")?.click();break;case"/":t.preventDefault(),document.getElementById("search-input")?.focus();break;case"escape":document.getElementById("search-input")?.blur(),j.close(),Me(e,j.panel);break;case"l":document.querySelector(".now-playing-bar .cover")?.click();break}})}function pn(){const n=document.createElement("div");n.className="offline-notification",n.innerHTML=`
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        <span>You are offline. Some features may not work.</span>
    `,document.body.appendChild(n),setTimeout(()=>{n.style.animation="slideOut 0.3s ease forwards",setTimeout(()=>n.remove(),300)},5e3)}function yn(){const n=document.querySelector(".offline-notification");n&&(n.style.animation="slideOut 0.3s ease forwards",setTimeout(()=>n.remove(),300))}document.addEventListener("DOMContentLoaded",async()=>{const n=new Ds(Fs),e=document.getElementById("audio-player"),t=localStorage.getItem("playback-quality")||"LOSSLESS",s=new Ys(e,n,t),a=new Gs(n,s),i=new Zs,r=new Ht(n);r.loadKuroshiro().catch(y=>{console.warn("Failed to pre-load Kuroshiro:",y)});const d=oe.getTheme();oe.setTheme(d),it.getMode(),sn(i,s,n,a),ln(s,e,i,a),dn(s,n,document.querySelector(".main-content"),document.getElementById("context-menu"),r,a,i),un(s,n),gn(s,e);const l=document.getElementById("cast-btn");fn(e,l),s.currentTrack&&a.setCurrentTrack(s.currentTrack),document.querySelector(".now-playing-bar .cover").addEventListener("click",async()=>{if(!s.currentTrack){alert("No track is currently playing");return}const y=at.getMode();if(y==="lyrics")j.isActive("lyrics")?(j.close(),Me(e,j.panel)):je(s.currentTrack,e,r);else if(y==="cover"){const b=document.getElementById("fullscreen-cover-overlay");if(b&&b.style.display==="flex")a.closeFullscreenCover();else{const k=s.getNextTrack();a.showFullscreenCover(s.currentTrack,k,r,e)}}else s.currentTrack.album?.id&&(window.location.hash=`#album/${s.currentTrack.album.id}`)}),document.getElementById("playlist-public-toggle")?.addEventListener("change",y=>{const b=document.getElementById("playlist-share-btn");b&&(b.style.display=y.target.checked?"flex":"none")}),document.getElementById("close-fullscreen-cover-btn")?.addEventListener("click",()=>{a.closeFullscreenCover()}),document.getElementById("fullscreen-cover-image")?.addEventListener("click",()=>{a.closeFullscreenCover()}),document.getElementById("nav-back")?.addEventListener("click",()=>{window.history.back()}),document.getElementById("nav-forward")?.addEventListener("click",()=>{window.history.forward()}),document.getElementById("toggle-lyrics-btn")?.addEventListener("click",async y=>{if(y.stopPropagation(),!s.currentTrack){alert("No track is currently playing");return}j.isActive("lyrics")?(j.close(),Me(e,j.panel)):je(s.currentTrack,e,r)}),document.getElementById("download-current-btn")?.addEventListener("click",()=>{s.currentTrack&&me("download",s.currentTrack,s,n,r,"track",a)});let o=null;e.addEventListener("play",async()=>{if(!s.currentTrack)return;a.setCurrentTrack(s.currentTrack);const y=s.currentTrack.id;if(y===o)return;o=y,j.isActive("lyrics")&&je(s.currentTrack,e,r);const b=document.getElementById("fullscreen-cover-overlay");if(b&&getComputedStyle(b).display!=="none"){const k=s.getNextTrack();a.showFullscreenCover(s.currentTrack,k,r,e)}}),document.addEventListener("click",async y=>{if(y.target.closest("#play-album-btn")){if(y.target.closest("#play-album-btn").disabled)return;const k=window.location.hash.split("/")[1];if(!k)return;try{const{tracks:T}=await n.getAlbum(k);T.length>0&&(s.setQueue(T,0),document.getElementById("shuffle-btn").classList.remove("active"),s.playTrackFromQueue())}catch(T){console.error("Failed to play album:",T),alert("Failed to play album: "+T.message)}}if(y.target.closest("#download-mix-btn")){const b=y.target.closest("#download-mix-btn");if(b.disabled)return;const k=window.location.hash.split("#mix/")[1];if(!k)return;b.disabled=!0;const T=b.innerHTML;b.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Downloading...</span>';try{const{mix:v,tracks:S}=await n.getMix(k);await ct(v,S,n,ce.getQuality(),r)}catch(v){console.error("Mix download failed:",v),alert("Failed to download mix: "+v.message)}finally{b.disabled=!1,b.innerHTML=T}}if(y.target.closest("#download-playlist-btn")){const b=y.target.closest("#download-playlist-btn");if(b.disabled)return;const k=window.location.hash.split("/")[1];if(!k)return;b.disabled=!0;const T=b.innerHTML;b.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Downloading...</span>';try{let v,S,L=await M.getPlaylist(k);if(!L)try{L=await U.getPublicPlaylist(k)}catch{}if(L)v={...L,title:L.name||L.title},S=L.tracks||[];else{const A=await n.getPlaylist(k);v=A.playlist,S=A.tracks}await ct(v,S,n,ce.getQuality(),r)}catch(v){console.error("Playlist download failed:",v),alert("Failed to download playlist: "+v.message)}finally{b.disabled=!1,b.innerHTML=T}}if(y.target.closest("#create-playlist-btn")){const b=document.getElementById("playlist-modal");document.getElementById("playlist-modal-title").textContent="Create Playlist",document.getElementById("playlist-name-input").value="",document.getElementById("playlist-cover-input").value="",b.dataset.editingId="",document.getElementById("csv-import-section").style.display="block",document.getElementById("csv-file-input").value="";const k=document.getElementById("playlist-public-toggle"),T=document.getElementById("playlist-share-btn");k&&(k.checked=!1),T&&(T.style.display="none"),b.classList.add("active"),document.getElementById("playlist-name-input").focus()}if(y.target.closest("#playlist-modal-save")){const b=document.getElementById("playlist-name-input").value.trim(),k=document.getElementById("playlist-public-toggle")?.checked;if(b){const T=document.getElementById("playlist-modal"),v=T.dataset.editingId,S=async L=>{if(L.isPublic=k,k)try{await U.publishPlaylist(L)}catch(A){console.error("Failed to publish playlist:",A),alert("Failed to publish playlist. Please ensure you are logged in.")}else try{await U.unpublishPlaylist(L.id)}catch{}return L};if(v){const L=document.getElementById("playlist-cover-input").value.trim();M.getPlaylist(v).then(async A=>{A&&(A.name=b,A.cover=L,await S(A),await M.performTransaction("user_playlists","readwrite",C=>C.put(A)),U.syncUserPlaylist(A,"update"),a.renderLibraryPage(),window.location.hash===`#userplaylist/${v}`&&a.renderPlaylistPage(v,"user"),T.classList.remove("active"),delete T.dataset.editingId)})}else{const L=document.getElementById("csv-file-input");let A=[];if(L.files.length>0){const x=L.files[0],B=document.getElementById("csv-import-progress"),P=document.getElementById("csv-progress-fill"),$=document.getElementById("csv-progress-current"),R=document.getElementById("csv-progress-total"),O=B.querySelector(".current-track"),z=B.querySelector(".current-artist");try{B.style.display="block",P.style.width="0%",$.textContent="0",O.textContent="Reading CSV file...",z&&(z.textContent="");const G=await x.text(),te=G.trim().split(`
`),q=Math.max(0,te.length-1);R.textContent=q.toString();const E=await kn(G,n,D=>{const F=q>0?D.current/q*100:0;P.style.width=`${Math.min(F,100)}%`,$.textContent=D.current.toString(),O.textContent=D.currentTrack,z&&(z.textContent=D.currentArtist||"")});A=E.tracks;const _=E.missingTracks;if(A.length===0){alert("No valid tracks found in the CSV file! Please check the format."),B.style.display="none";return}console.log(`Imported ${A.length} tracks from CSV`),_.length>0&&setTimeout(()=>{vn(_)},500)}catch(G){console.error("Failed to parse CSV!",G),alert("Failed to parse CSV file! "+G.message),B.style.display="none";return}finally{setTimeout(()=>{B.style.display="none"},1e3)}}const C=document.getElementById("playlist-cover-input").value.trim();M.createPlaylist(b,A,C).then(async x=>{await S(x),await M.performTransaction("user_playlists","readwrite",B=>B.put(x)),U.syncUserPlaylist(x,"create"),a.renderLibraryPage(),T.classList.remove("active")})}}}if(y.target.closest("#playlist-modal-cancel")&&document.getElementById("playlist-modal").classList.remove("active"),y.target.closest(".edit-playlist-btn")){const k=y.target.closest(".user-playlist").dataset.userPlaylistId;M.getPlaylist(k).then(async T=>{if(T){const v=document.getElementById("playlist-modal");document.getElementById("playlist-modal-title").textContent="Edit Playlist",document.getElementById("playlist-name-input").value=T.name,document.getElementById("playlist-cover-input").value=T.cover||"";const S=document.getElementById("playlist-public-toggle"),L=document.getElementById("playlist-share-btn");S&&(S.checked=!!T.isPublic),L&&(L.style.display=T.isPublic?"flex":"none",L.onclick=()=>{const A=`${window.location.origin}${window.location.pathname}#userplaylist/${T.id}`;navigator.clipboard.writeText(A).then(()=>alert("Link copied to clipboard!"))}),v.dataset.editingId=k,document.getElementById("csv-import-section").style.display="none",v.classList.add("active"),document.getElementById("playlist-name-input").focus()}})}if(y.target.closest(".delete-playlist-btn")){const k=y.target.closest(".user-playlist").dataset.userPlaylistId;confirm("Are you sure you want to delete this playlist?")&&M.deletePlaylist(k).then(()=>{U.syncUserPlaylist({id:k},"delete"),a.renderLibraryPage()})}if(y.target.closest("#edit-playlist-btn")){const b=window.location.hash.split("/")[1];M.getPlaylist(b).then(k=>{if(k){const T=document.getElementById("playlist-modal");document.getElementById("playlist-modal-title").textContent="Edit Playlist",document.getElementById("playlist-name-input").value=k.name,document.getElementById("playlist-cover-input").value=k.cover||"";const v=document.getElementById("playlist-public-toggle"),S=document.getElementById("playlist-share-btn");v&&(v.checked=!!k.isPublic),S&&(S.style.display=k.isPublic?"flex":"none",S.onclick=()=>{const L=`${window.location.origin}${window.location.pathname}#userplaylist/${k.id}`;navigator.clipboard.writeText(L).then(()=>alert("Link copied to clipboard!"))}),T.dataset.editingId=b,document.getElementById("csv-import-section").style.display="none",T.classList.add("active"),document.getElementById("playlist-name-input").focus()}})}if(y.target.closest("#delete-playlist-btn")){const b=window.location.hash.split("/")[1];confirm("Are you sure you want to delete this playlist?")&&M.deletePlaylist(b).then(()=>{U.syncUserPlaylist({id:b},"delete"),window.location.hash="#library"})}if(y.target.closest(".remove-from-playlist-btn")){y.stopPropagation();const b=y.target.closest(".remove-from-playlist-btn"),k=parseInt(b.dataset.trackIndex),T=window.location.hash.split("/")[1];M.getPlaylist(T).then(async v=>{if(v&&v.tracks[k]){const S=v.tracks[k].id,L=await M.removeTrackFromPlaylist(T,S);U.syncUserPlaylist(L,"update");const A=document.querySelector(".main-content").scrollTop;await a.renderPlaylistPage(T,"user"),document.querySelector(".main-content").scrollTop=A}})}if(y.target.closest("#play-playlist-btn")){if(y.target.closest("#play-playlist-btn").disabled)return;const k=window.location.hash.split("/")[1];if(!k)return;try{let T;const v=await M.getPlaylist(k);if(v)T=v.tracks;else try{const{tracks:S}=await n.getPlaylist(k);T=S}catch(S){const L=await U.getPublicPlaylist(k);if(L)T=L.tracks;else throw S}T.length>0&&(s.setQueue(T,0),document.getElementById("shuffle-btn").classList.remove("active"),s.playTrackFromQueue())}catch(T){console.error("Failed to play playlist:",T),alert("Failed to play playlist: "+T.message)}}if(y.target.closest("#download-album-btn")){const b=y.target.closest("#download-album-btn");if(b.disabled)return;const k=window.location.hash.split("/")[1];if(!k)return;b.disabled=!0;const T=b.innerHTML;b.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Downloading...</span>';try{const{album:v,tracks:S}=await n.getAlbum(k);await Vt(v,S,n,ce.getQuality(),r)}catch(v){console.error("Album download failed:",v),alert("Failed to download album: "+v.message)}finally{b.disabled=!1,b.innerHTML=T}}if(y.target.closest("#play-artist-radio-btn")){const b=y.target.closest("#play-artist-radio-btn");if(b.disabled)return;const k=window.location.hash.split("/")[1];if(!k)return;b.disabled=!0;const T=b.innerHTML;b.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Loading...</span>';try{const v=await n.getArtist(k),S=[...v.albums||[],...v.eps||[]];if(S.length===0)throw new Error("No albums or EPs found for this artist");const L=new Set,A=[],C=[],x=3,B=S;for(let P=0;P<B.length;P+=x)C.push(B.slice(P,P+x));for(const P of C)await Promise.all(P.map(async $=>{try{const{tracks:R}=await n.getAlbum($.id);R.forEach(O=>{L.has(O.id)||(L.add(O.id),A.push(O))})}catch(R){console.warn(`Failed to fetch tracks for album ${$.title}:`,R)}}));if(A.length>0){for(let P=A.length-1;P>0;P--){const $=Math.floor(Math.random()*(P+1));[A[P],A[$]]=[A[$],A[P]]}s.setQueue(A,0),s.playTrackFromQueue()}else throw new Error("No tracks found across all albums")}catch(v){console.error("Artist radio failed:",v),alert("Failed to start artist radio: "+v.message)}finally{document.body.contains(b)&&(b.disabled=!1,b.innerHTML=T)}}if(y.target.closest("#download-discography-btn")){const b=y.target.closest("#download-discography-btn");if(b.disabled)return;const k=window.location.hash.split("/")[1];if(!k)return;try{const T=await n.getArtist(k);Tn(T,n,ce.getQuality(),r,b)}catch(T){console.error("Failed to load artist for discography download:",T),alert("Failed to load artist: "+T.message)}}if(y.target.closest("#select-local-folder-btn")||y.target.closest("#change-local-folder-btn"))try{const b=await window.showDirectoryPicker({id:"music-folder",mode:"read"});await M.saveSetting("local_folder_handle",b);const k=document.getElementById("select-local-folder-btn"),T=document.getElementById("select-local-folder-text");k&&(T?T.textContent="Scanning...":k.textContent="Scanning...",k.disabled=!0);const v=[];let S=0;async function L(A){for await(const C of A.values())if(C.kind==="file"){const x=C.name.toLowerCase();if(x.endsWith(".flac")||x.endsWith(".mp3")||x.endsWith(".m4a")||x.endsWith(".wav")||x.endsWith(".ogg")){const B=await C.getFile(),P=await vs(B);P.id=`local-${S++}-${B.name}`,v.push(P)}}else C.kind==="directory"&&await L(C)}await L(b),v.sort((A,C)=>{const x=A.artist.name||"",B=C.artist.name||"";return x.localeCompare(B)}),window.localFilesCache=v,a.renderLibraryPage()}catch(b){b.name!=="AbortError"&&(console.error("Error selecting folder:",b),alert("Failed to access folder. Please try again."));const k=document.getElementById("select-local-folder-btn"),T=document.getElementById("select-local-folder-text");k&&(T?T.textContent="Select Music Folder":k.textContent="Select Music Folder",k.disabled=!1)}});const c=document.getElementById("search-form"),m=document.getElementById("search-input"),u=gs(y=>{y&&(window.location.hash=`#search/${encodeURIComponent(y)}`)},300);m.addEventListener("input",y=>{const b=y.target.value.trim();b.length>2&&u(b)}),c.addEventListener("submit",y=>{y.preventDefault();const b=m.value.trim();b&&(window.location.hash=`#search/${encodeURIComponent(b)}`)}),window.addEventListener("online",()=>{yn(),console.log("Back online")}),window.addEventListener("offline",()=>{pn(),console.log("Gone offline")}),document.querySelector(".play-pause-btn").innerHTML=he;const h=en(a);h(),window.addEventListener("hashchange",h);const f=[window.location.hash];let g=0;const p=()=>{const y=document.getElementById("nav-back"),b=document.getElementById("nav-forward");y&&(y.disabled=g<=0),b&&(b.disabled=g>=f.length-1)};window.addEventListener("hashchange",()=>{const y=window.location.hash;y!==f[g]&&(g>0&&y===f[g-1]?g--:g<f.length-1&&y===f[g+1]?g++:(g++,f.splice(g),f.push(y)),p())}),p(),e.addEventListener("play",()=>{Qt(s)});const w=mn({onNeedRefresh(){bn(()=>w(!0))},onOfflineReady(){console.log("App ready to work offline")}});let I;window.addEventListener("beforeinstallprompt",y=>{y.preventDefault(),I=y,localStorage.getItem("installPromptDismissed")||wn(I)}),document.getElementById("show-shortcuts-btn")?.addEventListener("click",()=>{Ct()}),!localStorage.getItem("shortcuts-shown")&&window.innerWidth>768&&setTimeout(()=>{Ct(),localStorage.setItem("shortcuts-shown","true")},3e3),window.addEventListener("library-changed",()=>{const y=window.location.hash;if(y==="#library")a.renderLibraryPage();else if(y==="#home"||y==="")a.renderHomePage();else if(y.startsWith("#userplaylist/")){const b=y.split("/")[1],k=document.querySelector(".main-content"),T=k?k.scrollTop:0;a.renderPlaylistPage(b,"user").then(()=>{k&&(k.scrollTop=T)})}}),window.addEventListener("history-changed",()=>{window.location.hash==="#recent"&&a.renderRecentPage()})});function bn(n){const e=document.createElement("div");e.className="update-notification",e.innerHTML=`
        <div>
            <strong>Update Available</strong>
            <p>A new version of Hyamu is available.</p>
        </div>
        <button class="btn-secondary" id="update-now-btn">Update Now</button>
    `,document.body.appendChild(e),document.getElementById("update-now-btn").addEventListener("click",()=>{typeof n=="function"?n():n&&n.postMessage?n.postMessage({action:"skipWaiting"}):window.location.reload()})}function wn(n){if(!n)return;const e=document.createElement("div");e.className="install-prompt",e.innerHTML=`
        <div>
            <strong>Install Hyamu</strong>
            <p>Install this app for a better experience.</p>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn-secondary" id="install-btn">Install</button>
            <button class="btn-secondary" id="dismiss-install">Dismiss</button>
        </div>
    `,document.body.appendChild(e),document.getElementById("install-btn").addEventListener("click",async()=>{e.remove(),n.prompt();const{outcome:t}=await n.userChoice;console.log(`User response to install prompt: ${t}`),n=null}),document.getElementById("dismiss-install").addEventListener("click",()=>{e.remove(),localStorage.setItem("installPromptDismissed","true")})}function vn(n){const e=document.getElementById("missing-tracks-modal"),t=document.getElementById("missing-tracks-list-ul");t.innerHTML=n.map(i=>`<li>${i}</li>`).join("");const s=()=>e.classList.remove("active"),a=i=>{(i.target===e||i.target.closest(".close-missing-tracks")||i.target.id==="close-missing-tracks-btn"||i.target.classList.contains("modal-overlay"))&&(s(),e.removeEventListener("click",a))};e.addEventListener("click",a),e.classList.add("active")}async function kn(n,e,t){const s=n.trim().split(`
`);if(s.length<2)return[];const a=c=>{const m=[];let u="",h=!1;for(let f=0;f<c.length;f++){const g=c[f];g==='"'?h=!h:g===","&&!h?(m.push(u),u=""):u+=g}return m.push(u),m.map(f=>f.trim().replace(/^"|"$/g,"").replace(/""/g,'"').trim())},i=a(s[0]),r=s.slice(1),d=[],l=[],o=r.length;for(let c=0;c<r.length;c++){const m=r[c];if(!m.trim())continue;const u=a(m);if(u.length>=i.length){let h="",f="",g="";if(i.forEach((p,w)=>{const I=u[w];if(I)switch(p.toLowerCase()){case"track name":case"title":case"song":h=I;break;case"artist name(s)":case"artist name":case"artist":case"artists":f=I;break;case"album":case"album name":g=I;break}}),t&&t({current:c,total:o,currentTrack:h||"Unknown track",currentArtist:f||""}),h&&f){await new Promise(p=>setTimeout(p,300));try{let p=null;const w=T=>T.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim(),I=(T,v,S,L)=>{if(!T)return!1;const A=w(T.title||""),C=(T.artists||[]).map(z=>w(z.name||"")).join(" "),x=w(T.album?.name||""),B=w(v),P=w(S),$=w(L||"");return!(A===B||A.includes(B)||B.includes(A))||!(C.includes(P.split(" ")[0])||P.includes(C.split(" ")[0]))?!1:$?x===$||x.includes($)||$.includes(x):!0};if(!p){let T=`${h} ${f}`;g&&(T+=` ${g}`);const v=await e.searchTracks(T);if(v.items&&v.items.length>0){for(const S of v.items)if(I(S,h,f,g)){p=S;break}if(!p&&g){const S=v.items[0];I(S,h,f,g)&&(p=S)}}}if(!p&&f){const T=f.split(",")[0].trim();if(T&&T!==f){let v=`${h} ${T}`;g&&(v+=` ${g}`);const S=await e.searchTracks(v);if(S.items&&S.items.length>0){for(const L of S.items)if(I(L,h,T,g)){p=L,console.log(`Found (Retry 1 - Main Artist): ${h}`);break}}}}if(!p&&g){const T=`${h} ${g}`,v=await e.searchTracks(T);if(v.items&&v.items.length>0){for(const S of v.items)if(I(S,h,f,g)){p=S,console.log(`Found (Retry 2 - Album): ${h}`);break}}}const b=(T=>T.split(" - ")[0].replace(/\s*[\(\[]feat\.?.*?[\)\]]/i,"").trim())(h),k=b!==h;if(!p&&k){const T=(f||"").split(",")[0].trim();if(b){let v=`${b} ${T}`;g&&(v+=` ${g}`);const S=await e.searchTracks(v);if(S.items&&S.items.length>0){for(const L of S.items)if(I(L,b,T,g)){p=L,console.log(`Found (Retry 3 - Cleaned Title): ${h}`);break}}}}if(!p){const T=(f||"").split(",")[0].trim(),v=`${h} ${T}`,S=await e.searchTracks(v);if(S.items&&S.items.length>0){for(const L of S.items)if(I(L,h,T,null)){p=L,console.log(`Found (Retry 4 - Ignore Album): ${h}`);break}}}if(!p&&k){const T=(f||"").split(",")[0].trim(),v=`${b} ${T}`,S=await e.searchTracks(v);if(S.items&&S.items.length>0){for(const L of S.items)if(I(L,b,T,null)){p=L,console.log(`Found (Retry 5 - Cleaned Title + Ignore Album): ${h}`);break}}}p?(d.push(p),console.log(`✓ "${h}" by ${f}${g?" ["+g+"]":""}`)):(console.warn(`✗ Track not found: "${h}" by ${f}${g?" ["+g+"]":""}`),l.push(`${h} - ${f}${g?" (album: "+g+")":""}`))}catch(p){console.error(`Error searching for track "${h}":`,p),l.push(`${h} - ${f}${g?" (album: "+g+")":""}`)}}}}return t&&t({current:o,total:o,currentTrack:"Import complete"}),{tracks:d,missingTracks:l}}function Tn(n,e,t,s,a){const i=document.getElementById("discography-download-modal");document.getElementById("discography-artist-name").textContent=n.name,document.getElementById("albums-count").textContent=n.albums?.length||0,document.getElementById("eps-count").textContent=(n.eps||[]).filter(l=>l.type==="EP").length,document.getElementById("singles-count").textContent=(n.eps||[]).filter(l=>l.type==="SINGLE").length,document.getElementById("download-albums").checked=!0,document.getElementById("download-eps").checked=!0,document.getElementById("download-singles").checked=!0;const r=()=>{i.classList.remove("active")},d=l=>{(l.target===i||l.target.classList.contains("modal-overlay")||l.target.closest(".close-modal-btn")||l.target.id==="cancel-discography-download")&&r()};i.addEventListener("click",d),document.getElementById("start-discography-download").onclick=async()=>{const l=document.getElementById("download-albums").checked,o=document.getElementById("download-eps").checked,c=document.getElementById("download-singles").checked;if(!l&&!o&&!c){alert("Please select at least one type of release to download.");return}r();let m=[];l&&(m=m.concat(n.albums||[])),o&&(m=m.concat((n.eps||[]).filter(h=>h.type==="EP"))),c&&(m=m.concat((n.eps||[]).filter(h=>h.type==="SINGLE"))),a.disabled=!0;const u=a.innerHTML;a.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Downloading...</span>';try{await Gt(n,m,e,t,s)}catch(h){console.error("Discography download failed:",h),alert("Failed to download discography: "+h.message)}finally{a.disabled=!1,a.innerHTML=u}},i.classList.add("active")}function Ct(){const n=document.getElementById("shortcuts-modal"),e=()=>{n.classList.remove("active"),n.removeEventListener("click",t)},t=s=>{(s.target===n||s.target.classList.contains("close-shortcuts")||s.target.classList.contains("modal-overlay"))&&e()};n.addEventListener("click",t),n.classList.add("active")}
